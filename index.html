<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XNXL - Đăng Ký Đi Biển</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- SheetJS & Docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        .loader { border-top-color: #3498db; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f8fafc; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Table Sticky Header */
        thead th { 
            position: sticky; 
            top: 0; 
            z-index: 20; 
            background-color: #f1f5f9; /* slate-100 */
            color: #475569;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 1px 0 #e2e8f0;
        }
        
        /* Compact layout tweaks */
        .cell-content { display: flex; flex-direction: column; justify-content: center; }
        .sub-text { font-size: 0.7rem; color: #64748b; margin-top: 2px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Global Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[60] flex items-center justify-center hidden">
        <div class="flex flex-col items-center">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-blue-600 h-10 w-10 mb-3"></div>
            <p id="loadingText" class="text-slate-600 font-semibold text-sm animate-pulse">Đang xử lý...</p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 right-6 z-[70] hidden px-6 py-4 rounded-lg shadow-xl text-white font-medium transform transition-all duration-300 translate-y-0 opacity-100 flex items-center gap-3"></div>

    <!-- AUTH SCREEN -->
    <div id="authScreen" class="flex-grow flex items-center justify-center bg-gradient-to-br from-blue-50 to-slate-200">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md border border-slate-100">
            <div class="text-center mb-8">
                <div class="bg-blue-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg text-white text-2xl">
                    <i class="fas fa-anchor"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-800 tracking-tight">XNXL OFFSHORE</h1>
                <p class="text-slate-500 mt-2 text-sm">Hệ thống Điều độ & Đăng ký đi biển</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1">Email</label>
                    <input type="email" id="email" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition outline-none" placeholder="name@xnxl.com" required>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1 ml-1">Mật khẩu</label>
                    <input type="password" id="password" class="w-full border border-slate-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition outline-none" placeholder="••••••••" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transition transform active:scale-95">Đăng nhập</button>
            </form>
            <div class="mt-6 text-center text-xs text-slate-400 border-t pt-4">
                <p>Liên hệ Admin để được cấp tài khoản</p>
            </div>
        </div>
    </div>

    <!-- APP SHELL -->
    <div id="appShell" class="hidden flex-col h-full">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 shadow-sm flex-none z-30 h-14">
            <div class="container mx-auto px-4 h-full flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="bg-blue-600 text-white w-8 h-8 flex items-center justify-center rounded-lg shadow-sm">
                        <i class="fas fa-ship text-sm"></i>
                    </div>
                    <div class="flex flex-col justify-center">
                        <h1 class="text-sm font-bold text-slate-800 leading-none">ĐIỀU ĐỘ BIỂN</h1>
                        <span id="userBadge" class="text-[10px] font-semibold text-slate-500 mt-0.5"></span>
                    </div>
                </div>
                
                <div class="flex items-center">
                    <!-- Login info display -->
                    <div id="lastLoginInfo" class="hidden md:flex flex-col items-end mr-6 text-xs border-r border-slate-100 pr-6">
                        <span class="text-slate-400">Login lần cuối</span>
                        <span id="lastLoginVal" class="font-bold text-slate-700">--</span>
                    </div>

                    <div class="flex space-x-1">
                        <button onclick="app.showDashboard()" class="px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-md transition"><i class="fas fa-calendar-alt mr-2"></i>Kế hoạch</button>
                        <button id="navSettings" onclick="app.showSettings()" class="hidden px-3 py-1.5 text-sm font-medium text-slate-600 hover:text-blue-600 hover:bg-blue-50 rounded-md transition"><i class="fas fa-cogs mr-2"></i>Cấu hình</button>
                        <button onclick="app.logout()" class="px-3 py-1.5 text-sm font-medium text-red-500 hover:bg-red-50 rounded-md transition ml-1"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow overflow-hidden flex relative bg-slate-100">
            
            <!-- Dashboard View -->
            <div id="dashboardView" class="w-full h-full flex flex-col p-4 space-y-3 overflow-y-auto">
                
                <!-- Top Control Bar & Stats -->
                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4 flex-none">
                    
                    <!-- Date & Status -->
                    <div class="flex items-center gap-4 w-full md:w-auto">
                        <div class="relative">
                            <input type="date" id="planDateInput" class="border border-slate-300 rounded px-3 py-1.5 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none shadow-sm" onchange="app.loadPlan()">
                            <label class="absolute -top-2 left-2 bg-white px-1 text-[10px] font-bold text-slate-400 uppercase">Ngày</label>
                        </div>
                        <div id="planStatus" class="px-3 py-1.5 rounded text-xs font-bold bg-slate-100 text-slate-500 border border-slate-200 uppercase tracking-wider">--</div>
                    </div>

                    <!-- Stats Compact -->
                    <div class="flex flex-grow justify-center gap-6 md:gap-12 text-center border-l border-r border-slate-100 px-4">
                        <div>
                            <div class="text-[10px] text-slate-400 font-bold uppercase">Tổng</div>
                            <div class="text-xl font-bold text-slate-700 leading-none mt-0.5" id="statTotal">0</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-emerald-500 font-bold uppercase">Đi biển</div>
                            <div class="text-xl font-bold text-emerald-600 leading-none mt-0.5" id="statOffshore">0</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-orange-400 font-bold uppercase">Về bờ</div>
                            <div class="text-xl font-bold text-orange-500 leading-none mt-0.5" id="statReturn">0</div>
                        </div>
                        <div id="warningStatBox" class="opacity-30 transition-opacity duration-300">
                            <div class="text-[10px] text-red-500 font-bold uppercase">Cảnh báo</div>
                            <div class="text-xl font-bold text-red-600 leading-none mt-0.5" id="statWarnings">0</div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center gap-2">
                        <button id="btnImport" onclick="importModal.open()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center transition">
                            <i class="fas fa-file-excel mr-2"></i> Import
                        </button>
                        <button id="btnDeleteAll" onclick="app.deleteAllPeople()" class="hidden bg-white hover:bg-red-50 text-red-600 border border-red-200 px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center transition">
                            <i class="fas fa-trash-alt mr-1"></i> Xóa
                        </button>
                        <button id="btnLock" onclick="app.toggleLockPlan()" class="hidden bg-slate-700 hover:bg-slate-800 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center transition">
                            <i class="fas fa-lock"></i>
                        </button>
                         <button id="btnExport" onclick="app.clientSideExportDocx()" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center transition">
                            <i class="fas fa-file-word mr-1"></i> Xuất
                        </button>
                    </div>
                </div>

                <!-- Main Data Table -->
                <div class="flex-grow bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden flex flex-col relative">
                    <div class="overflow-auto flex-grow p-0" id="planContent">
                        <!-- Content populated by JS -->
                    </div>
                </div>
            </div>

            <!-- Settings View (Admin only) -->
            <div id="settingsView" class="w-full h-full hidden p-6 overflow-y-auto bg-slate-50">
                <div class="max-w-5xl mx-auto space-y-6">
                    <h2 class="text-2xl font-bold text-slate-800">Quản trị hệ thống</h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left Col: Orgs & Config -->
                        <div class="space-y-6 lg:col-span-1">
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-700 border-b pb-2 mb-4 text-sm uppercase">Danh mục Đơn vị</h3>
                                <ul id="orgList" class="space-y-2 mb-4 max-h-40 overflow-y-auto pr-2 custom-scrollbar"></ul>
                                <div class="flex space-x-2 mt-4">
                                    <input id="newOrgName" type="text" placeholder="Tên đơn vị..." class="border border-slate-300 p-2 rounded text-xs flex-grow focus:ring-1 focus:ring-blue-500 outline-none">
                                    <button onclick="app.addOrg()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition">Thêm</button>
                                </div>
                            </div>
                            
                            <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200">
                                <h3 class="font-bold text-slate-700 border-b pb-2 mb-4 text-sm uppercase">Cấu hình chữ ký</h3>
                                <div class="space-y-3">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Tiêu đề (Phải)</label>
                                        <input type="text" id="sigApprover" class="w-full border border-slate-300 p-2 rounded text-xs outline-none" placeholder="VD: TRƯỞNG BAN TTĐĐSX">
                                    </div>
                                     <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Họ Tên Người duyệt</label>
                                        <input type="text" id="sigApproverName" class="w-full border border-slate-300 p-2 rounded text-xs outline-none" placeholder="VD: Nguyễn Văn A">
                                    </div>
                                    <button onclick="app.saveSettings()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded w-full text-xs font-bold shadow-sm transition">Lưu Cấu Hình</button>
                                </div>
                            </div>
                        </div>

                        <!-- Right Col: User Management -->
                        <div class="lg:col-span-2">
                             <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 h-full flex flex-col">
                                <div class="flex justify-between items-center border-b pb-2 mb-4">
                                    <h3 class="font-bold text-slate-700 text-sm uppercase">Quản lý Tài khoản</h3>
                                    <button onclick="userModal.open()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-xs font-bold shadow-sm flex items-center">
                                        <i class="fas fa-user-plus mr-1"></i> Thêm User
                                    </button>
                                </div>
                                <div class="overflow-auto flex-grow">
                                    <table class="min-w-full divide-y divide-slate-200 text-xs">
                                        <thead class="bg-slate-50">
                                            <tr>
                                                <th class="px-4 py-2 text-left text-slate-600">Email</th>
                                                <th class="px-4 py-2 text-left text-slate-600">Tên hiển thị</th>
                                                <th class="px-4 py-2 text-left text-slate-600">Vai trò</th>
                                                <th class="px-4 py-2 text-left text-slate-600">Đơn vị</th>
                                                <th class="px-4 py-2 text-right text-slate-600">Hành động</th>
                                            </tr>
                                        </thead>
                                        <tbody id="userListBody" class="divide-y divide-slate-100">
                                            <!-- Dynamic Content -->
                                        </tbody>
                                    </table>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- USER MODAL -->
    <div id="userModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm flex flex-col">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-lg">
                <h3 class="font-bold text-slate-800 text-sm">Thêm User Mới</h3>
                <button onclick="userModal.close()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <input type="email" id="u_email" class="w-full border rounded p-2 text-sm" placeholder="Email đăng nhập">
                <input type="text" id="u_password" class="w-full border rounded p-2 text-sm" placeholder="Mật khẩu">
                <input type="text" id="u_name" class="w-full border rounded p-2 text-sm" placeholder="Tên hiển thị">
                <select id="u_role" class="w-full border rounded p-2 text-sm" onchange="userModal.toggleOrgSelect()">
                    <option value="workshop">User (Xưởng)</option>
                    <option value="dispatcher">Admin (Điều độ)</option>
                </select>
                <div id="u_orgWrapper">
                    <select id="u_orgId" class="w-full border rounded p-2 text-sm"></select>
                </div>
            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-2 rounded-b-lg">
                <button onclick="userModal.close()" class="px-3 py-1.5 bg-white border rounded text-xs font-medium hover:bg-slate-50">Hủy</button>
                <button onclick="userManager.createUser()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-bold">Tạo User</button>
            </div>
        </div>
    </div>

    <!-- IMPORT MODAL -->
    <div id="importModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-800 text-base"><i class="fas fa-file-excel mr-2 text-emerald-600"></i>Import Danh sách</h3>
                <button onclick="importModal.close()" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-grow space-y-5">
                <div id="importOrgSelectWrapper" class="hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Chọn Đơn vị Import</label>
                    <select id="importOrgSelect" class="block w-full border border-slate-300 rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"></select>
                </div>

                <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-blue-50 transition cursor-pointer relative group">
                    <input type="file" id="excelFile" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept=".xlsx, .xls">
                    <div class="group-hover:scale-105 transition transform duration-200">
                        <i class="fas fa-cloud-upload-alt text-4xl text-slate-300 mb-2"></i>
                        <p class="text-sm font-medium text-slate-600">Kéo thả hoặc click để chọn file Excel</p>
                    </div>
                    <p id="fileNameDisplay" class="text-blue-600 font-bold mt-4 text-xs break-all"></p>
                </div>

                <div id="parseResult" class="hidden bg-slate-50 p-4 rounded border border-slate-200 text-sm">
                    <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                        <div><span class="text-slate-500 text-xs uppercase font-bold">Ngày ĐK:</span> <span id="prevDate" class="font-semibold text-slate-800">--</span></div>
                        <div><span class="text-slate-500 text-xs uppercase font-bold">Nơi đến:</span> <span id="prevDest" class="font-semibold text-slate-800">--</span></div>
                        <div class="col-span-2"><span class="text-slate-500 text-xs uppercase font-bold">NVSX:</span> <span id="prevNVSX" class="font-semibold text-slate-800">--</span></div>
                        <div class="col-span-2 border-t border-slate-200 mt-2 pt-2">
                            <span class="text-slate-500 text-xs uppercase font-bold block mb-1">Công việc:</span> 
                            <div id="prevTask" class="whitespace-pre-wrap text-xs bg-white p-2 rounded border border-slate-200 text-slate-700 font-mono">--</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center border-t border-slate-200 mt-3 pt-3">
                        <span class="text-slate-600">Tìm thấy: <strong id="prevCount" class="text-blue-600 text-lg">0</strong> nhân sự</span>
                        <span id="prevWarning" class="text-red-500 font-bold hidden text-xs bg-red-50 px-2 py-1 rounded">Sai ngày!</span>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t border-slate-200 bg-slate-50 flex justify-end gap-3 rounded-b-xl">
                <button onclick="importModal.close()" class="px-4 py-2 bg-white border border-slate-300 hover:bg-slate-100 text-slate-700 rounded text-sm font-medium transition">Hủy</button>
                <button onclick="importModal.processImport()" id="btnConfirmImport" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded text-sm font-bold shadow-sm disabled:opacity-50 disabled:cursor-not-allowed transition" disabled>
                    Xác nhận Import
                </button>
            </div>
        </div>
    </div>

    <!-- EDIT PERSON MODAL -->
    <div id="editPersonModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[90vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <h3 class="font-bold text-slate-800"><i class="fas fa-user-edit mr-2 text-blue-600"></i>Sửa thông tin</h3>
                <button onclick="editModal.close()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <input type="hidden" id="edit_id">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Danh số</label>
                        <input type="text" id="edit_staffNo" class="w-full border rounded p-2 text-sm bg-slate-50">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Họ và tên</label>
                        <input type="text" id="edit_fullName" class="w-full border rounded p-2 text-sm font-bold bg-slate-50">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Chức danh</label>
                        <input type="text" id="edit_title" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Đơn vị</label>
                        <input type="text" id="edit_orgName" class="w-full border rounded p-2 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Ngày sinh</label>
                        <input type="text" id="edit_dob" class="w-full border rounded p-2 text-sm" placeholder="dd/mm/yyyy">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Nơi sinh</label>
                        <input type="text" id="edit_pob" class="w-full border rounded p-2 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">SĐT</label>
                        <input type="text" id="edit_phone" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">CCCD/CMND</label>
                        <input type="text" id="edit_idNo" class="w-full border rounded p-2 text-sm">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Ngày cấp</label>
                        <input type="text" id="edit_idIssueDate" class="w-full border rounded p-2 text-sm" placeholder="dd/mm/yyyy">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Hết hạn</label>
                        <input type="text" id="edit_idExpiryDate" class="w-full border rounded p-2 text-sm" placeholder="dd/mm/yyyy">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Cân nặng</label>
                        <input type="number" id="edit_weightKg" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Hành lý</label>
                        <input type="number" id="edit_luggageKg" class="w-full border rounded p-2 text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-500 uppercase">Hàng hóa</label>
                        <input type="number" id="edit_cargoKg" class="w-full border rounded p-2 text-sm">
                    </div>
                </div>
                
                <div>
                    <label class="text-[10px] font-bold text-slate-500 uppercase">Ghi chú dòng</label>
                    <input type="text" id="edit_rowNote" class="w-full border rounded p-2 text-sm">
                </div>
                
                <div class="border-t pt-3 mt-2">
                    <p class="text-xs text-blue-600 cursor-pointer hover:underline mb-2 font-semibold" onclick="document.getElementById('advEdit').classList.toggle('hidden')">
                        <i class="fas fa-chevron-down mr-1"></i>Mở rộng (Sửa Giàn/NVSX)
                    </p>
                    <div id="advEdit" class="hidden space-y-3 bg-slate-50 p-3 rounded border">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Nơi đến</label>
                            <input type="text" id="edit_destination" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">NVSX</label>
                            <input type="text" id="edit_nvsxNo" class="w-full border rounded p-2 text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Nội dung công việc</label>
                            <textarea id="edit_taskDesc" class="w-full border rounded p-2 text-sm h-20"></textarea>
                        </div>
                    </div>
                </div>

            </div>
            <div class="p-4 border-t border-slate-200 bg-slate-50 flex justify-end gap-3 rounded-b-xl">
                <button onclick="editModal.close()" class="px-4 py-2 bg-white border hover:bg-slate-100 rounded text-sm font-medium">Hủy</button>
                <button onclick="editModal.save()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-bold shadow">Lưu thay đổi</button>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyDBdfswGWEefQR8Djscm2hkaKsi0438ODQ",
          authDomain: "webshop-japan.firebaseapp.com",
          projectId: "webshop-japan",
          storageBucket: "webshop-japan.firebasestorage.app",
          messagingSenderId: "854451712478",
          appId: "1:854451712478:web:d55198786d10a9b98d2d4f",
          measurementId: "G-LGWDL5HTYZ"
        };
        
        const appId = 'xnxl-offshore'; 

        if (!firebase.apps.length) {
             firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // --- STATE ---
        const state = {
            currentUser: null,
            userRole: null, 
            userOrgId: null,
            currentDateKey: new Date().toISOString().split('T')[0].replace(/-/g, ''), // YYYYMMDD
            orgs: [],
            isPlanLocked: false,
            currentPlanPeople: [] 
        };

        // --- UTILS ---
        const utils = {
            formatDate: (dateStr) => {
                if(!dateStr) return '';
                if(dateStr.length === 8) return `${dateStr.substr(6,2)}/${dateStr.substr(4,2)}/${dateStr.substr(0,4)}`;
                return dateStr;
            },
            formatDateTime: (dateObj) => {
                if(!dateObj) return '';
                const d = new Date(dateObj);
                const hh = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                return `${hh}:${min} ${dd}/${mm}`;
            },
            // Just display H:m for short fields
            formatTimeShort: (dateObj) => {
                if(!dateObj) return '';
                const d = new Date(dateObj);
                const hh = String(d.getHours()).padStart(2, '0');
                const min = String(d.getMinutes()).padStart(2, '0');
                return `${hh}:${min}`;
            },
            showToast: (msg, type = 'info') => {
                const el = document.getElementById('toast');
                const colors = type === 'error' ? 'bg-red-500' : 'bg-emerald-600';
                const icon = type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>';
                
                el.className = `fixed top-6 right-6 z-[70] px-6 py-4 rounded-lg shadow-xl text-white font-medium transform transition-all duration-300 translate-y-0 opacity-100 flex items-center gap-3 ${colors}`;
                el.innerHTML = `${icon} <span>${msg}</span>`;
                el.classList.remove('hidden');
                
                setTimeout(() => {
                    el.classList.add('opacity-0', '-translate-y-2');
                    setTimeout(() => el.classList.add('hidden', 'opacity-100', 'translate-y-0'), 300);
                }, 3000);
            },
            toggleLoader: (show, text) => {
                const el = document.getElementById('loadingOverlay');
                if(text) document.getElementById('loadingText').innerText = text;
                show ? el.classList.remove('hidden') : el.classList.add('hidden');
            },
            cleanString: (str) => (str || '').toString().trim()
        };

        // --- APP LOGIC ---
        const app = {
            init: () => {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        utils.toggleLoader(true, 'Đang tải thông tin...');
                        const userDocRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid);
                        const userDoc = await userDocRef.get();
                        
                        // Update Last Login
                        await userDocRef.set({ lastLogin: new Date() }, { merge: true });

                        if (!userDoc.exists) {
                            const role = user.email.includes('admin') ? 'dispatcher' : 'workshop';
                            const orgId = role === 'dispatcher' ? 'XNXL' : 'XuongBo';
                            await userDocRef.set({
                                email: user.email, role, orgId, displayName: user.displayName || user.email, createdAt: new Date()
                            });
                            state.userRole = role;
                            state.userOrgId = orgId;
                        } else {
                            const data = userDoc.data();
                            state.userRole = data.role;
                            state.userOrgId = data.orgId;
                        }

                        state.currentUser = user;
                        app.setupUI();
                        
                        // Display Login Info
                        app.displayLastLoginInfo();

                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('appShell').classList.remove('hidden');
                        document.getElementById('appShell').classList.add('flex');
                        
                        await app.loadOrgs();
                        if(state.userRole === 'dispatcher') {
                            userManager.loadUsers();
                        }
                        
                        const today = new Date();
                        const mm = String(today.getMonth() + 1).padStart(2, '0');
                        const dd = String(today.getDate()).padStart(2, '0');
                        const yyyy = today.getFullYear();
                        document.getElementById('planDateInput').value = `${yyyy}-${mm}-${dd}`;
                        state.currentDateKey = `${yyyy}${mm}${dd}`;
                        
                        await app.loadPlan();
                        utils.toggleLoader(false);
                    } else {
                        document.getElementById('authScreen').classList.remove('hidden');
                        document.getElementById('appShell').classList.add('hidden');
                        document.getElementById('appShell').classList.remove('flex');
                    }
                });

                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const pass = document.getElementById('password').value;
                    try {
                        await auth.signInWithEmailAndPassword(email, pass);
                    } catch (err) {
                        utils.showToast(err.message, 'error');
                    }
                });
                
                document.getElementById('excelFile').addEventListener('change', importModal.handleFile);
            },

            logout: async () => {
                try {
                    await auth.signOut();
                    state.currentUser = null;
                } catch (error) {
                    utils.showToast('Lỗi đăng xuất: ' + error.message, 'error');
                }
            },

            displayLastLoginInfo: async () => {
                const loginValEl = document.getElementById('lastLoginVal');
                const labelEl = document.querySelector('#lastLoginInfo span:first-child');
                
                if (state.userRole === 'dispatcher') {
                    // Find latest login from all users
                    try {
                        // NOTE: In a real app we'd use orderBy('lastLogin', 'desc').limit(1)
                        // But per strict rules "No Complex Queries/indexes", we fetch all and sort in memory.
                        // Since user list is small (<100), this is acceptable.
                        const snap = await db.collection('artifacts').doc(appId).collection('users').get();
                        let latestTime = 0;
                        let latestUser = '';
                        
                        snap.forEach(doc => {
                            const d = doc.data();
                            if (d.lastLogin && d.lastLogin.seconds) {
                                const t = d.lastLogin.seconds * 1000;
                                if (t > latestTime) {
                                    latestTime = t;
                                    latestUser = d.displayName || d.email;
                                }
                            }
                        });
                        
                        if (latestTime > 0) {
                            labelEl.innerText = "User Login cuối:";
                            loginValEl.innerText = `${latestUser} (${utils.formatDateTime(new Date(latestTime))})`;
                        } else {
                            loginValEl.innerText = "Chưa có dữ liệu";
                        }
                    } catch (e) {
                        console.error(e);
                        loginValEl.innerText = "Lỗi tải";
                    }
                } else {
                    // Show current user's last login (just now)
                    labelEl.innerText = "Login lần cuối:";
                    loginValEl.innerText = utils.formatDateTime(new Date());
                }
            },

            setupUI: () => {
                const badge = document.getElementById('userBadge');
                badge.innerText = state.userRole === 'dispatcher' ? 'ĐIỀU ĐỘ (ADMIN)' : `USER: ${state.userOrgId}`;
                
                if (state.userRole === 'dispatcher') {
                    document.getElementById('navSettings').classList.remove('hidden');
                    document.getElementById('btnLock').classList.remove('hidden');
                    document.getElementById('importOrgSelectWrapper').classList.remove('hidden');
                    document.getElementById('btnExport').classList.remove('hidden');
                } else {
                     document.getElementById('navSettings').classList.add('hidden');
                     document.getElementById('btnLock').classList.add('hidden');
                     document.getElementById('importOrgSelectWrapper').classList.add('hidden');
                     document.getElementById('btnExport').classList.add('hidden');
                }
            },

            loadOrgs: async () => {
                const snap = await db.collection('artifacts').doc(appId).collection('organizations').get();
                if (snap.empty) {
                    const seeds = ['Xưởng Bờ', 'Xưởng Sửa Chữa', 'Ban Chánh Hàn', 'Xưởng Biển', 'Ban Khảo Sát', 'XNXL'];
                    const batch = db.batch();
                    seeds.forEach(name => {
                        const ref = db.collection('artifacts').doc(appId).collection('organizations').doc(name);
                        batch.set(ref, { name, createdAt: new Date() });
                    });
                    await batch.commit();
                    state.orgs = seeds.map(name => ({id: name, name}));
                } else {
                    state.orgs = snap.docs.map(d => ({id: d.id, ...d.data()}));
                }
                
                const options = state.orgs.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
                document.getElementById('importOrgSelect').innerHTML = options;
                document.getElementById('u_orgId').innerHTML = options;
            },

            loadPlan: async () => {
                utils.toggleLoader(true, 'Đang tải dữ liệu...');
                const dateVal = document.getElementById('planDateInput').value;
                state.currentDateKey = dateVal.replace(/-/g, '');

                const planRef = db.collection('artifacts').doc(appId).collection('dailyPlans').doc(state.currentDateKey);
                const planSnap = await planRef.get();
                
                state.isPlanLocked = false;
                if (planSnap.exists) {
                    const data = planSnap.data();
                    state.isPlanLocked = data.status === 'Locked';
                    document.getElementById('planStatus').innerText = data.status === 'Locked' ? 'ĐÃ KHÓA' : 'DRAFT';
                    document.getElementById('planStatus').className = `px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider ${data.status === 'Locked' ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-green-50 text-green-700 border border-green-100'}`;
                } else {
                    document.getElementById('planStatus').innerText = 'MỚI';
                    document.getElementById('planStatus').className = 'px-3 py-1.5 rounded text-xs font-bold bg-slate-50 text-slate-500 border border-slate-200';
                }

                const isLocked = state.isPlanLocked;
                const isDispatcher = state.userRole === 'dispatcher';
                
                document.getElementById('btnImport').disabled = isLocked && !isDispatcher;
                if(isLocked && !isDispatcher) document.getElementById('btnImport').classList.add('opacity-50', 'cursor-not-allowed');
                else document.getElementById('btnImport').classList.remove('opacity-50', 'cursor-not-allowed');

                document.getElementById('btnLock').innerHTML = isLocked ? '<i class="fas fa-unlock mr-1"></i> Mở' : '<i class="fas fa-lock mr-1"></i> Khóa';

                const btnDeleteAll = document.getElementById('btnDeleteAll');
                if(!isLocked && (isDispatcher || state.userRole === 'workshop')) {
                    btnDeleteAll.classList.remove('hidden');
                } else {
                    btnDeleteAll.classList.add('hidden');
                }

                let q = planRef.collection('people');
                if (state.userRole !== 'dispatcher') {
                    q = q.where('orgId', '==', state.userOrgId);
                }

                const peopleSnap = await q.get();
                const people = peopleSnap.docs.map(d => ({...d.data(), id: d.id}));
                state.currentPlanPeople = people; 

                app.renderPlanTable(people);
                utils.toggleLoader(false);
            },

            renderPlanTable: (people) => {
                const container = document.getElementById('planContent');
                
                if (people.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white">
                        <div class="bg-slate-50 p-6 rounded-full mb-4">
                            <i class="fas fa-clipboard-list text-4xl text-slate-300"></i>
                        </div>
                        <p class="text-sm font-medium">Chưa có dữ liệu. Vui lòng Import từ Excel.</p>
                    </div>`;
                    app.updateStats(0,0,0,0);
                    return;
                }

                const total = people.length;
                const offshore = people.filter(p => !p.isReturn).length;
                const warningCount = people.filter(p => p.warnings && p.warnings.length > 0).length;
                app.updateStats(total, total, 0, warningCount);

                const grouped = people.reduce((acc, p) => {
                    const dest = p.destination || 'Chưa xác định';
                    if (!acc[dest]) acc[dest] = [];
                    acc[dest].push(p);
                    return acc;
                }, {});

                let html = '';
                Object.keys(grouped).sort().forEach(dest => {
                    const group = grouped[dest];
                    const firstP = group[0];
                    const taskDisplay = (firstP.taskDesc || '').replace(/\n/g, '<br/>');
                    
                    const metaInfo = `
                        <div class="mt-1 text-xs text-slate-600 space-y-1">
                            <div><span class="font-bold">NVSX:</span> ${firstP.nvsxNo || '--'}</div>
                            <div class="flex items-start"><span class="font-bold mr-1 whitespace-nowrap">Công việc:</span> <span class="line-clamp-2">${taskDisplay || '--'}</span></div>
                        </div>`;

                    html += `
                        <div class="bg-blue-50/50 px-4 py-3 border-b border-blue-100 sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                            <div class="flex justify-between items-start">
                                <div class="w-4/5">
                                    <div class="font-bold text-blue-800 text-base flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> ${dest}
                                    </div>
                                    ${metaInfo}
                                </div>
                                <span class="text-xs bg-white text-blue-600 px-2 py-1 rounded font-bold border border-blue-100">${group.length} người</span>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-slate-100 text-xs">
                                <thead>
                                    <tr>
                                        <th class="px-3 py-3 text-center w-10">STT</th>
                                        <th class="px-3 py-3 text-left w-20">Danh số</th>
                                        <th class="px-3 py-3 text-left w-40">Họ tên</th>
                                        <th class="px-3 py-3 text-left w-40">Chức danh / Đơn vị</th>
                                        <th class="px-3 py-3 text-left w-32">Ngày sinh / Nơi sinh</th>
                                        <th class="px-3 py-3 text-left w-24">SĐT</th>
                                        <th class="px-3 py-3 text-left w-32">CCCD / Hết hạn</th>
                                        <th class="px-3 py-3 text-center w-16">Cân nặng</th>
                                        <th class="px-3 py-3 text-center w-16">Hành lý</th>
                                        <th class="px-3 py-3 text-center w-16">Hàng hóa</th>
                                        <th class="px-3 py-3 text-left w-32">Ghi chú</th>
                                        <th class="px-3 py-3 text-center sticky right-0 bg-slate-50 w-20 shadow-l-sm">Sửa</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-50">
                    `;
                    
                    group.sort((a,b) => (a.nvsxNo || '').localeCompare(b.nvsxNo || '')).forEach((p, idx) => {
                        const warningClass = (p.warnings && p.warnings.length > 0) ? 'bg-red-50/50' : '';
                        const warningIcon = (p.warnings && p.warnings.length > 0) ? `<i class="fas fa-exclamation-triangle text-red-500 ml-1" title="${p.warnings.join(', ')}"></i>` : '';
                        
                        const canEdit = state.userRole === 'dispatcher' || (!state.isPlanLocked && p.orgId === state.userOrgId);
                        
                        // Time Ago Logic
                        let updatedTimeStr = '';
                        if (p.updatedAt) {
                            updatedTimeStr = utils.formatTimeShort(p.updatedAt.seconds ? new Date(p.updatedAt.seconds * 1000) : new Date(p.updatedAt));
                        } else if (p.createdAt) {
                            updatedTimeStr = utils.formatTimeShort(p.createdAt.seconds ? new Date(p.createdAt.seconds * 1000) : new Date(p.createdAt));
                        }

                        const actionBtns = canEdit ? 
                            `<div class="flex flex-col items-center justify-center">
                                <div class="flex space-x-2 mb-1">
                                    <button onclick="editModal.open('${p.id}')" class="text-blue-500 hover:text-blue-700 transition"><i class="fas fa-pen"></i></button>
                                    <button onclick="app.deletePerson('${p.id}')" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash-alt"></i></button>
                                </div>
                                <span class="text-[9px] text-slate-400 font-mono">${updatedTimeStr}</span>
                             </div>` : 
                            `<div class="flex flex-col items-center">
                                <span class="text-slate-300"><i class="fas fa-lock"></i></span>
                                <span class="text-[9px] text-slate-300 font-mono mt-1">${updatedTimeStr}</span>
                             </div>`;

                        html += `
                            <tr class="${warningClass} hover:bg-blue-50/30 transition duration-75 group">
                                <td class="px-3 py-2 text-slate-400 text-center font-mono">${idx + 1}</td>
                                <td class="px-3 py-2 text-slate-600 font-mono">${p.staffNo}</td>
                                <td class="px-3 py-2 font-semibold text-slate-700">${p.fullName}</td>
                                <td class="px-3 py-2 text-slate-600">
                                    <div class="font-medium">${p.title || ''}</div>
                                    <div class="text-[10px] text-slate-400 uppercase mt-0.5 font-bold tracking-wide">${p.orgName || '-'}</div>
                                </td>
                                <td class="px-3 py-2 text-slate-600">
                                    <div class="font-mono text-xs">${p.dob || '-'}</div>
                                    <div class="text-[10px] text-slate-400 mt-0.5">${p.pob || ''}</div>
                                </td>
                                <td class="px-3 py-2 text-slate-600 font-mono">${p.phone || '-'}</td>
                                <td class="px-3 py-2 text-slate-600">
                                    <div class="font-mono text-xs">${p.idNo || '-'}</div>
                                    <div class="text-[10px] ${p.isIdExpiring ? 'text-red-600 font-bold' : 'text-slate-400'} mt-0.5">${p.idExpiryDate || ''}${warningIcon}</div>
                                </td>
                                <td class="px-3 py-2 text-slate-600 text-center">${p.weightKg || 0}</td>
                                <td class="px-3 py-2 text-slate-600 text-center">${p.luggageKg || 0}</td>
                                <td class="px-3 py-2 text-slate-600 text-center">${p.cargoKg || 0}</td>
                                <td class="px-3 py-2 text-slate-500 italic text-[11px] break-words max-w-[150px]">${p.rowNote || ''}</td>
                                <td class="px-3 py-2 text-center sticky right-0 bg-white group-hover:bg-blue-50/30 shadow-l-sm border-l border-slate-50">
                                    ${actionBtns}
                                </td>
                            </tr>
                        `;
                    });

                    html += `</tbody></table></div>`;
                });
                container.innerHTML = html;
            },
            
            deletePerson: async (personId) => {
                if(!confirm("Xác nhận xóa nhân sự này?")) return;
                utils.toggleLoader(true, 'Đang xóa...');
                try {
                    await db.collection('artifacts').doc(appId)
                        .collection('dailyPlans').doc(state.currentDateKey)
                        .collection('people').doc(personId).delete();
                    utils.showToast("Đã xóa thành công", "success");
                    await app.loadPlan();
                } catch(e) {
                    console.error(e);
                    utils.showToast("Lỗi: " + e.message, "error");
                    utils.toggleLoader(false);
                }
            },

            deleteAllPeople: async () => {
                if(state.currentPlanPeople.length === 0) return;
                if(!confirm("CẢNH BÁO: Xóa TOÀN BỘ danh sách ngày này?")) return;
                if(!confirm("Không thể hoàn tác. Chắc chắn xóa?")) return;

                utils.toggleLoader(true, 'Đang xóa tất cả...');
                try {
                    const batchSize = 500;
                    const peopleRef = db.collection('artifacts').doc(appId)
                        .collection('dailyPlans').doc(state.currentDateKey)
                        .collection('people');
                    
                    let peopleToDelete = state.currentPlanPeople;
                    if(state.userRole !== 'dispatcher') {
                        peopleToDelete = peopleToDelete.filter(p => p.orgId === state.userOrgId);
                    }

                    const chunks = [];
                    for (let i = 0; i < peopleToDelete.length; i += batchSize) {
                        chunks.push(peopleToDelete.slice(i, i + batchSize));
                    }

                    for (const chunk of chunks) {
                        const batch = db.batch();
                        chunk.forEach(p => {
                            batch.delete(peopleRef.doc(p.id));
                        });
                        await batch.commit();
                    }

                    utils.showToast(`Đã xóa ${peopleToDelete.length} nhân sự`, "success");
                    await app.loadPlan();
                } catch(e) {
                    utils.showToast("Lỗi: " + e.message, "error");
                    utils.toggleLoader(false);
                }
            },

            updateStats: (total, offshore, returnCount, warnings) => {
                document.getElementById('statTotal').innerText = total;
                document.getElementById('statOffshore').innerText = offshore;
                document.getElementById('statReturn').innerText = returnCount;
                document.getElementById('statWarnings').innerText = warnings;
                
                const wBox = document.getElementById('warningStatBox');
                if(warnings > 0) wBox.classList.remove('opacity-30');
                else wBox.classList.add('opacity-30');
            },

            toggleLockPlan: async () => {
                if(state.userRole !== 'dispatcher') return;
                const newStatus = state.isPlanLocked ? 'Draft' : 'Locked';
                await db.collection('artifacts').doc(appId).collection('dailyPlans').doc(state.currentDateKey).set({
                    status: newStatus,
                    lockedAt: new Date(),
                    lockedBy: state.currentUser.email
                }, { merge: true });
                utils.showToast(`Đã ${newStatus === 'Locked' ? 'KHÓA' : 'MỞ'} ngày đăng ký`, 'success');
                app.loadPlan();
            },

            showSettings: () => {
                document.getElementById('dashboardView').classList.add('hidden');
                document.getElementById('settingsView').classList.remove('hidden');
                app.renderOrgList();
                app.loadSignatureConfig();
            },
            showDashboard: () => {
                document.getElementById('settingsView').classList.add('hidden');
                document.getElementById('dashboardView').classList.remove('hidden');
            },
            renderOrgList: () => {
                const ul = document.getElementById('orgList');
                ul.innerHTML = state.orgs.map(o => `
                    <li class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100 text-xs">
                        <span>${o.name}</span>
                        <button onclick="app.deleteOrg('${o.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button>
                    </li>
                `).join('');
            },
            addOrg: async () => {
                const name = document.getElementById('newOrgName').value.trim();
                if(!name) return;
                await db.collection('artifacts').doc(appId).collection('organizations').doc(name).set({name, createdAt: new Date()});
                document.getElementById('newOrgName').value = '';
                await app.loadOrgs();
                app.renderOrgList();
            },
            deleteOrg: async (id) => {
                if(!confirm('Xóa đơn vị này?')) return;
                await db.collection('artifacts').doc(appId).collection('organizations').doc(id).delete();
                await app.loadOrgs();
                app.renderOrgList();
            },
            loadSignatureConfig: async () => {
                const doc = await db.collection('artifacts').doc(appId).collection('settings').doc('signature').get();
                if(doc.exists) {
                    const data = doc.data();
                    document.getElementById('sigApprover').value = data.approver || '';
                    document.getElementById('sigApproverName').value = data.approverName || '';
                }
            },
            saveSettings: async () => {
                const config = {
                    approver: document.getElementById('sigApprover').value,
                    approverName: document.getElementById('sigApproverName').value
                };
                await db.collection('artifacts').doc(appId).collection('settings').doc('signature').set(config);
                utils.showToast('Đã lưu cấu hình');
            },
        };
        
        // --- IMPORT LOGIC ---
        const importModal = {
            parsedData: null,
            
            open: () => {
                document.getElementById('excelFile').value = '';
                document.getElementById('fileNameDisplay').innerText = '';
                document.getElementById('parseResult').classList.add('hidden');
                document.getElementById('btnConfirmImport').disabled = true;
                
                // Show modal
                document.getElementById('importModal').classList.remove('hidden');
                document.getElementById('importModal').classList.add('flex');
            },

            close: () => {
                 document.getElementById('importModal').classList.add('hidden');
                 document.getElementById('importModal').classList.remove('flex');
            },
            
            handleFile: async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                document.getElementById('fileNameDisplay').innerText = file.name;
                utils.toggleLoader(true, 'Đang phân tích file Excel...');
                
                try {
                    const data = await importModal.parseExcel(file);
                    importModal.parsedData = data;
                    
                    // Render Preview
                    document.getElementById('prevDate').innerText = data.date || '--';
                    document.getElementById('prevDest').innerText = data.destination || '--';
                    document.getElementById('prevNVSX').innerText = data.nvsx || '--';
                    document.getElementById('prevTask').innerText = data.task || '--';
                    document.getElementById('prevCount').innerText = data.people.length;
                    
                    // Check Date warning
                    const selectedDate = document.getElementById('planDateInput').value;
                    const [y, m, d] = selectedDate.split('-');
                    const formattedSelect = `${d}/${m}/${y}`;
                    
                    if(data.date && data.date !== formattedSelect) {
                         const warnEl = document.getElementById('prevWarning');
                         warnEl.classList.remove('hidden');
                         warnEl.title = `File: ${data.date} khác với Ngày đang chọn: ${formattedSelect}`;
                    } else {
                        document.getElementById('prevWarning').classList.add('hidden');
                    }

                    document.getElementById('parseResult').classList.remove('hidden');
                    document.getElementById('btnConfirmImport').disabled = data.people.length === 0;

                } catch (err) {
                    utils.showToast('Lỗi đọc file: ' + err.message, 'error');
                    console.error(err);
                } finally {
                    utils.toggleLoader(false);
                }
            },
            
            parseExcel: (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, {type: 'array'});
                            const sheetName = workbook.SheetNames[0];
                            const sheet = workbook.Sheets[sheetName];
                            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ''});
                            
                            // 1. Extract Meta info
                            let date = '';
                            let destination = '';
                            let nvsx = '';
                            let task = '';
                            let headerRowIndex = -1;
                            
                            // 1) Ngày ĐK: B6 (Index: Row 5, Col 1)
                            if (rows[5] && rows[5][1]) {
                                const val = rows[5][1].toString().trim();
                                const dateMatch = val.match(/(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})/);
                                if (dateMatch) {
                                    date = `${dateMatch[1].padStart(2,'0')}/${dateMatch[2].padStart(2,'0')}/${dateMatch[3]}`;
                                } else {
                                    const textMatch = val.toLowerCase().match(/ngày\s*(\d{1,2})\s*tháng\s*(\d{1,2})\s*năm\s*(\d{4})/);
                                    if(textMatch) {
                                         date = `${textMatch[1].padStart(2,'0')}/${textMatch[2].padStart(2,'0')}/${textMatch[3]}`;
                                    }
                                }
                            }

                            // 2) Giàn (Nơi đến): B7 (Index: Row 6, Col 1)
                            if (rows[6] && rows[6][1]) {
                                let val = rows[6][1].toString().trim();
                                if(val.includes(':')) {
                                    val = val.substring(val.indexOf(':') + 1).trim();
                                }
                                destination = val;
                            }

                            // 3) NVSX: B8 (Index: Row 7, Col 1)
                            if (rows[7] && rows[7][1]) {
                                let val = rows[7][1].toString().trim();
                                const matches = val.match(/\d{3}-\d{2}(?:BS\d+)?/gi);
                                if (matches && matches.length > 0) {
                                    nvsx = [...new Set(matches)].join('; ');
                                } else {
                                    if(val.includes(':')) {
                                        val = val.substring(val.indexOf(':') + 1).trim();
                                    }
                                    nvsx = val;
                                }
                            }

                            // 4) Nội dung công việc: B9 (Index: Row 8, Col 1)
                            if (rows[8] && rows[8][1]) {
                                let val = rows[8][1].toString().trim();
                                if(val.includes(':')) {
                                    const firstColon = val.indexOf(':');
                                    if (firstColon < 50) { 
                                        val = val.substring(firstColon + 1).trim();
                                    }
                                }
                                const lines = val.split(/\r\n|\r|\n/).map(x => x.trim()).filter(x => x);
                                if(lines.length > 1) {
                                    task = lines.map((line, idx) => `${idx+1}) ${line}`).join('\n');
                                } else {
                                    task = val;
                                }
                            }
                            
                            // Scan for Header
                            for(let i=0; i < Math.min(rows.length, 25); i++) {
                                const rowStr = rows[i].join(' ').toLowerCase();
                                if(rowStr.includes('stt') && (rowStr.includes('họ và tên') || rowStr.includes('họ tên'))) {
                                    headerRowIndex = i;
                                }
                            }
                            
                            // 2. Extract People
                            if(headerRowIndex === -1) {
                                return reject(new Error("Không tìm thấy dòng tiêu đề bảng (chứa STT, Họ tên)"));
                            }
                            
                            const headers = rows[headerRowIndex].map(h => h.toString().toLowerCase().trim());
                            const colMap = {
                                staffNo: headers.findIndex(h => h.includes('danh số') || h.includes('msnv')),
                                fullName: headers.findIndex(h => h.includes('họ và tên') || h.includes('họ tên')),
                                title: headers.findIndex(h => h.includes('chức danh')),
                                org: headers.findIndex(h => h.includes('đơn vị') || h.includes('xưởng') || h.includes('bộ phận') || h.includes('công ty')), // Add Org Mapping
                                dob: headers.findIndex(h => h.includes('sinh')),
                                pob: headers.findIndex(h => h.includes('nơi sinh')),
                                phone: headers.findIndex(h => h.includes('sđt') || h.includes('điện thoại')),
                                idNo: headers.findIndex(h => h.includes('cccd') || h.includes('cmnd')),
                                idExpiry: headers.findIndex(h => h.includes('hết hạn') || h.includes('ngày cấp')), 
                                weight: headers.findIndex(h => h.includes('kg') || h.includes('trọng lượng') || h.includes('cân nặng')),
                                luggage: headers.findIndex(h => h.includes('hành lý')),
                                cargo: headers.findIndex(h => h.includes('hàng hóa') || h.includes('vật tư')),
                                note: headers.findIndex(h => h.includes('ghi chú'))
                            };
                            
                            if(colMap.fullName === -1) return reject(new Error("Cột 'Họ và tên' không tìm thấy"));

                            const people = [];
                            for(let i = headerRowIndex + 1; i < rows.length; i++) {
                                const row = rows[i];
                                if(!row || row.length < 2 || !row[colMap.fullName]) continue;
                                const name = row[colMap.fullName].toString().trim();
                                if(!name || name.toLowerCase().includes('tổng cộng') || name.toLowerCase().includes('người lập')) continue;
                                
                                const person = {
                                    fullName: name,
                                    staffNo: colMap.staffNo > -1 ? utils.cleanString(row[colMap.staffNo]) : '',
                                    title: colMap.title > -1 ? utils.cleanString(row[colMap.title]) : '',
                                    orgName: colMap.org > -1 ? utils.cleanString(row[colMap.org]) : '', // Extract Org from Excel if available
                                    dob: colMap.dob > -1 ? utils.cleanString(row[colMap.dob]) : '',
                                    pob: colMap.pob > -1 ? utils.cleanString(row[colMap.pob]) : '',
                                    phone: colMap.phone > -1 ? utils.cleanString(row[colMap.phone]) : '',
                                    idNo: colMap.idNo > -1 ? utils.cleanString(row[colMap.idNo]) : '',
                                    idExpiryDate: colMap.idExpiry > -1 ? utils.cleanString(row[colMap.idExpiry]) : '',
                                    weightKg: colMap.weight > -1 ? (parseFloat(row[colMap.weight]) || 0) : 0,
                                    luggageKg: colMap.luggage > -1 ? (parseFloat(row[colMap.luggage]) || 0) : 0,
                                    cargoKg: colMap.cargo > -1 ? (parseFloat(row[colMap.cargo]) || 0) : 0,
                                    rowNote: colMap.note > -1 ? utils.cleanString(row[colMap.note]) : ''
                                };
                                people.push(person);
                            }
                            
                            resolve({ date, destination, nvsx, task, people });
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                });
            },
            
            processImport: async () => {
                if(!importModal.parsedData) return;
                
                utils.toggleLoader(true, 'Đang lưu vào hệ thống...');
                
                // Determine Default Org from Context (if Excel doesn't have it)
                let defaultOrgId = state.userOrgId;
                let defaultOrgName = state.userOrgId;
                
                if(state.userRole === 'dispatcher') {
                    const sel = document.getElementById('importOrgSelect');
                    defaultOrgId = sel.value;
                    defaultOrgName = sel.options[sel.selectedIndex].text;
                } else {
                    const found = state.orgs.find(o => o.id === defaultOrgId);
                    if(found) defaultOrgName = found.name;
                }

                const { date, destination, nvsx, task, people } = importModal.parsedData;
                
                const dateKey = state.currentDateKey;
                
                try {
                    const batch = db.batch();
                    const collectionRef = db.collection('artifacts').doc(appId)
                        .collection('dailyPlans').doc(dateKey)
                        .collection('people');

                    const planRef = db.collection('artifacts').doc(appId).collection('dailyPlans').doc(dateKey);
                    batch.set(planRef, { 
                        updatedAt: new Date(), 
                        status: state.isPlanLocked ? 'Locked' : 'Draft' 
                    }, { merge: true });

                    people.forEach(p => {
                        const newRef = collectionRef.doc();
                        
                        const warnings = [];
                        if(!p.staffNo) warnings.push('Thiếu danh số');
                        if(p.idExpiryDate) {
                             const parts = p.idExpiryDate.split(/[\/\-\.]/);
                             if(parts.length === 3) {
                                 const d = parseInt(parts[0]);
                                 const m = parseInt(parts[1]);
                                 const y = parseInt(parts[2].length === 2 ? '20'+parts[2] : parts[2]);
                                 const exp = new Date(y, m-1, d);
                                 const now = new Date();
                                 const diffTime = exp - now;
                                 const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                 if(diffDays < 0) warnings.push('CCCD Hết hạn');
                                 else if(diffDays < 30) warnings.push('CCCD sắp hết hạn');
                             }
                        }

                        // Use Org from Excel if available, otherwise use context default
                        const finalOrgName = p.orgName || defaultOrgName;

                        batch.set(newRef, {
                            ...p,
                            orgName: finalOrgName,
                            destination: destination || '',
                            nvsxNo: nvsx || '',
                            taskDesc: task || '',
                            orgId: defaultOrgId, // Keep tracking uploader org ID for permissions
                            warnings,
                            createdAt: new Date(),
                            importedBy: state.currentUser.email
                        });
                    });

                    await batch.commit();
                    
                    utils.showToast(`Đã import thành công ${people.length} nhân sự`, 'success');
                    importModal.close();
                    await app.loadPlan();
                    
                } catch(e) {
                    console.error(e);
                    utils.showToast('Lỗi lưu dữ liệu: ' + e.message, 'error');
                } finally {
                    utils.toggleLoader(false);
                }
            }
        };

        const userModal = {
            open: () => {
                document.getElementById('u_email').value = '';
                document.getElementById('u_password').value = '';
                document.getElementById('u_name').value = '';
                userModal.toggleOrgSelect();
                document.getElementById('userModal').classList.remove('hidden');
                document.getElementById('userModal').classList.add('flex');
            },
            close: () => {
                document.getElementById('userModal').classList.add('hidden');
                document.getElementById('userModal').classList.remove('flex');
            },
            toggleOrgSelect: () => {
                const role = document.getElementById('u_role').value;
                const wrapper = document.getElementById('u_orgWrapper');
                if (role === 'dispatcher') {
                    wrapper.classList.add('hidden');
                } else {
                    wrapper.classList.remove('hidden');
                }
            }
        };

        const userManager = {
            loadUsers: async () => {
                const snap = await db.collection('artifacts').doc(appId).collection('users').get();
                const tbody = document.getElementById('userListBody');
                tbody.innerHTML = snap.docs.map(doc => {
                    const u = doc.data();
                    const roleBadge = u.role === 'dispatcher' ? 
                        '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-bold">Admin</span>' : 
                        '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">User</span>';
                    
                    return `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-2">${u.email}</td>
                            <td class="px-4 py-2 font-medium">${u.displayName || '-'}</td>
                            <td class="px-4 py-2">${roleBadge}</td>
                            <td class="px-4 py-2 text-slate-500">${u.orgId || 'XNXL'}</td>
                            <td class="px-4 py-2 text-right">
                                <button onclick="userManager.sendResetEmail('${u.email}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold mr-2">Reset Pass</button>
                                <button onclick="userManager.deleteUserDoc('${doc.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            createUser: async () => {
                const email = document.getElementById('u_email').value.trim();
                const password = document.getElementById('u_password').value.trim();
                const name = document.getElementById('u_name').value.trim();
                const role = document.getElementById('u_role').value;
                const orgId = role === 'dispatcher' ? 'XNXL' : document.getElementById('u_orgId').value;

                if(!email || !password || !name) return utils.showToast('Vui lòng điền đủ thông tin', 'error');

                utils.toggleLoader(true, 'Đang tạo user...');
                try {
                    // Secondary App Trick to create user without logging out admin
                    const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
                    const userCred = await secondaryApp.auth().createUserWithEmailAndPassword(email, password);
                    const uid = userCred.user.uid;
                    
                    // Create Firestore Profile
                    await db.collection('artifacts').doc(appId).collection('users').doc(uid).set({
                        email, role, orgId, displayName: name, createdAt: new Date()
                    });

                    await secondaryApp.delete(); // Cleanup
                    
                    utils.showToast(`Đã tạo user ${email}`, 'success');
                    userModal.close();
                    userManager.loadUsers();
                } catch (e) {
                    console.error(e);
                    utils.showToast(e.message, 'error');
                } finally {
                    utils.toggleLoader(false);
                }
            },

            sendResetEmail: async (email) => {
                if(!confirm(`Gửi email đặt lại mật khẩu cho ${email}?`)) return;
                try {
                    await auth.sendPasswordResetEmail(email);
                    utils.showToast('Đã gửi email reset pass', 'success');
                } catch(e) {
                    utils.showToast(e.message, 'error');
                }
            },
            
            deleteUserDoc: async (uid) => {
                if(!confirm('Xóa thông tin user này khỏi hệ thống? (User vẫn có thể đăng nhập nhưng không có quyền)')) return;
                try {
                    await db.collection('artifacts').doc(appId).collection('users').doc(uid).delete();
                    utils.showToast('Đã xóa profile', 'success');
                    userManager.loadUsers();
                } catch(e) {
                    utils.showToast(e.message, 'error');
                }
            }
        };

        // --- CLIENT-SIDE EXPORT LOGIC ---
        const clientSideExportDocx = async () => {
                utils.toggleLoader(true, 'Đang tạo file DOCX...');
                try {
                    let people = state.currentPlanPeople;
                    if(state.userRole === 'dispatcher') {
                        const snap = await db.collection('artifacts').doc(appId)
                            .collection('dailyPlans').doc(state.currentDateKey)
                            .collection('people').get();
                        people = snap.docs.map(d => d.data());
                    }

                    if(people.length === 0) {
                        utils.showToast('Không có dữ liệu để export', 'error');
                        utils.toggleLoader(false);
                        return;
                    }

                    let sig = { approver: 'TRƯỞNG BAN TTĐĐSX', approverName: '' };
                    const sigDoc = await db.collection('artifacts').doc(appId).collection('settings').doc('signature').get();
                    if(sigDoc.exists) sig = sigDoc.data();

                    people.sort((a, b) => {
                        return (a.destination || '').localeCompare(b.destination || '') ||
                               (a.nvsxNo || '').localeCompare(b.nvsxNo || '') ||
                               (a.orgName || '').localeCompare(b.orgName || '');
                    });

                    const grouped = people.reduce((acc, p) => {
                        const key = p.destination || 'KHÁC';
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(p);
                        return acc;
                    }, {});

                    const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, AlignmentType, BorderStyle, HeightRule } = docx;

                    const children = [];
                    const dateStr = utils.formatDate(state.currentDateKey);
                    const [dd, mm, yyyy] = dateStr.split('/');
                    const FONT_FAMILY = "Times New Roman";
                    const SIZE_NORMAL = 24; 
                    const SIZE_SMALL = 22; 

                    // HEADER TABLE (Borderless)
                    children.push(
                        new Table({
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({
                                            children: [
                                                new Paragraph({ children: [new TextRun({ text: "LIÊN DOANH VIỆT – NGA", bold: true, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                                new Paragraph({ children: [new TextRun({ text: "VIETSOVPETRO", bold: true, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                                new Paragraph({ children: [new TextRun({ text: "XNXL", bold: true, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                                new Paragraph({ text: "" }),
                                                new Paragraph({ children: [new TextRun({ text: "Số: ...../.....-CV-XL", size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                            ],
                                            borders: { top: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, bottom: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, left: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, right: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"} },
                                            width: { size: 40, type: WidthType.PERCENTAGE }
                                        }),
                                        new TableCell({
                                            children: [
                                                new Paragraph({ children: [new TextRun({ text: "CỘNG HOÀ XÃ HỘI CHỦ NGHĨA VIỆT NAM", bold: true, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                                new Paragraph({ children: [new TextRun({ text: "Độc lập – Tự do – Hạnh phúc", bold: true, underline: { type: "single" }, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                                new Paragraph({ text: "" }),
                                                new Paragraph({ children: [new TextRun({ text: `TPHCM, ngày ${dd} tháng ${mm} năm ${yyyy}`, size: SIZE_SMALL, italics: true, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                            ],
                                            borders: { top: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, bottom: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, left: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, right: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"} },
                                            width: { size: 60, type: WidthType.PERCENTAGE }
                                        })
                                    ]
                                })
                            ],
                            width: { size: 100, type: WidthType.PERCENTAGE }
                        }),
                        new Paragraph({ text: "" })
                    );

                    // RECIPIENT
                    children.push(
                        new Paragraph({ children: [ new TextRun({ text: "Kính gửi:  Trưởng ban ban TTĐĐSX", size: SIZE_NORMAL, font: FONT_FAMILY }) ], alignment: AlignmentType.CENTER }),
                        new Paragraph({ text: "" }),
                        new Paragraph({ children: [ new TextRun({ text: "ĐƠN ĐĂNG KÝ ĐI RA CÔNG TRÌNH BIỂN", bold: true, size: 28, font: FONT_FAMILY }) ], alignment: AlignmentType.CENTER }),
                        new Paragraph({ text: "" })
                    );

                    // METADATA
                    const dateDot = dateStr.replace(/\//g, '.');
                    children.push(new Paragraph({ children: [new TextRun({ text: `Đơn vị đăng ký:      XNXL`, size: SIZE_NORMAL, font: FONT_FAMILY })] }));
                    children.push(new Paragraph({ children: [new TextRun({ text: `Ngày khởi hành:  ${dateDot}`, size: SIZE_NORMAL, font: FONT_FAMILY })] }));
                    children.push(new Paragraph({ children: [new TextRun({ text: `Phương tiện yêu cầu:     Trực thăng x;     Tàu x`, size: SIZE_NORMAL, font: FONT_FAMILY })] }));
                    children.push(new Paragraph({ children: [new TextRun({ text: `Đến CT biển : ${Object.keys(grouped).join(', ')}`, size: SIZE_NORMAL, font: FONT_FAMILY })] }));
                    children.push(new Paragraph({ children: [new TextRun({ text: `Nhiệm vụ được giao: `, size: SIZE_NORMAL, font: FONT_FAMILY })] }));

                    Object.keys(grouped).forEach(dest => {
                        const group = grouped[dest];
                        const uniqueNVSX = [...new Set(group.map(p => p.nvsxNo).filter(x => x))].join('; ');
                        const uniqueTasks = [...new Set(group.map(p => p.taskDesc).filter(t => t))];
                        
                        children.push(new Paragraph({ 
                            children: [ new TextRun({ text: "-", size: SIZE_NORMAL, font: FONT_FAMILY }), new TextRun({ text: ` Tại ${dest}: `, bold: true, size: SIZE_NORMAL, font: FONT_FAMILY }) ],
                            indent: { left: 720 }, spacing: { before: 100 }
                        }));

                        if(uniqueNVSX) {
                             children.push(new Paragraph({ children: [ new TextRun({ text: `+ NVSX: ${uniqueNVSX}`, size: SIZE_NORMAL, font: FONT_FAMILY }) ], indent: { left: 1440 } }));
                        }

                        if(uniqueTasks.length > 0) {
                             children.push(new Paragraph({ children: [ new TextRun({ text: `+ Nội dung công việc:`, size: SIZE_NORMAL, font: FONT_FAMILY }) ], indent: { left: 1440 } }));
                            uniqueTasks.forEach(task => {
                                const lines = task.split('\n');
                                lines.forEach((line) => {
                                    if(line.trim()) {
                                        children.push(new Paragraph({ children: [ new TextRun({ text: line.trim(), size: SIZE_NORMAL, font: FONT_FAMILY }) ], indent: { left: 2160 } }));
                                    }
                                });
                            });
                        }
                    });

                    children.push(new Paragraph({ children: [new TextRun({ text: `Danh sách nhân viên: `, size: SIZE_NORMAL, font: FONT_FAMILY })] }), new Paragraph({ text: "" }));

                    // MAIN TABLE (With Borders)
                    const tableRows = [];
                    const headers = ["Số TT", "Họ và tên", "Chức danh", "Đơn vị", "Danh số"];
                    const colWidths = [10, 30, 20, 20, 20]; 

                    tableRows.push(new TableRow({
                        children: headers.map((text, idx) => 
                            new TableCell({
                                children: [new Paragraph({ children: [new TextRun({ text, bold: true, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER })],
                                verticalAlign: "center", width: { size: colWidths[idx], type: WidthType.PERCENTAGE }, shading: { fill: "FFFFFF" }
                            })
                        ), tableHeader: true
                    }));

                    Object.keys(grouped).forEach(dest => {
                        const group = grouped[dest];
                        tableRows.push(new TableRow({
                            children: [new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: `GIÀN  ${dest} ( ${dateDot} )`, bold: true, size: SIZE_SMALL, font: FONT_FAMILY })] })], columnSpan: 5, shading: { fill: "D9D9D9" } })]
                        }));
                        group.forEach((p, i) => {
                            tableRows.push(new TableRow({
                                children: [
                                    new TableCell({ children: [new Paragraph({ text: (i+1).toString(), alignment: AlignmentType.CENTER, size: SIZE_SMALL, font: FONT_FAMILY })] }),
                                    new TableCell({ children: [new Paragraph({ text: p.fullName, size: SIZE_SMALL, font: FONT_FAMILY })] }),
                                    new TableCell({ children: [new Paragraph({ text: p.title, size: SIZE_SMALL, font: FONT_FAMILY })] }),
                                    new TableCell({ children: [new Paragraph({ text: p.orgName, size: SIZE_SMALL, font: FONT_FAMILY })] }),
                                    new TableCell({ children: [new Paragraph({ text: p.staffNo, alignment: AlignmentType.CENTER, size: SIZE_SMALL, font: FONT_FAMILY })] }),
                                ]
                            }));
                        });
                    });

                    children.push(new Table({ 
                        rows: tableRows, 
                        width: { size: 100, type: WidthType.PERCENTAGE },
                        // Standard black border for Main Table
                        borders: {
                            top: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                            bottom: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                            left: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                            right: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                            insideVertical: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                            insideHorizontal: { style: BorderStyle.SINGLE, size: 1, color: "000000" },
                        }
                    }), new Paragraph({ text: "" }), new Paragraph({ text: "" }));

                    // FOOTER (Borderless)
                    const rightTitle = sig.approver || 'TRƯỞNG BAN TTĐĐSX';
                    children.push(new Table({
                        rows: [
                            new TableRow({
                                children: [
                                    new TableCell({
                                        children: [
                                            // Extra spacing for "Ký tắt" to align lower (9 lines now)
                                            new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }),
                                            new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }),
                                            new Paragraph({ children: [new TextRun({ text: "Ký tắt:", bold: true, italics: true, size: SIZE_SMALL, font: FONT_FAMILY })] }),
                                            new Paragraph({ text: "" }),
                                            new Paragraph({ children: [new TextRun({ text: "- Lãnh đạo LDVN Vietsovpetro (nếu cần)", size: SIZE_SMALL, font: FONT_FAMILY })], indent: { left: 100 } }),
                                            new Paragraph({ text: "" }),
                                            new Paragraph({ children: [new TextRun({ text: "- Điều độ – XNKT:", size: SIZE_SMALL, font: FONT_FAMILY })], indent: { left: 100 } }),
                                            new Paragraph({ text: "" }),
                                            new Paragraph({ children: [new TextRun({ text: "- Phòng kỹ thuật :", size: SIZE_SMALL, font: FONT_FAMILY })], indent: { left: 100 } }),
                                            new Paragraph({ text: "" }),
                                            new Paragraph({ children: [new TextRun({ text: "- Điều độ XNXL:                            Số đt: 8626", size: SIZE_SMALL, font: FONT_FAMILY })], indent: { left: 100 } }),
                                        ],
                                        borders: { top: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, bottom: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, left: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, right: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"} }, width: { size: 50, type: WidthType.PERCENTAGE }, verticalAlign: "bottom"
                                    }),
                                    new TableCell({
                                        children: [
                                            new Paragraph({ children: [new TextRun({ text: rightTitle, bold: true, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                            new Paragraph({ children: [new TextRun({ text: "(Ký, ghi rõ họ tên)", italics: true, size: 20, font: FONT_FAMILY })], alignment: AlignmentType.CENTER }),
                                            new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), 
                                            new Paragraph({ children: [new TextRun({ text: sig.approverName || '', bold: true, size: SIZE_SMALL, font: FONT_FAMILY })], alignment: AlignmentType.CENTER })
                                        ],
                                        borders: { top: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, bottom: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, left: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"}, right: {style: BorderStyle.NONE, size: 0, color: "FFFFFF"} }, width: { size: 50, type: WidthType.PERCENTAGE }, verticalAlign: "top"
                                    })
                                ]
                            })
                        ],
                        width: { size: 100, type: WidthType.PERCENTAGE }
                    }));

                    const doc = new Document({ sections: [{ properties: { page: { margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 } } }, children: children }] });
                    const blob = await Packer.toBlob(doc);
                    saveAs(blob, `KeHoachDiBien_${state.currentDateKey}.docx`);
                    utils.showToast('Xuất file thành công', 'success');
                } catch (e) {
                    utils.showToast('Lỗi: ' + e.message, 'error');
                } finally {
                    utils.toggleLoader(false);
                }
            };
        
        // Expose to app scope for button click
        app.clientSideExportDocx = clientSideExportDocx;

        // --- EDIT MODAL LOGIC ---
        const editModal = {
            currentPersonId: null,
            
            open: async (personId) => {
                utils.toggleLoader(true, "Đang tải...");
                editModal.currentPersonId = personId;
                
                try {
                    const doc = await db.collection('artifacts').doc(appId)
                        .collection('dailyPlans').doc(state.currentDateKey)
                        .collection('people').doc(personId).get();
                    
                    if(!doc.exists) throw new Error("Không tìm thấy nhân sự");
                    const p = doc.data();

                    // Fill Fields
                    document.getElementById('edit_staffNo').value = p.staffNo || '';
                    document.getElementById('edit_fullName').value = p.fullName || '';
                    document.getElementById('edit_title').value = p.title || '';
                    document.getElementById('edit_orgName').value = p.orgName || '';
                    document.getElementById('edit_dob').value = p.dob || '';
                    document.getElementById('edit_pob').value = p.pob || '';
                    document.getElementById('edit_phone').value = p.phone || '';
                    document.getElementById('edit_idNo').value = p.idNo || '';
                    document.getElementById('edit_idIssueDate').value = p.idIssueDate || '';
                    document.getElementById('edit_idExpiryDate').value = p.idExpiryDate || '';
                    document.getElementById('edit_weightKg').value = p.weightKg || '';
                    document.getElementById('edit_luggageKg').value = p.luggageKg || '';
                    document.getElementById('edit_cargoKg').value = p.cargoKg || '';
                    document.getElementById('edit_rowNote').value = p.rowNote || '';
                    
                    // Advanced
                    document.getElementById('edit_destination').value = p.destination || '';
                    document.getElementById('edit_nvsxNo').value = p.nvsxNo || '';
                    document.getElementById('edit_taskDesc').value = p.taskDesc || '';

                    document.getElementById('editPersonModal').classList.remove('hidden');
                    document.getElementById('editPersonModal').classList.add('flex');
                } catch(e) {
                    utils.showToast(e.message, "error");
                } finally {
                    utils.toggleLoader(false);
                }
            },
            
            close: () => {
                document.getElementById('editPersonModal').classList.add('hidden');
                document.getElementById('editPersonModal').classList.remove('flex');
            },
            
            save: async () => {
                if(!editModal.currentPersonId) return;
                utils.toggleLoader(true, "Đang lưu...");
                
                const updatedData = {
                    staffNo: document.getElementById('edit_staffNo').value,
                    fullName: document.getElementById('edit_fullName').value,
                    title: document.getElementById('edit_title').value,
                    dob: document.getElementById('edit_dob').value,
                    pob: document.getElementById('edit_pob').value,
                    phone: document.getElementById('edit_phone').value,
                    idNo: document.getElementById('edit_idNo').value,
                    idIssueDate: document.getElementById('edit_idIssueDate').value,
                    idExpiryDate: document.getElementById('edit_idExpiryDate').value,
                    weightKg: Number(document.getElementById('edit_weightKg').value),
                    luggageKg: Number(document.getElementById('edit_luggageKg').value),
                    cargoKg: Number(document.getElementById('edit_cargoKg').value),
                    rowNote: document.getElementById('edit_rowNote').value,
                    
                    destination: document.getElementById('edit_destination').value,
                    nvsxNo: document.getElementById('edit_nvsxNo').value,
                    taskDesc: document.getElementById('edit_taskDesc').value,
                    
                    updatedBy: state.currentUser.email,
                    updatedAt: new Date()
                };

                // Re-validate Warnings
                const warnings = [];
                if(updatedData.idExpiryDate) {
                    const parts = updatedData.idExpiryDate.split('/');
                    if(parts.length === 3) {
                        const [d,m,y] = parts.map(Number);
                        const expDate = new Date(y, m-1, d);
                        const diffTime = expDate - new Date();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if(diffDays <= 60) warnings.push('CCCD sắp/đã hết hạn');
                        updatedData.isIdExpiring = true;
                    }
                }
                updatedData.warnings = warnings;

                try {
                    await db.collection('artifacts').doc(appId)
                        .collection('dailyPlans').doc(state.currentDateKey)
                        .collection('people').doc(editModal.currentPersonId).update(updatedData);
                    
                    utils.showToast("Đã cập nhật thông tin", "success");
                    editModal.close();
                    await app.loadPlan();
                } catch(e) {
                    console.error(e);
                    utils.showToast("Lỗi khi lưu: " + e.message, "error");
                } finally {
                    utils.toggleLoader(false);
                }
            }
        };

        app.init();
    </script>
</body>
</html>
