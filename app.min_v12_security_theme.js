const firebaseConfig = {
          apiKey: "AIzaSyDBdfswGWEefQR8Djscm2hkaKsi0438ODQ",
          authDomain: "webshop-japan.firebaseapp.com",
          projectId: "webshop-japan",
          storageBucket: "webshop-japan.firebasestorage.app",
          messagingSenderId: "854451712478",
          appId: "1:854451712478:web:d55198786d10a9b98d2d4f"
        };
        
// --- Template BayDi (embedded) ---
const TEMPLATE_BAYDI_BASE64 = "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";
const __b64ToU8 = (b64) => {
    const bin = atob(b64);
    const len = bin.length;
    const u8 = new Uint8Array(len);
    for (let i = 0; i < len; i++) u8[i] = bin.charCodeAt(i);
    return u8;
};
const __u8ToArrayBuffer = (u8) => u8.buffer.slice(u8.byteOffset, u8.byteOffset + u8.byteLength);
const appId = 'xnxl-offshore'; 
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        const state = {
            currentUser: null,
            userRole: null, 
            userOrgId: null,
            currentDateKey: new Date().toISOString().split('T')[0].replace(/-/g, ''),
            orgs: [],
            isPlanLocked: false,
            currentPlanPeople: [],
            unsubscribePlan: null,
            users: [],
            quickSearch: ''
        };

        const utils = {
            formatDate: (dateStr) => { if(!dateStr || dateStr.length !== 8) return dateStr || ''; return `${dateStr.substr(6,2)}/${dateStr.substr(4,2)}/${dateStr.substr(0,4)}`; },
			formatPlanIdHeader: (planId, fallback = '') => {
				if (!planId) return fallback || '';
				const s = String(planId).trim();
				// YYYYMMDD
				if (/^\d{8}$/.test(s)) return `${s.slice(6,8)}.${s.slice(4,6)}.${s.slice(0,4)}`;
				// YYYY-MM-DD
				if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [y,m,d] = s.split('-'); return `${d}.${m}.${y}`; }
				// DD/MM/YYYY
				if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) { const [d,m,y] = s.split('/'); return `${d}.${m}.${y}`; }
				return s || (fallback || '');
			},
            formatDateTime: (dateObj) => { if(!dateObj) return ''; const d = new Date(dateObj); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')} ${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`; },
            formatTimeShort: (dateObj) => { if(!dateObj) return ''; const d = new Date(dateObj); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`; },
            processExcelDate: (input) => {
                if (!input) return '';
                if (input instanceof Date) {
                    if (!isNaN(input.getTime())) {
                        return `${String(input.getDate()).padStart(2,'0')}/${String(input.getMonth()+1).padStart(2,'0')}/${input.getFullYear()}`;
                    }
                }
                if (typeof input === 'number') {
                    const date = new Date(Math.round((input - 25569) * 86400 * 1000));
                    if (!isNaN(date.getTime())) return `${String(date.getDate()).padStart(2,'0')}/${String(date.getMonth()+1).padStart(2,'0')}/${date.getFullYear()}`;
                }
                const str = String(input).trim();
                const parts = str.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
                if (parts) return `${parts[1].padStart(2,'0')}/${parts[2].padStart(2,'0')}/${parts[3]}`;
                return str;
            },
            showToast: (msg, type = 'info') => {
                const el = document.getElementById('toast');
                const colors = type === 'error' ? 'bg-red-500' : 'bg-emerald-600';
                const icon = type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' : '<i class="fas fa-check-circle"></i>';
                el.className = `fixed top-6 right-6 z-[70] px-6 py-4 rounded-lg shadow-xl text-white font-medium transform transition-all duration-300 translate-y-0 opacity-100 flex items-center gap-3 ${colors}`;
                el.innerHTML = `${icon} <span>${msg}</span>`;
                el.classList.remove('hidden');
                setTimeout(() => { el.classList.add('opacity-0', '-translate-y-2'); setTimeout(() => el.classList.add('hidden', 'opacity-100', 'translate-y-0'), 300); }, 3000);
            },
            toggleLoader: (show, text) => {
                const el = document.getElementById('loadingOverlay');
                if(text) document.getElementById('loadingText').innerText = text;
                show ? el.classList.remove('hidden') : el.classList.add('hidden');
            },
            cleanString: (str) => (str || '').toString().trim(),

            // --- NVSX / Task aggregation (dedupe & smart merge) ---
            splitNvsxTokens: (val) => {
                if (!val) return [];
                return String(val)
                    .replace(/\r/g, '')
                    .split(/[\n;,]+/g)
                    .map(s => s.trim())
                    .filter(Boolean);
            },
            aggregateGroupNvsxAndTasks: (group) => {
                const nvsxOrder = [];
                const seenN = new Set();
                const taskMap = new Map(); // code -> Set(desc)
                const misc = new Set();

                (group || []).forEach(p => {
                    // 1) NVSX tokens from field
                    utils.splitNvsxTokens(p?.nvsxNo).forEach(code => {
                        const c = code.trim();
                        if (!c || seenN.has(c)) return;
                        seenN.add(c);
                        nvsxOrder.push(c);
                    });

                    // 2) Task lines
                    const raw = (p?.taskDesc || '').toString().replace(/\r/g, '');
                    if (!raw) return;
                    raw.split('\n').forEach(line => {
                        const l = (line || '').trim();
                        if (!l) return;

                        // Try parse "CODE: description" or "CODE - description"
                        let m = l.match(/^(\d{3}-\d{2}(?:bs\d+)?)\s*:\s*(.+)$/i);
                        if (!m) m = l.match(/^([0-9A-Za-z][0-9A-Za-z\-\/.]*)\s*:\s*(.+)$/);
                        if (!m) m = l.match(/^([0-9A-Za-z][0-9A-Za-z\-\/.]*)\s*-\s*(.+)$/);
                        if (m) {
                            const code = (m[1] || '').trim();
                            const desc = (m[2] || '').trim();
                            if (!code || !desc) return;

                            if (!taskMap.has(code)) taskMap.set(code, new Set());
                            taskMap.get(code).add(desc);
                        } else {
                            misc.add(l);
                        }
                    });
                });

                // Merge codes: NVSX order first, then codes only from taskMap
                const codesOnlyInTask = [...taskMap.keys()].filter(c => !seenN.has(c)).sort();
                const mergedCodes = [...nvsxOrder, ...codesOnlyInTask];

                // Build NVSX string
                const nvsxStr = mergedCodes.filter(Boolean).join('; ');

                // Build task lines (dedupe)
                const taskLines = [];
                mergedCodes.forEach(code => {
                    if (!taskMap.has(code)) return;
                    const descs = [...taskMap.get(code)];
                    if (descs.length === 1) taskLines.push(`${code}: ${descs[0]}`);
                    else taskLines.push(`${code}: ${descs.join(' / ')}`);
                });

                // Add misc lines (dedupe)
                [...misc].forEach(l => taskLines.push(l));

                return { nvsxStr: nvsxStr || '', taskLines };
            }
            ,
            normalizeNvsxInput: (val) => {
                // Accept separators: ';' ',' newline
                const tokens = utils.splitNvsxTokens(val);
                // Preserve original order but dedupe
                const seen = new Set();
                const out = [];
                tokens.forEach(t => { if (!seen.has(t)) { seen.add(t); out.push(t); } });
                return out.join('; ');
            },
            normalizeTaskText: (val) => {
                if (val == null) return '';
                return String(val).replace(/\r/g, '').trim();
            },
            normalizeDestinationKey: (dest) => {
                const raw = (dest ?? '').toString().trim();
                if (!raw) return '';
                const n = raw.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/\s+/g, ' ').trim();
                if (n === 'chua xac dinh') return '';
                return raw;
            },
            destinationDisplay: (dest) => {
                const key = utils.normalizeDestinationKey(dest);
                return key || 'Cha xc nh';
            },
            getGroupFinalMeta: (group) => {
                // Single source of truth = latest updated record (usually after Admin "Sa gin/NVSX/CV").
                // If no updatedAt, fall back to createdAt/importedAt ordering. If still missing, fall back to union aggregation.
                const pickTime = (p) => {
                    const t = p?.updatedAt || p?.createdAt || p?.importedAt || p?.importTime || null;
                    try {
                        if (!t) return 0;
                        if (t instanceof Date) return t.getTime();
                        if (typeof t === 'number') return t;
                        if (typeof t === 'string') return Date.parse(t) || 0;
                        if (t?.toDate) return t.toDate().getTime();
                        if (t?.seconds) return (t.seconds * 1000) + Math.floor((t.nanoseconds||0)/1e6);
                    } catch(e) {}
                    return 0;
                };

                let latest = null;
                let latestTs = -1;
                (group || []).forEach(p => {
                    const ts = pickTime(p);
                    if (ts > latestTs) { latestTs = ts; latest = p; }
                });

                let nvsxStr = utils.normalizeNvsxInput(latest?.nvsxNo || '');
                let taskText = utils.normalizeTaskText(latest?.taskDesc || '');

                // If latest is empty, fall back to union aggregation so UI still shows something.
                if (!nvsxStr && !taskText) {
                    const agg = utils.aggregateGroupNvsxAndTasks(group || []);
                    nvsxStr = agg.nvsxStr || '';
                    taskText = (agg.taskLines || []).join('\n');
                }

                const taskLines = (taskText || '').replace(/\r/g,'').split('\n').map(s => s.trim()).filter(Boolean);

                // Consistency check: compare everyone vs final meta (after normalization)
                const finalN = utils.normalizeNvsxInput(nvsxStr);
                const finalT = utils.normalizeTaskText(taskText);

                let inconsistent = false;
                const seenN = new Set();
                const seenT = new Set();
                (group || []).forEach(p => {
                    const pn = utils.normalizeNvsxInput(p?.nvsxNo || '');
                    const pt = utils.normalizeTaskText(p?.taskDesc || '');
                    if (pn) seenN.add(pn);
                    if (pt) seenT.add(pt);
                    if ((pn && pn !== finalN) || (pt && pt !== finalT)) inconsistent = true;
                });

                return {
                    nvsxStr: finalN || '',
                    taskText: finalT || '',
                    taskLines,
                    inconsistent,
                    distinctNvsx: [...seenN],
                    distinctTasks: [...seenT]
                };
            }

        };


        
        const fileUtils = {
            downloadText: (filename, text, mime = 'text/plain;charset=utf-8') => {
                try {
                    const blob = new Blob([text], { type: mime });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                } catch (e) {
                    console.error('downloadText failed', e);
                    utils.showToast('Khng th ti file trn trnh duyt ny', 'error');
                }
            },
            toCSV: (rows) => {
                const esc = (v) => {
                    const s = String(v ?? '');
                    const needs = /[",\n\r]/.test(s);
                    const out = s.replace(/"/g, '""');
                    return needs ? `"${out}"` : out;
                };
                return rows.map(r => r.map(esc).join(',')).join('\n');
            }
        };

// GLOBAL SAFETY NET (prevent hard crashes; show friendly error)
        window.addEventListener('error', (event) => {
            try {
                const msg = event?.error?.message || event?.message || 'Li khng xc nh';
                console.error('GlobalError:', event?.error || event);
                utils.showToast('C li xy ra: ' + msg, 'error');
            } catch (e) {
                console.error('GlobalErrorHandlerFailed:', e);
            }
        });

        window.addEventListener('unhandledrejection', (event) => {
            try {
                const msg = event?.reason?.message || String(event?.reason || 'Li Promise khng xc nh');
                console.error('UnhandledRejection:', event?.reason || event);
                utils.showToast('C li xy ra: ' + msg, 'error');
            } catch (e) {
                console.error('UnhandledRejectionHandlerFailed:', e);
            }
        });

        const getPublicColl = (name) => db.collection('artifacts').doc(appId).collection('public').doc('data').collection(name);

        const audit = {
            _lastPruneAt: 0,
            _pruneIntervalMs: 30 * 60 * 1000, // throttle: ti a 1 ln / 30 pht
            _pruneTimer: null,

            async log(action, details = {}) {
                try {
                    if (!state.currentUser) return;
                    const payload = {
                        action,
                        dateKey: state.currentDateKey || '',
                        user: state.currentUser.email || '',
                        role: state.userRole || '',
                        orgId: state.userOrgId || '',
                        createdAt: new Date(),
                        details: details || {}
                    };
                    await getPublicColl('auditLogs').add(payload);

                    // T ng dn nht k (ch dispatcher/admin c quyn delete)
                    this.schedulePrune();
                } catch (e) {
                    // Do not break main flow if logging fails
                    console.warn('AuditLogFailed:', e);
                }
            },

            schedulePrune(force = false) {
                try {
                    if (state.userRole !== 'dispatcher') return;
                    const now = Date.now();
                    if (!force && now - this._lastPruneAt < this._pruneIntervalMs) return;
                    this._lastPruneAt = now;

                    // Debounce nh  trnh dn lin tc khi import nhiu thao tc
                    if (this._pruneTimer) clearTimeout(this._pruneTimer);
                    this._pruneTimer = setTimeout(() => {
                        this.prune().catch(e => console.warn('AuditPruneFailed:', e));
                    }, 1200);
                } catch (e) {
                    console.warn('AuditSchedulePruneFailed:', e);
                }
            },

            async prune() {
                if (state.userRole !== 'dispatcher') return;

                const coll = getPublicColl('auditLogs');
                const cutoff = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000); // ch gi ti a 7 ngy gn nht

                // 1) Xa mi log c hn 7 ngy
                while (true) {
                    const snap = await coll
                        .where('createdAt', '<', cutoff)
                        .orderBy('createdAt', 'asc')
                        .limit(450)
                        .get();

                    if (snap.empty) break;

                    const batch = db.batch();
                    snap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                }

                // 2) Gi ti a 200 log gn nht
                const keepSnap = await coll.orderBy('createdAt', 'desc').limit(200).get();
                if (keepSnap.empty) return;

                const lastKeepDoc = keepSnap.docs[keepSnap.docs.length - 1];

                // Nu cn log c hn v tr 200 th xa tip theo l
                while (true) {
                    const extraSnap = await coll
                        .orderBy('createdAt', 'desc')
                        .startAfter(lastKeepDoc)
                        .limit(450)
                        .get();

                    if (extraSnap.empty) break;

                    const batch = db.batch();
                    extraSnap.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();
                }
            }
        };

        const warningCenter = {
            open() {
                try {
                    const dateVal = document.getElementById('planDateInput')?.value || '';
                    document.getElementById('warningDateLabel').innerText = dateVal ? dateVal.split('-').reverse().join('/') : (state.currentDateKey || '--');

                    const list = (state.currentPlanPeople || []).filter(p => Array.isArray(p.warnings) && p.warnings.length > 0);
                    document.getElementById('warningCountLabel').innerText = list.length;

                    // Summary chips by warning type
                    const freq = {};
                    list.forEach(p => (p.warnings || []).forEach(w => { freq[w] = (freq[w] || 0) + 1; }));
                    const summary = Object.keys(freq).sort((a,b)=>freq[b]-freq[a]).map(k => {
                        return `<span class="bg-red-50 text-red-700 border border-red-100 px-2 py-1 rounded-full text-[11px] font-bold">${k}: ${freq[k]}</span>`;
                    }).join('');
                    document.getElementById('warningSummary').innerHTML = summary || '<span class="text-slate-400 italic text-sm">Khng c cnh bo.</span>';

                    warningCenter._all = list;
                    document.getElementById('warningSearch').value = '';
                    warningCenter.render();

                    const modal = document.getElementById('warningModal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');

                    // live search
                    document.getElementById('warningSearch').oninput = () => warningCenter.render();
                } catch (e) {
                    console.error(e);
                    utils.showToast('Khng m c danh sch cnh bo: ' + e.message, 'error');
                }
            },
            close() {
                const modal = document.getElementById('warningModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            },
            render() {
                const q = (document.getElementById('warningSearch').value || '').toLowerCase().trim();
                const rows = (warningCenter._all || []).filter(p => {
                    if (!q) return true;
                    const hay = [
                        p.fullName, p.staffNo, p.orgName, p.destination,
                        ...(p.warnings || [])
                    ].join(' ').toLowerCase();
                    return hay.includes(q);
                });

                const tb = document.getElementById('warningTableBody');
                if (rows.length === 0) {
                    tb.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-slate-400 italic">Khng c kt qu</td></tr>`;
                    return;
                }
                tb.innerHTML = rows.map((p, idx) => `
                    <tr>
                        <td class="px-3 py-2 text-center text-slate-500 font-mono">${idx + 1}</td>
                        <td class="px-3 py-2 font-semibold text-slate-800">${p.fullName || ''}</td>
                        <td class="px-3 py-2 text-center text-slate-700 font-mono">${p.staffNo || ''}</td>
                        <td class="px-3 py-2 text-slate-600">${p.orgName || ''}</td>
                        <td class="px-3 py-2 font-bold text-blue-700">${p.destination || ''}</td>
                        <td class="px-3 py-2 text-red-700">${(p.warnings || []).join('; ')}</td>
                    </tr>
                `).join('');
            },
            exportCSV() {
                try {
                    const rows = (warningCenter._all || []).map(p => [
                        state.currentDateKey,
                        p.destination || '',
                        p.orgName || '',
                        p.fullName || '',
                        p.staffNo || '',
                        (p.warnings || []).join('; ')
                    ]);
                    const header = ['Ngay', 'Gian', 'DonVi', 'HoTen', 'DanhSo', 'CanhBao'];
                    const csv = fileUtils.toCSV([header, ...rows]);
                    fileUtils.downloadText(`canhbao_${state.currentDateKey || 'ngay'}.csv`, csv, 'text/csv;charset=utf-8');
                } catch (e) {
                    console.error(e);
                    utils.showToast('Xut CSV tht bi: ' + e.message, 'error');
                }
            }
        };

        const auditModal = {
            _cache: [],
            _page: 1,
            _pageSize: 10,
            open() {
                if (state.userRole !== 'dispatcher') return utils.showToast('Ch Admin mi xem c nht k', 'error');
                const el = document.getElementById('auditModal');
                el.classList.remove('hidden');
                el.classList.add('flex');
                // Wire inputs
                document.getElementById('auditSearch').oninput = () => { auditModal._page = 1; auditModal.render(); };
                document.getElementById('auditActionFilter').onchange = () => { auditModal._page = 1; auditModal.render(); };
                const prevBtn = document.getElementById('auditPrevBtn');
                const nextBtn = document.getElementById('auditNextBtn');
                if (prevBtn) prevBtn.onclick = () => { auditModal._page = Math.max(1, (auditModal._page || 1) - 1); auditModal.render(); };
                if (nextBtn) nextBtn.onclick = () => { auditModal._page = (auditModal._page || 1) + 1; auditModal.render(); };
                if (auditModal._cache.length === 0) auditModal.refresh();
                else auditModal.render();
            },
            close() {
                const el = document.getElementById('auditModal');
                el.classList.add('hidden');
                el.classList.remove('flex');
            },
            async refresh() {
                utils.toggleLoader(true, 'ang ti nht k...');
                try {
                    // Dispatcher/Admin: m nht k s t dn (gi 200 dng & ti a 7 ngy)
                    audit.schedulePrune(true);

                    const snap = await getPublicColl('auditLogs').orderBy('createdAt', 'desc').limit(200).get();
                    auditModal._cache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    auditModal._page = 1;
                    auditModal.render();
                } catch (e) {
                    console.error(e);
                    utils.showToast('Khng ti c nht k: ' + e.message, 'error');
                } finally {
                    utils.toggleLoader(false);
                }
            },
            _fmt(ts) {
                try {
                    if (!ts) return '';
                    const d = ts.seconds ? new Date(ts.seconds * 1000) : new Date(ts);
                    return utils.formatDateTime(d);
                } catch { return ''; }
            },
            _actionLabel(a) {
                const map = {
                    ADD_PERSON: 'Thm nhn s',
                    UPDATE_PERSON: 'Sa nhn s',
                    DELETE_PERSON: 'Xa nhn s',
                    DELETE_ALL: 'Xa ton b',
                    IMPORT: 'Import',
                    GROUP_EDIT: 'Sa gin/NVSX/CV',
                    LOCK_TOGGLE: 'Kha/M ngy',
                    EXPORT_DOCX: 'Export Word',
                    EXPORT_BAYDI: 'Export Template BayDi'};
                return map[a] || a || '';
            },

render() {
    const q = (document.getElementById('auditSearch').value || '').toLowerCase().trim();
    const act = document.getElementById('auditActionFilter').value || '';
    const all = (auditModal._cache || []).filter(r => {
        if (act && r.action !== act) return false;
        if (!q) return true;
        const hay = [
            r.user,
            r.action,
            r.dateKey,
            JSON.stringify(r.details || {})
        ].join(' ').toLowerCase();
        return hay.includes(q);
    });

    const total = all.length;
    const pageSize = auditModal._pageSize || 10;
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    auditModal._page = Math.min(Math.max(1, auditModal._page || 1), totalPages);

    const startIdx = (auditModal._page - 1) * pageSize;
    const endIdx = Math.min(startIdx + pageSize, total);
    const pageRows = all.slice(startIdx, endIdx);

    // Update paging UI
    const rangeEl = document.getElementById('auditRange');
    const totalEl = document.getElementById('auditTotal');
    const pageEl = document.getElementById('auditPageLabel');
    const prevBtn = document.getElementById('auditPrevBtn');
    const nextBtn = document.getElementById('auditNextBtn');

    if (rangeEl) rangeEl.textContent = total === 0 ? '0-0' : `${startIdx + 1}-${endIdx}`;
    if (totalEl) totalEl.textContent = String(total);
    if (pageEl) pageEl.textContent = `Trang ${auditModal._page}/${totalPages}`;
    if (prevBtn) {
        prevBtn.disabled = auditModal._page <= 1;
        prevBtn.classList.toggle('opacity-50', prevBtn.disabled);
    }
    if (nextBtn) {
        nextBtn.disabled = auditModal._page >= totalPages;
        nextBtn.classList.toggle('opacity-50', nextBtn.disabled);
    }

    const tb = document.getElementById('auditTableBody');
    if (total === 0) {
        tb.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-slate-400 italic">Khng c d liu</td></tr>`;
        return;
    }

    tb.innerHTML = pageRows.map(r => {
        const details = r.details || {};
        const detailText = auditModal._prettyDetails(details);
        return `
            <tr>
                <td class="px-3 py-2 text-slate-600 font-mono">${auditModal._fmt(r.createdAt)}</td>
                <td class="px-3 py-2 text-slate-700">${r.user || ''}</td>
                <td class="px-3 py-2 font-bold text-blue-700">${auditModal._actionLabel(r.action)}</td>
                <td class="px-3 py-2 text-slate-600 font-mono">${r.dateKey || ''}</td>
                <td class="px-3 py-2 text-slate-600">${detailText}</td>
            </tr>
        `;
    }).join('');
},
            _prettyDetails(details) {
                try {
                    // Keep details short and readable
                    const parts = [];
                    if (details.destination) parts.push(`Gin: <b>${details.destination}</b>`);
                    if (details.staffNo || details.fullName) parts.push(`NS: <b>${details.fullName || ''}</b> <span class="text-slate-400 font-mono">${details.staffNo || ''}</span>`);
                    if (typeof details.count === 'number') parts.push(`SL: <b>${details.count}</b>`);
                    if (details.status) parts.push(`Trng thi: <b>${details.status}</b>`);
                    if (details.nvsxNo) parts.push(`NVSX: <b>${details.nvsxNo}</b>`);
                    if (details.reason) parts.push(`L do: <span class="text-slate-500">${details.reason}</span>`);
                    if (parts.length > 0) return parts.join('  ');
                    // fallback (trim)
                    const s = JSON.stringify(details);
                    return s.length > 180 ? s.slice(0, 180) + '' : s;
                } catch {
                    return '';
                }
            },
            exportCSV() {
                try {
                    const header = ['ThoiGian', 'User', 'HanhDong', 'Ngay', 'ChiTiet'];
                    const rows = (auditModal._cache || []).map(r => [
                        auditModal._fmt(r.createdAt),
                        r.user || '',
                        r.action || '',
                        r.dateKey || '',
                        JSON.stringify(r.details || {})
                    ]);
                    const csv = fileUtils.toCSV([header, ...rows]);
                    fileUtils.downloadText(`nhatky_${(new Date()).toISOString().slice(0,10)}.csv`, csv, 'text/csv;charset=utf-8');
                } catch (e) {
                    console.error(e);
                    utils.showToast('Xut CSV tht bi: ' + e.message, 'error');
                }
            }
        };

        const masterDataManager = {
            saveToMaster: (people) => {
                const batch = db.batch();
                let count = 0;
                people.forEach(p => {
                    if (p.staffNo) {
                        const ref = getPublicColl('masterData').doc(p.staffNo);
                        const data = {
                            staffNo: p.staffNo, fullName: p.fullName, title: p.title, orgName: p.orgName,
                            dob: p.dob, pob: p.pob, phone: p.phone, idNo: p.idNo,
                            idIssueDate: p.idIssueDate, idExpiryDate: p.idExpiryDate,
                            weightKg: p.weightKg, luggageKg: p.luggageKg, cargoKg: p.cargoKg,
                            lastUpdated: new Date()
                        };
                        batch.set(ref, data, { merge: true });
                        count++;
                    }
                });
                if (count > 0) batch.commit().catch(console.error);
            },
            autoFill: async (staffNo) => {
                if (!staffNo) return;
                utils.toggleLoader(true, "ang tra cu...");
                try {
                    const doc = await getPublicColl('masterData').doc(staffNo.trim()).get();
                    if (doc.exists) {
                        const d = doc.data();
                        document.getElementById('edit_fullName').value = d.fullName || '';
                        document.getElementById('edit_title').value = d.title || '';
                        
                        // CHANGE: Only populate orgName if user is Dispatcher/Admin
                        if (state.userRole === 'dispatcher') {
                            document.getElementById('edit_orgName').value = d.orgName || '';
                        }
                        
                        document.getElementById('edit_dob').value = d.dob || '';
                        document.getElementById('edit_pob').value = d.pob || '';
                        document.getElementById('edit_phone').value = d.phone || '';
                        document.getElementById('edit_idNo').value = d.idNo || '';
                        document.getElementById('edit_idIssueDate').value = d.idIssueDate || '';
                        document.getElementById('edit_idExpiryDate').value = d.idExpiryDate || '';
                        document.getElementById('edit_weightKg').value = d.weightKg || '';
                        document.getElementById('edit_luggageKg').value = d.luggageKg || '';
                        document.getElementById('edit_cargoKg').value = d.cargoKg || '';
                        utils.showToast(" tm thy thng tin nhn s", "success");
                        // NEW: Show destinations when user is found/searching
                        document.getElementById('advEdit').classList.remove('hidden');
                        editModal.renderDestinationSuggestions();
                    } else {
                        utils.showToast("Khng tm thy trong h s", "error");
                    }
                } catch (e) { console.error(e); utils.showToast("Li: " + e.message, "error"); } finally { utils.toggleLoader(false); }
            }
        };

        const conflictChecker = {
            check: (newPeople, currentPeople, isEditId = null) => {
                const conflicts = [];
                newPeople.forEach(np => {
                    const found = currentPeople.find(cp => {
                        if (isEditId && cp.id === isEditId) return false;
                        return (np.staffNo && cp.staffNo === np.staffNo) || (np.idNo && cp.idNo === np.idNo);
                    });
                    if (found) {
                        conflicts.push({
                            new: np,
                            current: found,
                            msg: `Nhn s ${np.fullName} (DS: ${np.staffNo})  c tn trong danh sch i ${found.destination}`
                        });
                    }
                });
                return conflicts;
            }
        };

        const reportManager = {
            selectedDates: [],
            mode: 'days', // 'days', 'month', 'year'
            
            open: () => {
                document.getElementById('reportModal').classList.remove('hidden');
                document.getElementById('reportModal').classList.add('flex');
                
                // Init View
                reportManager.setMode('days');
                
                // Populate Year Select
                const yearSelect = document.getElementById('rptYearInput');
                yearSelect.innerHTML = '';
                const currentYear = new Date().getFullYear();
                for (let y = currentYear; y >= 2024; y--) {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.text = `Nm ${y}`;
                    yearSelect.appendChild(opt);
                }
                
                // Pre-fill Today
                const todayStr = document.getElementById('planDateInput').value;
                if(todayStr) {
                     document.getElementById('rptDateInput').value = todayStr;
                     document.getElementById('rptMonthInput').value = todayStr.substring(0, 7);
                }
            },
            
            close: () => {
                document.getElementById('reportModal').classList.add('hidden');
                document.getElementById('reportModal').classList.remove('flex');
            },
            
            setMode: (mode) => {
                reportManager.mode = mode;
                // UI Toggle
                ['days', 'month', 'year'].forEach(m => {
                    const btn = document.getElementById(`rptMode${m.charAt(0).toUpperCase() + m.slice(1)}`);
                    if(m === mode) {
                        btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition bg-white shadow text-purple-700";
                    } else {
                        btn.className = "flex-1 py-1.5 text-xs font-bold rounded-md transition text-slate-500 hover:text-slate-800";
                    }
                });
                
                document.getElementById('rptDaysView').classList.toggle('hidden', mode !== 'days');
                document.getElementById('rptMonthView').classList.toggle('hidden', mode !== 'month');
                document.getElementById('rptYearView').classList.toggle('hidden', mode !== 'year');
            },
            
            addDate: () => {
                const val = document.getElementById('rptDateInput').value;
                if(val && !reportManager.selectedDates.includes(val)) {
                    reportManager.selectedDates.push(val);
                    reportManager.renderDateList();
                }
            },
            
            removeDate: (val) => {
                reportManager.selectedDates = reportManager.selectedDates.filter(d => d !== val);
                reportManager.renderDateList();
            },
            
            renderDateList: () => {
                const ul = document.getElementById('rptDateList');
                ul.innerHTML = reportManager.selectedDates.map(d => {
                    const [y,m,day] = d.split('-');
                    return `<li class="flex justify-between items-center bg-white p-1.5 rounded border border-slate-200 text-xs">
                        <span class="font-bold text-slate-700">${day}/${m}/${y}</span>
                        <button onclick="reportManager.removeDate('${d}')" class="text-red-500 hover:text-red-700 font-bold px-2">&times;</button>
                    </li>`;
                }).join('');
            },
            
            generateDateRange: () => {
                if (reportManager.mode === 'days') return reportManager.selectedDates;
                
                let start, end;
                if (reportManager.mode === 'month') {
                    const mVal = document.getElementById('rptMonthInput').value; // YYYY-MM
                    if(!mVal) return [];
                    const [y, m] = mVal.split('-');
                    start = new Date(y, m-1, 1);
                    end = new Date(y, m, 0);
                } else if (reportManager.mode === 'year') {
                    const yVal = document.getElementById('rptYearInput').value;
                    start = new Date(yVal, 0, 1);
                    end = new Date(yVal, 11, 31);
                }
                
                const dates = [];
                for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                    const mm = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    const yyyy = d.getFullYear();
                    dates.push(`${yyyy}-${mm}-${dd}`);
                }
                return dates;
            },
            
            processReport: async () => {
                const dates = reportManager.generateDateRange();
                if (dates.length === 0) return utils.showToast('Vui lng chn thi gian', 'error');
                
                // Show Progress
                const pContainer = document.getElementById('rptProgress');
                const pBar = document.getElementById('rptProgressBar');
                const pText = document.getElementById('rptProgressPct');
                
                pContainer.classList.remove('hidden');
                
                let allPeople = [];
                const chunkSize = 5; // Batch 5 days per request to avoid hitting limits too hard
                
                try {
                    for (let i = 0; i < dates.length; i += chunkSize) {
                        const batchDates = dates.slice(i, i + chunkSize);
                        const promises = batchDates.map(async dateStr => {
                            const dateKey = dateStr.replace(/-/g, '');
                            const snap = await getPublicColl('dailyPlans').doc(dateKey).collection('people').get();
                            // Inject Date Info and sortable date
                            const [y, m, d] = dateStr.split('-');
                            return snap.docs.map(doc => ({
                                ...doc.data(), 
                                _reportDate: `${d}/${m}/${y}`,
                                _sortDate: dateStr // YYYY-MM-DD for sorting
                            }));
                        });
                        
                        const batchResults = await Promise.all(promises);
                        allPeople = allPeople.concat(batchResults.flat());
                        
                        // Update Progress
                        const pct = Math.round(((i + batchDates.length) / dates.length) * 100);
                        pBar.style.width = `${pct}%`;
                        pText.innerText = `${pct}%`;
                    }
                    
                    if(allPeople.length === 0) {
                         utils.showToast("Khng c d liu trong khong thi gian ny", "warning");
                         pContainer.classList.add('hidden');
                         return;
                    }
                    
                    // Generate Excel
                    reportManager.exportToExcel(allPeople);
                    
                } catch(e) {
                    console.error(e);
                    utils.showToast("Li ti d liu: " + e.message, "error");
                } finally {
                     pContainer.classList.add('hidden');
                     pBar.style.width = '0%';
                }
            },
            
            exportToExcel: (data) => {
                if (typeof XLSX === 'undefined') {
                    utils.showToast('Khng ti c th vin Excel (XLSX). Hy kim tra kt ni internet/CDN.', 'error');
                    return;
                }

                // Sort by Date, then Destination, then orderIndex (ng theo th t ko th/import)
                data.sort((a,b) => {
                    const ai = Number.isFinite(+a.orderIndex) ? +a.orderIndex : 999999999;
                    const bi = Number.isFinite(+b.orderIndex) ? +b.orderIndex : 999999999;
                    return String(a._sortDate||'').localeCompare(String(b._sortDate||''))
                        || String(a.destination||'').localeCompare(String(b.destination||''))
                        || (ai - bi)
                        || String(a.orgName||'').localeCompare(String(b.orgName||''))
                        || String(a.fullName||'').localeCompare(String(b.fullName||''))
                        || String(a.staffNo||'').localeCompare(String(b.staffNo||''));
                });



                const exportData = data.map((p, idx) => ({
                    "STT": idx + 1,
                    "Ngy ng k": p._reportDate,
                    "n v": p.orgName,
                    "Danh s": p.staffNo,
                    "H v tn": p.fullName,
                    "Chc danh": p.title,
                    "Ni n": p.destination,
                    "Trng lng (Kg)": p.weightKg,
                    "Hnh l (Kg)": p.luggageKg,
                    "Hng ha (Kg)": p.cargoKg,
                    "Ghi ch": p.rowNote
                }));
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Auto-width
                const wscols = [
                    {wch: 5}, {wch: 12}, {wch: 20}, {wch: 10}, {wch: 25}, 
                    {wch: 20}, {wch: 15}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 20}
                ];
                ws['!cols'] = wscols;

                XLSX.utils.book_append_sheet(wb, ws, "Bo Co");
                (function(){
  const filename = `BaoCao_${new Date().getTime()}.xlsx`;
  // Default report export stays as .xlsx (do not force .xls here)
  try {
    XLSX.writeFile(wb, filename, { bookType: 'xlsx', compression: true });
  } catch (e) {
    // Fallback for bundles that don't support writeFile options
    XLSX.writeFile(wb, filename);
  }
})();
                
                utils.showToast(" ti xung file Excel", "success");
                reportManager.close();
            }
        };

        const userModal = {
            open: (userId = null) => {
                const titleEl = document.getElementById('userModalTitle');
                if (userId) {
                    // Edit Mode
                    const user = state.users.find(u => u.id === userId);
                    if (!user) return;
                    document.getElementById('u_id').value = userId;
                    document.getElementById('u_email').value = user.email;
                    document.getElementById('u_email').disabled = true;
                    document.getElementById('u_email').classList.add('bg-gray-100');
                    document.getElementById('u_passwordWrapper').classList.add('hidden');
                    document.getElementById('u_name').value = user.displayName || '';
                    document.getElementById('u_role').value = user.role;
                    titleEl.innerText = "Sa thng tin User";
                } else {
                    // Create Mode
                    document.getElementById('u_id').value = '';
                    document.getElementById('u_email').value = '';
                    document.getElementById('u_email').disabled = false;
                    document.getElementById('u_email').classList.remove('bg-gray-100');
                    document.getElementById('u_password').value = '';
                    document.getElementById('u_passwordWrapper').classList.remove('hidden');
                    document.getElementById('u_name').value = '';
                    document.getElementById('u_role').value = 'workshop';
                    titleEl.innerText = "Thm User Mi";
                }
                userModal.toggleOrgSelect();
                // Set org based on edit data or default
                if (userId) {
                    const user = state.users.find(u => u.id === userId);
                    if (user && user.role !== 'dispatcher') {
                         document.getElementById('u_orgId').value = user.orgId;
                    }
                }
                document.getElementById('userModal').classList.remove('hidden'); 
                document.getElementById('userModal').classList.add('flex');
            },
            close: () => { 
                document.getElementById('userModal').classList.add('hidden'); 
                document.getElementById('userModal').classList.remove('flex'); 
            },
            toggleOrgSelect: () => {
                const role = document.getElementById('u_role').value;
                document.getElementById('u_orgWrapper').classList.toggle('hidden', role === 'dispatcher');
            },
            save: () => {
                const uid = document.getElementById('u_id').value;
                if (uid) {
                    userManager.updateUser(uid);
                } else {
                    userManager.createUser();
                }
            }
        };

        const userManager = {
            loadUsers: async () => {
                const snap = await db.collection('artifacts').doc(appId).collection('users').get();
                state.users = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
                document.getElementById('userListBody').innerHTML = state.users.map(u => {
                    const roleBadge = u.role === 'dispatcher' ? '<span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-bold">Admin</span>' : '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-bold">User</span>';
                    return `<tr class="hover:bg-slate-50">
                        <td class="px-4 py-2">${u.email}</td>
                        <td class="px-4 py-2 font-medium">${u.displayName || '-'}</td>
                        <td class="px-4 py-2">${roleBadge}</td>
                        <td class="px-4 py-2 text-slate-500">${u.orgId || 'XNXL'}</td>
                        <td class="px-4 py-2 text-right">
                            <button onclick="userModal.open('${u.id}')" class="text-slate-500 hover:text-blue-600 mr-2" title="Sa"><i class="fas fa-edit"></i></button>
                            <button onclick="userManager.sendResetEmail('${u.email}')" class="text-blue-600 hover:text-blue-800 text-xs font-bold mr-2">Reset Pass</button>
                            <button onclick="userManager.deleteUserDoc('${u.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }).join('');
            },
            createUser: async () => {
                const email = document.getElementById('u_email').value.trim();
                const password = document.getElementById('u_password').value.trim();
                const name = document.getElementById('u_name').value.trim();
                const role = document.getElementById('u_role').value;
                const orgId = role === 'dispatcher' ? 'XNXL' : document.getElementById('u_orgId').value;
                if(!email || !password || !name) return utils.showToast('Vui lng in  thng tin', 'error');
                utils.toggleLoader(true, 'ang to user...');
                try {
                    const secondaryApp = firebase.initializeApp(firebaseConfig, "Secondary");
                    const userCred = await secondaryApp.auth().createUserWithEmailAndPassword(email, password);
                    await db.collection('artifacts').doc(appId).collection('users').doc(userCred.user.uid).set({ email, role, orgId, displayName: name, createdAt: new Date() });
                    await secondaryApp.delete();
                    utils.showToast(` to user ${email}`, 'success'); userModal.close(); userManager.loadUsers();
                } catch (e) { utils.showToast(e.message, 'error'); } finally { utils.toggleLoader(false); }
            },
            updateUser: async (uid) => {
                const name = document.getElementById('u_name').value.trim();
                const role = document.getElementById('u_role').value;
                const orgId = role === 'dispatcher' ? 'XNXL' : document.getElementById('u_orgId').value;
                
                utils.toggleLoader(true, 'ang cp nht...');
                try {
                    await db.collection('artifacts').doc(appId).collection('users').doc(uid).update({
                        displayName: name,
                        role: role,
                        orgId: orgId
                    });
                    utils.showToast(' cp nht thng tin user', 'success');
                    userModal.close();
                    userManager.loadUsers();
                } catch(e) {
                    utils.showToast(e.message, 'error');
                } finally {
                    utils.toggleLoader(false);
                }
            },
            sendResetEmail: async (email) => { if(confirm(`Gi email t li mt khu cho ${email}?`)) auth.sendPasswordResetEmail(email).then(() => utils.showToast(' gi email reset pass', 'success')).catch(e => utils.showToast(e.message, 'error')); },
            deleteUserDoc: async (uid) => { if(confirm('Xa user ny?')) db.collection('artifacts').doc(appId).collection('users').doc(uid).delete().then(() => { utils.showToast(' xa profile', 'success'); userManager.loadUsers(); }).catch(e => utils.showToast(e.message, 'error')); }
        };

        const importModal = {
            parsedData: null,
            getSelectedOrgName: () => {
                try {
                    if (state.userRole === 'dispatcher') {
                        const sel = document.getElementById('importOrgSelect');
                        return sel && sel.selectedIndex >= 0 ? (sel.options[sel.selectedIndex].text || '') : '';
                    }
                    const found = state.orgs.find(o => o.id === state.userOrgId);
                    return found ? found.name : (state.userOrgId || '');
                } catch (e) { return ''; }
            },


            _escapeReg: (s) => (s || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
            _splitDestination: (dest) => {
                const raw = (dest || '').trim();
                if (!raw) return { type: 'TU', name: '' };
                const up = raw.toUpperCase();
                if (up.startsWith('GIN ')) return { type: 'GIN', name: raw.slice(5).trim() };
                if (up === 'GIN') return { type: 'GIN', name: '' };
                if (up.startsWith('TU ')) return { type: 'TU', name: raw.slice(4).trim() };
                if (up === 'TU') return { type: 'TU', name: '' };
                // fallback: treat whole as name
                return { type: 'TU', name: raw };
            },
            _setDestinationUI: (dest) => {
                try {
                    const { type, name } = importModal._splitDestination(dest);
                    const sel = document.getElementById('prevDestType');
                    const nameIn = document.getElementById('prevDestNameInput');
                    const hidden = document.getElementById('prevDestInput');
                    if (sel) sel.value = type || 'TU';
                    if (nameIn) nameIn.value = name || '';
                    const combined = ((sel ? sel.value : (type || 'TU')) + ' ' + (nameIn ? nameIn.value : (name || ''))).trim();
                    if (hidden) hidden.value = (nameIn && nameIn.value.trim()) ? combined : '';
                } catch (e) { }
            },
            _getDestinationUI: () => {
                try {
                    const sel = document.getElementById('prevDestType');
                    const nameIn = document.getElementById('prevDestNameInput');
                    const hidden = document.getElementById('prevDestInput');
                    // Backward compatible: if old UI exists
                    if (!sel || !nameIn) {
                        return (document.getElementById('prevDestInput')?.value || '').trim();
                    }
                    const type = (sel.value || 'TU').trim();
                    const name = (nameIn.value || '').trim();
                    const combined = (type + ' ' + name).trim();
                    if (hidden) hidden.value = name ? combined : '';
                    return name ? combined : '';
                } catch (e) {
                    return (document.getElementById('prevDestInput')?.value || '').trim();
                }
            },
            _isValidDDMMYYYY: (s) => {
                const t = (s || '').trim();
                const m = /^([0-2]?\d|3[01])\/(0?\d|1[0-2])\/(\d{4})$/.exec(t);
                if (!m) return false;
                const d = parseInt(m[1], 10), mo = parseInt(m[2], 10), y = parseInt(m[3], 10);
                const dt = new Date(y, mo - 1, d);
                return dt.getFullYear() === y && (dt.getMonth() + 1) === mo && dt.getDate() === d;
            },
            _parseNVSXList: (s) => {
                const raw = (s || '').trim();
                if (!raw) return [];
                // enforce ';' delimiter (no commas)
                const hasComma = /,/.test(raw);
                if (hasComma) return null;
                return raw.split(';').map(x => x.trim()).filter(Boolean);
            },
            _validateMetaStrict: (date, destination, nvsxStr, taskStr) => {
                const dateOk = importModal._isValidDDMMYYYY(date);
                if (!dateOk) return { ok: false, msg: 'Ngy K phi ng nh dng dd/mm/yyyy (VD: 28/12/2025).', focus: 'prevDateInput' };

                if (!destination) return { ok: false, msg: 'Bt buc nhp Ni n (GIN/TU + a im).', focus: 'prevDestNameInput' };

                const list = importModal._parseNVSXList(nvsxStr);
                if (list === null) return { ok: false, msg: 'NVSX phi cch nhau bi du ; (khng dng du ,). VD: 001-25; 002-25', focus: 'prevNVSXInput' };

                // Task validation: if user provided NVSX, each NVSX must appear as a line prefix in task.
                const task = (taskStr || '').replace(/\r/g,'').trim();
                if (list && list.length) {
                    if (!task) return { ok: false, msg: 'Cng vic bt buc nhp theo cu trc: mi NVSX 1 dng (VD: 001-25: ...).', focus: 'prevTaskInput' };
                    // each NVSX must exist
                    for (const code of list) {
                        const rx = new RegExp('^' + importModal._escapeReg(code) + '\\s*[:]', 'mi');
                        if (!rx.test(task)) {
                            return { ok: false, msg: `Cng vic thiu dng cho NVSX "${code}". Mu: ${code}: ni dung...`, focus: 'prevTaskInput' };
                        }
                    }
                    // every non-empty line must start with a known NVSX
                    const known = new Set(list.map(x => x.toUpperCase()));
                    const lines = task.split('\n').map(x => x.trim()).filter(Boolean);
                    for (const ln of lines) {
                        const mm = /^([^:]+)\s*[:]/.exec(ln);
                        if (!mm) return { ok: false, msg: 'Cng vic sai cu trc. Mi dng phi theo mu: NVSX: ni dung', focus: 'prevTaskInput' };
                        const code = (mm[1] || '').trim().toUpperCase();
                        if (!known.has(code)) return { ok: false, msg: `Cng vic c dng NVSX khng nm trong danh sch: "${mm[1]}".`, focus: 'prevTaskInput' };
                    }
                }
                return { ok: true };
            },

            mode: 'excel',
            _formInited: false,
            switchMode: (mode) => {
                try {
                    importModal.mode = mode || 'excel';
                    const tabExcel = document.getElementById('impTabExcel');
                    const tabForm = document.getElementById('impTabForm');
                    const setTab = (btn, active) => {
                        if (!btn) return;
                        btn.className = active
                            ? 'px-3 py-1.5 rounded-lg text-xs font-bold bg-emerald-600 text-white shadow-sm'
                            : 'px-3 py-1.5 rounded-lg text-xs font-bold bg-white border border-slate-200 text-slate-700 hover:bg-slate-100';
                    };
                    setTab(tabExcel, importModal.mode === 'excel');
                    setTab(tabForm, importModal.mode === 'form');

                    const drop = document.getElementById('excelDropzoneWrap');
                    const meta = document.getElementById('parseMeta');
                    const prevPeople = document.getElementById('parsePeopleWrap');
                    const formWrap = document.getElementById('formPeopleWrap');
                    const btn = document.getElementById('btnConfirmImport');
                    const warn = document.getElementById('prevWarning');

                    if (importModal.mode === 'form') {
                        if (drop) drop.classList.add('hidden');
                        if (prevPeople) prevPeople.classList.add('hidden');
                        if (meta) meta.classList.remove('hidden');
                        if (formWrap) formWrap.classList.remove('hidden');
                        if (warn) warn.classList.add('hidden');
                        importModal.parsedData = { date: '', destination: '', nvsx: '', task: '', people: [] };
                        importModal._initFormUI();
                        importModal._prefillFormDate();
                        importModal._updateFormCount();
                    } else {
                        if (drop) drop.classList.remove('hidden');
                        if (formWrap) formWrap.classList.add('hidden');
                        if (meta) meta.classList.add('hidden');
                        if (prevPeople) prevPeople.classList.add('hidden');
                        if (btn) btn.disabled = true;
                        if (warn) warn.classList.add('hidden');
                        importModal.parsedData = null;
                        const countEl = document.getElementById('prevCount');
                        if (countEl) countEl.innerText = '0';
                    }
                } catch (e) { }
            },
            _prefillFormDate: () => {
                try {
                    const selectedDate = document.getElementById('planDateInput')?.value;
                    const dateIn = document.getElementById('prevDateInput');
                    if (selectedDate && dateIn && !dateIn.value.trim()) {
                        const [y, m, d] = selectedDate.split('-');
                        dateIn.value = `${d}/${m}/${y}`;
                    }
                } catch (e) { }
            },
            _initFormUI: () => {
                if (importModal._formInited) return;
                importModal._formInited = true;

                const paste = document.getElementById('formPasteBox');
                if (paste && !paste._boundPaste) {
                    paste.addEventListener('paste', () => {
                        setTimeout(() => {
                            const txt = paste.value || '';
                            if (txt.trim()) {
                                importModal._applyPastedTable(txt);
                                paste.value = '';
                            }
                        }, 0);
                    });
                    paste._boundPaste = true;
                }

                const body = document.getElementById('formPeopleBody');
                if (body && !body._boundInput) {
                    body.addEventListener('input', () => importModal._updateFormCount());
                    body._boundInput = true;
                }

                importModal.ensureFormRows(12);
            },
            ensureFormRows: (minRows) => {
                const body = document.getElementById('formPeopleBody');
                if (!body) return;
                const cur = body.querySelectorAll('tr').length;
                const need = Math.max(0, (minRows || 0) - cur);
                for (let i = 0; i < need; i++) importModal.addFormRow(1, true);
            },
            addFormRow: (count = 1, silent = false) => {
                const body = document.getElementById('formPeopleBody');
                if (!body) return;
                const n = Math.max(1, parseInt(count || 1, 10));
                const mkInput = (k, ph = '') => `<input data-k="${k}" type="text" placeholder="${ph}" class="w-full border border-slate-200 rounded px-2 py-1 text-xs bg-white focus:ring-1 focus:ring-blue-500 outline-none" />`;
                const mkNum = (k, ph = '0') => `<input data-k="${k}" type="number" step="0.1" placeholder="${ph}" class="w-full border border-slate-200 rounded px-2 py-1 text-xs bg-white focus:ring-1 focus:ring-blue-500 outline-none" />`;

                for (let i = 0; i < n; i++) {
                    const idx = body.querySelectorAll('tr').length + 1;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-2 py-1 text-slate-500 w-10">${idx}</td>
                        <td class="px-2 py-1 w-28">${mkInput('staffNo', 'Danh s')}</td>
                        <td class="px-2 py-1 min-w-[180px]">${mkInput('fullName', 'H v tn')}</td>
                        <td class="px-2 py-1 w-40">${mkInput('title', 'Chc danh')}</td>
                        <td class="px-2 py-1 w-24">${mkInput('dob', 'dd/mm/yyyy')}</td>
                        <td class="px-2 py-1 min-w-[120px]">${mkInput('pob', 'Ni sinh')}</td>
                        <td class="px-2 py-1 w-28">${mkInput('phone', 'ST')}</td>
                        <td class="px-2 py-1 w-36">${mkInput('idNo', 'CCCD/CMND')}</td>
                        <td class="px-2 py-1 w-24">${mkInput('idIssueDate', 'dd/mm/yyyy')}</td>
                        <td class="px-2 py-1 w-24">${mkInput('idExpiryDate', 'dd/mm/yyyy')}</td>
                        <td class="px-2 py-1 w-20">${mkNum('weightKg', 'Kg')}</td>
                        <td class="px-2 py-1 w-20">${mkNum('luggageKg', 'Kg')}</td>
                        <td class="px-2 py-1 w-20">${mkNum('cargoKg', 'Kg')}</td>
                        <td class="px-2 py-1 w-24">${mkInput('rowNote', '')}</td>
                        <td class="px-2 py-1 w-10 text-center">
                            <button type="button" onclick="importModal.removeFormRow(this)" class="text-slate-400 hover:text-red-600 font-bold" title="Xa dng">&times;</button>
                        </td>
                    `;
                    body.appendChild(tr);
                }
                importModal._renumberFormRows();
                if (!silent) importModal._updateFormCount();
            },
            removeFormRow: (btn) => {
                try {
                    const tr = btn && btn.closest ? btn.closest('tr') : null;
                    if (tr) tr.remove();
                    importModal._renumberFormRows();
                    importModal._updateFormCount();
                } catch (e) { }
            },
            clearFormRows: () => {
                const body = document.getElementById('formPeopleBody');
                if (body) body.innerHTML = '';
                importModal.addFormRow(12, true);
                importModal._updateFormCount();
            },
            _renumberFormRows: () => {
                const body = document.getElementById('formPeopleBody');
                if (!body) return;
                [...body.querySelectorAll('tr')].forEach((tr, i) => {
                    const td = tr.querySelector('td');
                    if (td) td.textContent = String(i + 1);
                });
            },
            _applyPastedTable: (txt) => {
                try {
                    const lines = String(txt || '').replace(/\r/g, '').split('\n').map(l => l.trim()).filter(Boolean);
                    if (lines.length === 0) return;
                    const rows = lines.map(line => line.split('\t').map(c => String(c || '').trim()));
                    const norm = rows.map(cols => {
                        if (cols.length >= 13 && /^\d+$/.test(cols[0] || '')) cols = cols.slice(1);
                        return cols;
                    });

                    const body = document.getElementById('formPeopleBody');
                    if (!body) return;

                    const existing = [...body.querySelectorAll('tr')];
                    let startIndex = existing.findIndex(tr => {
                        const s = tr.querySelector('[data-k="staffNo"]')?.value?.trim();
                        const n = tr.querySelector('[data-k="fullName"]')?.value?.trim();
                        return !(s || n);
                    });
                    if (startIndex < 0) startIndex = existing.length;

                    const needTotal = startIndex + norm.length;
                    importModal.ensureFormRows(needTotal);

                    const all = [...body.querySelectorAll('tr')];
                    norm.forEach((cols, ridx) => {
                        const tr = all[startIndex + ridx];
                        if (!tr) return;
                        const get = (i) => cols[i] !== undefined ? cols[i] : '';
                        const set = (k, v) => { const el = tr.querySelector(`[data-k="${k}"]`); if (el) el.value = v; };

                        set('staffNo', get(0));
                        set('fullName', get(1));
                        set('title', get(2));
                        set('dob', get(3));
                        set('pob', get(4));
                        set('phone', get(5));
                        set('idNo', get(6));
                        set('idIssueDate', get(7));
                        set('idExpiryDate', get(8));
                        set('weightKg', get(9));
                        set('luggageKg', get(10));
                        set('cargoKg', get(11));
                        set('rowNote', get(12));
                    });

                    importModal._updateFormCount();
                } catch (e) {
                    utils.showToast('Dn d liu khng hp l.', 'error');
                }
            },
            buildFromForm: () => {
                const body = document.getElementById('formPeopleBody');
                const people = [];
                if (body) {
                    [...body.querySelectorAll('tr')].forEach(tr => {
                        const val = (k) => (tr.querySelector(`[data-k="${k}"]`)?.value || '').trim();
                        const staffNo = utils.cleanString(val('staffNo'));
                        const fullName = utils.cleanString(val('fullName'));
                        if (!staffNo && !fullName) return;

                        people.push({
                            staffNo,
                            fullName,
                            title: utils.cleanString(val('title')),
                            orgName: '',
                            dob: utils.cleanString(val('dob')),
                            pob: utils.cleanString(val('pob')),
                            phone: utils.cleanString(val('phone')),
                            idNo: utils.cleanString(val('idNo')),
                            idIssueDate: utils.cleanString(val('idIssueDate')),
                            idExpiryDate: utils.cleanString(val('idExpiryDate')),
                            weightKg: parseFloat(val('weightKg')) || 0,
                            luggageKg: parseFloat(val('luggageKg')) || 0,
                            cargoKg: parseFloat(val('cargoKg')) || 0,
                            rowNote: utils.cleanString(val('rowNote'))
                        });
                    });
                }
                importModal.parsedData = importModal.parsedData || {};
                importModal.parsedData.people = people;
                return importModal.parsedData;
            },
            _updateFormCount: () => {
                try {
                    if (importModal.mode !== 'form') return;
                    const data = importModal.buildFromForm();
                    const count = (data.people || []).length;
                    const countEl = document.getElementById('prevCount');
                    if (countEl) countEl.innerText = String(count);
                    const btn = document.getElementById('btnConfirmImport');
                    if (btn) btn.disabled = count === 0;
                } catch (e) { }
            },

            open: () => {
                document.getElementById('excelFile').value = ''; document.getElementById('fileNameDisplay').innerText = ''; document.getElementById('prevDateInput').value=''; importModal._setDestinationUI(''); document.getElementById('prevNVSXInput').value=''; document.getElementById('prevTaskInput').value='';
                document.getElementById('parseMeta').classList.add('hidden'); document.getElementById('parsePeopleWrap').classList.add('hidden'); document.getElementById('btnConfirmImport').disabled = true;
                document.getElementById('importModal').classList.remove('hidden'); document.getElementById('importModal').classList.add('flex'); const sel = document.getElementById('importOrgSelect'); if(sel && !sel._boundChange){ sel.addEventListener('change', ()=>{ if(importModal.parsedData){ importModal.renderPeoplePreview(importModal.parsedData.people);} }); sel._boundChange=true; } const destName=document.getElementById('prevDestNameInput'); const destType=document.getElementById('prevDestType'); const clearErr=()=>{ (destName||document.getElementById('prevDestInput'))?.classList.remove('border-red-400'); importModal._getDestinationUI(); }; if(destName && !destName._boundInput){ destName.addEventListener('input', clearErr); destName._boundInput=true; } if(destType && !destType._boundChange){ destType.addEventListener('change', clearErr); destType._boundChange=true; }
                const dateIn=document.getElementById('prevDateInput'); if(dateIn && !dateIn._boundInput){ dateIn.addEventListener('input', ()=>{ const sel=document.getElementById('planDateInput')?.value; if(sel){ const [y,m,d]=sel.split('-'); const expect=`${d}/${m}/${y}`; const w=document.getElementById('prevWarning'); if(w){ if(dateIn.value.trim() && dateIn.value.trim()!==expect){ w.classList.remove('hidden'); w.title=`File: ${dateIn.value} khc Ngy ang chn`; } else { w.classList.add('hidden'); } } } }); dateIn._boundInput=true; }
                importModal.switchMode('excel');
            },
            close: () => { document.getElementById('importModal').classList.add('hidden'); document.getElementById('importModal').classList.remove('flex'); },
            handleFile: async (e) => {
                const file = e.target.files[0]; if(!file) return;
                document.getElementById('fileNameDisplay').innerText = file.name; utils.toggleLoader(true, 'ang phn tch file Excel...');
                try {
                    const data = await importModal.parseExcel(file); importModal.parsedData = data;
                    document.getElementById('prevDateInput').value = data.date || ''; importModal._setDestinationUI(data.destination || ''); (document.getElementById('prevDestNameInput') || document.getElementById('prevDestInput')).classList.toggle('border-red-400', !(data.destination||'').trim());
                    document.getElementById('prevNVSXInput').value = data.nvsx || ''; document.getElementById('prevTaskInput').value = data.task || '';
                    document.getElementById('prevCount').innerText = data.people.length;
                    importModal.renderPeoplePreview(data.people);

                    const selectedDate = document.getElementById('planDateInput').value; const [y, m, d] = selectedDate.split('-');
                    if(data.date && data.date !== `${d}/${m}/${y}`) { document.getElementById('prevWarning').classList.remove('hidden'); document.getElementById('prevWarning').title = `File: ${data.date} khc Ngy ang chn`; }
                    else document.getElementById('prevWarning').classList.add('hidden');
                    document.getElementById('parseMeta').classList.remove('hidden'); document.getElementById('parsePeopleWrap').classList.remove('hidden'); document.getElementById('btnConfirmImport').disabled = data.people.length === 0;
                } catch (err) { utils.showToast('Li c file: ' + err.message, 'error'); } finally { utils.toggleLoader(false); }
            },
            
            renderPeoplePreview: (people) => {
                const tbody = document.getElementById('prevPeopleBody');
                const more = document.getElementById('prevPeopleMore');
                if (!tbody) return;
                const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
                const max = 300;
                const sorted = (people || []).slice(); // gi ng th t trong Excel
                const slice = sorted.slice(0, max);
                tbody.innerHTML = slice.map((p, i) => `
                    <tr>
                        <td class="px-3 py-2 text-slate-500">${i + 1}</td>
                        <td class="px-3 py-2 font-semibold text-slate-800">${esc(p.staffNo || '')}</td>
                        <td class="px-3 py-2 text-slate-800">${esc(p.fullName || '')}</td>
                        <td class="px-3 py-2 text-slate-600">${esc(p.title || '')}</td>
                        <td class="px-3 py-2 text-slate-500">${esc(importModal.getSelectedOrgName() || p.orgName || '')}</td>
                    </tr>
                `).join('');
                if (more) {
                    if (sorted.length > max) {
                        more.classList.remove('hidden');
                        more.textContent = `Hin th ${max}/${people.length} ngi (danh sch qu di). Vn c th Import y .`;
                    } else {
                        more.classList.add('hidden');
                        more.textContent = '';
                    }
                }
            },parseExcel: (file) => {
                return new Promise((resolve, reject) => {
                    if (typeof XLSX === 'undefined') {
                        reject(new Error('Khng ti c th vin Excel (XLSX). Hy kim tra kt ni internet/CDN.'));
                        return;
                    }

                    const reader = new FileReader();
                    reader.onerror = () => reject(new Error('Khng c c file Excel. Vui lng th li hoc chn file khc.'));
                    reader.onload = (e) => {
                        try {
                            const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            const rows = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: ''});
                            let date = '', destination = '', nvsx = '', task = '', headerRowIndex = -1;

                            // Prefer fixed cells for "Mu K i bin - Form mi" when present
                            const __cellVal = (addr) => {
                                try {
                                    const c = sheet && sheet[addr];
                                    if (!c) return '';
                                    return (c.v !== undefined ? c.v : (c.w !== undefined ? c.w : ''));
                                } catch (e) { return ''; }
                            };
                            const __d6 = __cellVal('D6');
                            if (__d6 && !date) date = utils.processExcelDate(__d6) || '';
                            const __d7 = __cellVal('D7');
                            const __e7 = __cellVal('E7');
                            if (!destination && (__d7 || __e7)) {
                                destination = [__d7, __e7].map(v => (v ?? '').toString().trim()).filter(Boolean).join(' ').replace(/\s+/g,' ').trim();
                            }
                            const __d8 = __cellVal('D8');
                            if (__d8 && !nvsx) nvsx = __d8.toString().trim();
                            const __d9 = __cellVal('D9');
                            if (__d9 && !task) task = __d9.toString().replace(/\r/g,'').trim();

                            
                            // Extract Meta (robust, supports Form c & Form mi)
                            const __normCell = (v) => {
                                try {
                                    if (v === undefined || v === null) return '';
                                    return v.toString().trim().toLowerCase()
                                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                                        .replace(/\s+/g, ' ');
                                } catch (e) { return ''; }
                            };
                            const __isEmpty = (v) => v === undefined || v === null || (typeof v === 'string' && v.trim() === '');
                            const __skipTokens = new Set(['gian','gin','tau','tu','t\\u00e0u','form','rev','don vi','\\u0111\\u01a1n vi','don v','\\u0111on vi']);
                            const __looksLikeDest = (v) => {
                                const s = (v ?? '').toString().trim();
                                if (!s) return false;
                                const up = s.toUpperCase();
                                // Common rig/ship codes: CTK-3, MSP-9, BK-14, etc.
                                return /^(CTK|MSP|BK|BKP|CT|TB|TD|GT|GIA?N|TAU|T\\u00c0U)[\\s\\-]*\\d+/i.test(up) || /\\b(CTK|MSP|BK)[\\s\\-]*\\d+\\b/i.test(up);
                            };
                            const __findRightValue = (ri, ci) => {
                                const row = rows[ri] || [];
                                const parts = [];
                                for (let k = ci + 1; k < row.length; k++) {
                                    const v = row[k];
                                    if (__isEmpty(v)) continue;
                                    const ns = __normCell(v);
                                    if (!ns) continue;
                                    if (__skipTokens.has(ns)) continue;
                                    if (typeof v === 'string' && __normCell(v).endsWith(':')) continue;
                                    parts.push(v.toString().trim());
                                    // if next cell looks like something else, stop; otherwise allow join of 2 cells (e.g. "GIN" + "CTK-3")
                                    if (parts.length >= 1) break;
                                }
                                if (parts.length) return parts.join(' ').replace(/\s+/g,' ').trim();
                                return null;
                            };
                            const __findByLabel = (keywords) => {
                                for (let i = 0; i < Math.min(rows.length, 80); i++) {
                                    const row = rows[i] || [];
                                    for (let j = 0; j < row.length; j++) {
                                        const cell = row[j];
                                        const sc = __normCell(cell);
                                        if (!sc) continue;
                                        if (keywords.some(k => sc.includes(k))) {
                                            const right = __findRightValue(i, j);
                                            if (right) return right;
                                            // If label & value are in same cell (rare)
                                            if (typeof cell === 'string') {
                                                const pos = cell.indexOf(':');
                                                if (pos > -1) {
                                                    const after = cell.slice(pos + 1).trim();
                                                    if (after) return after;
                                                }
                                            }
                                            // Fallback: search nearby cells (right/down within 2 rows)
                                            for (let di = 0; di <= 2; di++) {
                                                const rr = rows[i + di] || [];
                                                for (let dj = 1; dj <= 4; dj++) {
                                                    const v = rr[j + dj];
                                                    if (__isEmpty(v)) continue;
                                                    const ns = __normCell(v);
                                                    if (__skipTokens.has(ns)) continue;
                                                    return v;
                                                }
                                            }
                                        }
                                    }
                                }
                                return null;
                            };

                            // Date
                            if (!date) {
                            const __dateVal = __findByLabel(['dang ky di bien ngay','dang ky ngay','ngay dk','ngay dang ky','ngay di','ngay khoi hanh']);
                            if (__dateVal) {
                                date = utils.processExcelDate(__dateVal) || '';
                                if (!date && typeof __dateVal === 'string') {
                                    const dm = __dateVal.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
                                    if (dm) {
                                        const y = (dm[3].length === 2) ? ('20' + dm[3]) : dm[3];
                                        date = `${dm[1].padStart(2,'0')}/${dm[2].padStart(2,'0')}/${y}`;
                                    }
                                }
                            }
                            
                            }
// Destination
                            if (!destination) {
                            let __destVal = __findByLabel(['noi den','di den','noi den gian','noi den tau','noi den:']);
                            // Special case: destination may appear after a "GIN"/"TU" token
                            if (__destVal && __skipTokens.has(__normCell(__destVal))) __destVal = null;
                            if (!__destVal) {
                                // Fallback: scan first 20 rows for a likely destination code
                                for (let i = 0; i < Math.min(rows.length, 20) && !__destVal; i++) {
                                    for (let j = 0; j < (rows[i] || []).length; j++) {
                                        const v = rows[i][j];
                                        if (__isEmpty(v)) continue;
                                        if (typeof v === 'string' && __looksLikeDest(v)) { __destVal = v; break; }
                                    }
                                }
                            }
                            if (__destVal) destination = __destVal.toString().trim().replace(/\s+/g,' ');

                            
                            }
// NVSX
                            if (!nvsx) {
                            const __nvsxVal = __findByLabel(['nhiem vu san xuat so','nhiem vu sx so','nhiem vu san xuat','nvsx']);
                            if (__nvsxVal) {
                                const val = __nvsxVal.toString().trim();
                                const m = val.match(/\d{3}-\d{2}(?:bs\d+)?/gi);
                                nvsx = m ? [...new Set(m.map(x => x.toUpperCase()))].join('; ') : val.replace(/^.*:\s*/, '');
                            } else {
                                // Fallback: scan first 30 rows for NVSX tokens
                                const found = [];
                                for (let i = 0; i < Math.min(rows.length, 30); i++) {
                                    for (let j = 0; j < (rows[i] || []).length; j++) {
                                        const v = rows[i][j];
                                        if (__isEmpty(v)) continue;
                                        const str = v.toString();
                                        const m = str.match(/\d{3}-\d{2}(?:bs\d+)?/gi);
                                        if (m) found.push(...m);
                                    }
                                }
                                const uniq = [...new Set(found.map(x => x.toUpperCase()))];
                                if (uniq.length) nvsx = uniq.join('; ');
                            }

                            
                            }
// Task / Work content
                            if (!task) {
                            const __taskVal = __findByLabel(['cong viec thuc hien','noi dung cong viec','noi dung nvsx','cong viec']);
                            if (__taskVal) {
                                let t = __taskVal.toString().replace(/\r/g,'').trim();
                                // Remove a leading label only if it actually starts with "cng vic..."
                                t = t.replace(/^\s*(cng vic thc hin|cng vic)\s*:?\s*/i, '');
                                task = t;
                            } else {
                                // Fallback: choose the longest multi-line cell containing NVSX-like lines
                                let best = '';
                                for (let i = 0; i < Math.min(rows.length, 35); i++) {
                                    for (let j = 0; j < (rows[i] || []).length; j++) {
                                        const v = rows[i][j];
                                        if (__isEmpty(v)) continue;
                                        const str = v.toString().replace(/\r/g,'');
                                        if (str.includes('\n') && /\d{3}-\d{2}.*:/i.test(str)) {
                                            if (str.length > best.length) best = str;
                                        }
                                    }
                                }
                                if (best) task = best.trim();
                            }

                            
                            }
// Find Header (robust)
                            const __normHeader = (v) => ((v === undefined || v === null) ? '' : v).toString().trim().toLowerCase()
                                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                                .replace(/\s+/g, ' ');
                            const __rowHas = (cells, keywords) => cells.some(c => keywords.some(k => c.includes(k)));
                            const __rowScore = (row) => {
                                const cells = (row || []).map(__normHeader).filter(Boolean);
                                if (cells.length === 0) return 0;
                                let score = 0;
                                if (__rowHas(cells, ['ho va ten','ho ten','ten','full name','fullname','name'])) score++;
                                if (__rowHas(cells, ['danh so','msnv','ma nv','ma so','staff no','staffno','employee','emp no'])) score++;
                                if (__rowHas(cells, ['don vi','xuong','org','department','bo phan'])) score++;
                                if (__rowHas(cells, ['chuc danh','chuc vu','position','title'])) score++;
                                if (__rowHas(cells, ['stt','no.','so tt'])) score++;
                                return score;
                            };

                            for (let i = 0; i < Math.min(rows.length, 80); i++) {
                                const sc = __rowScore(rows[i]);
                                // Require at least "H v tn" + one more important column
                                if (sc >= 2 && __rowHas((rows[i] || []).map(__normHeader), ['ho va ten','ho ten'])) {
                                    headerRowIndex = i;
                                    break;
                                }
                            }
                            if (headerRowIndex === -1) {
                                return reject(new Error("Khng tm thy dng tiu  bng. Hy kim tra file Excel c cc ct nh: 'H v tn', 'Danh s/MSNV', 'n v/Xng'..."));
                            }

                            const headers = rows[headerRowIndex].map(h => h.toString().toLowerCase().trim());
                            const colMap = {
                                staffNo: headers.findIndex(h => h.includes('danh s') || h.includes('msnv')),
                                fullName: headers.findIndex(h => h.includes('h v tn')),
                                title: headers.findIndex(h => h.includes('chc danh')),
                                org: headers.findIndex(h => h.includes('n v') || h.includes('xng')),
                                dob: headers.findIndex(h => h.includes('sinh') && !h.includes('ni')),
                                pob: headers.findIndex(h => h.includes('ni sinh')),
                                phone: headers.findIndex(h => h.includes('st')),
                                idNo: headers.findIndex(h => h.includes('cccd') || h.includes('cmnd')),
                                idIssue: headers.findIndex(h => h.includes('ngy cp')),
                                idExpiry: headers.findIndex(h => h.includes('ht hn')),
                                weight: headers.findIndex(h => h.includes('kg') || h.includes('cn nng')),
                                luggage: headers.findIndex(h => h.includes('hnh l')),
                                cargo: headers.findIndex(h => h.includes('hng ha')),
                                note: headers.findIndex(h => h.includes('ghi ch'))
                            };

                            const people = [];
                            for(let i = headerRowIndex + 1; i < rows.length; i++) {
                                const row = rows[i]; if(!row || !row[colMap.fullName]) continue;
                                const name = row[colMap.fullName].toString().trim();
                                if(!name || name.toLowerCase().includes('tng cng')) continue;
                                people.push({
                                    fullName: name,
                                    staffNo: colMap.staffNo > -1 ? utils.cleanString(row[colMap.staffNo]) : '',
                                    title: colMap.title > -1 ? utils.cleanString(row[colMap.title]) : '',
                                    orgName: colMap.org > -1 ? utils.cleanString(row[colMap.org]) : '',
                                    dob: colMap.dob > -1 ? utils.processExcelDate(row[colMap.dob]) : '',
                                    pob: colMap.pob > -1 ? utils.cleanString(row[colMap.pob]) : '',
                                    phone: colMap.phone > -1 ? utils.cleanString(row[colMap.phone]) : '',
                                    idNo: colMap.idNo > -1 ? utils.cleanString(row[colMap.idNo]) : '',
                                    idIssueDate: colMap.idIssue > -1 ? utils.processExcelDate(row[colMap.idIssue]) : '',
                                    idExpiryDate: colMap.idExpiry > -1 ? utils.processExcelDate(row[colMap.idExpiry]) : '',
                                    weightKg: colMap.weight > -1 ? (parseFloat(row[colMap.weight]) || 0) : 0,
                                    luggageKg: colMap.luggage > -1 ? (parseFloat(row[colMap.luggage]) || 0) : 0,
                                    cargoKg: colMap.cargo > -1 ? (parseFloat(row[colMap.cargo]) || 0) : 0,
                                    rowNote: colMap.note > -1 ? utils.cleanString(row[colMap.note]) : ''
                                });
                            }
                            resolve({ date, destination, nvsx, task, people });
                        } catch (err) { reject(err); }
                    };
                    reader.readAsArrayBuffer(file);
                });
            },
            processImport: async () => {
                if(importModal.mode==='form'){ importModal.parsedData = importModal.buildFromForm(); }
                if(!importModal.parsedData) return;
                
                const people = importModal.parsedData.people || [];
                const date = (document.getElementById('prevDateInput')?.value || '').trim();
                const destination = importModal._getDestinationUI();
                const nvsx = (document.getElementById('prevNVSXInput')?.value || '').trim();
                const task = (document.getElementById('prevTaskInput')?.value || '').replace(/\r/g,'').trim();
                const metaCheck = importModal._validateMetaStrict(date, destination, nvsx, task);
                if(!metaCheck.ok){ utils.showToast(metaCheck.msg, 'error'); (document.getElementById(metaCheck.focus) || document.getElementById('prevTaskInput'))?.focus(); return; }

                if(!destination){ utils.showToast('Bt buc nhp Ni n (Gin/Tu) trc khi Import.', 'error'); (document.getElementById('prevDestNameInput') || document.getElementById('prevDestInput'))?.focus(); return; }
                
                
                // 1. Identify Conflicts
                const conflictResults = conflictChecker.check(people, state.currentPlanPeople);
                const duplicateStaffNos = conflictResults.map(c => c.new.staffNo);
                
                // 2. Filter New People Only
                const newPeople = people.filter(p => !duplicateStaffNos.includes(p.staffNo));
                
                // 3. Always Show Result Modal (Success + Conflicts)
                const tbodySuccess = document.getElementById('successListBody');
                const tbodyConflict = document.getElementById('conflictListBody');
                
                // Render Success List
                tbodySuccess.innerHTML = newPeople.length > 0 ? newPeople.map(p => `
                    <tr>
                        <td class="px-4 py-2 font-medium text-emerald-800">${p.fullName}</td>
                        <td class="px-4 py-2 font-mono text-emerald-600">${p.staffNo}</td>
                        <td class="px-4 py-2 text-emerald-600">${p.title}</td>
                        <td class="px-4 py-2 text-emerald-600">${p.orgName || (state.userRole !== 'dispatcher' ? state.userOrgId : '')}</td>
                    </tr>
                `).join('') : `<tr><td colspan="4" class="px-4 py-4 text-center text-slate-400 italic">Khng c nhn s mi</td></tr>`;
                document.getElementById('successCount').innerText = newPeople.length;

                // Render Conflict List
                tbodyConflict.innerHTML = conflictResults.length > 0 ? conflictResults.map(c => {
                    const t = c.current.createdAt ? c.current.createdAt.seconds*1000 : Date.now();
                    const u = (c.current.importedBy || c.current.updatedBy || 'unknown').split('@')[0];
                    return `
                        <tr>
                            <td class="px-4 py-2 font-medium text-slate-800">${c.new.fullName}</td>
                            <td class="px-4 py-2 font-mono text-slate-600">${c.new.staffNo}</td>
                            <td class="px-4 py-2 font-bold text-blue-600">${c.current.destination}</td>
                            <td class="px-4 py-2 text-slate-500">${u}</td>
                            <td class="px-4 py-2 text-slate-400 text-[11px]">${utils.formatDateTime(new Date(t))}</td>
                        </tr>
                    `;
                }).join('') : `<tr><td colspan="5" class="px-4 py-4 text-center text-slate-400 italic">Khng c trng lp</td></tr>`;
                document.getElementById('conflictCount').innerText = conflictResults.length;

                // Show Modal
                document.getElementById('importResultModal').classList.remove('hidden');
                document.getElementById('importResultModal').classList.add('flex');
                
                // 4. Save New People (if any)
                if (newPeople.length > 0) {
                    utils.toggleLoader(true, 'ang lu...');
                    let defaultOrgId = state.userOrgId; let defaultOrgName = state.userOrgId;
                    if(state.userRole === 'dispatcher') {
                        const sel = document.getElementById('importOrgSelect'); defaultOrgId = sel.value; defaultOrgName = sel.options[sel.selectedIndex].text;
                    } else {
                        const found = state.orgs.find(o => o.id === defaultOrgId); if(found) defaultOrgName = found.name;
                    }

                    const batch = db.batch();
                    const collectionRef = getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people');
                    const planRef = getPublicColl('dailyPlans').doc(state.currentDateKey);
                    batch.set(planRef, { updatedAt: new Date(), status: state.isPlanLocked ? 'Locked' : 'Draft' }, { merge: true });

                    // OrderIndex: gi ng th t Excel (append sau danh sch hin c ca cng Gin)
                    let _baseOrder = 1;
                    try {
                        const dk = utils.destinationDisplay(destination || '');
                        const maxIdx = (state.currentPlanPeople || [])
                            .filter(pp => utils.destinationDisplay(pp.destination || '') === dk)
                            .reduce((m, pp) => {
                                const v = parseInt(pp.orderIndex, 10);
                                return Number.isFinite(v) ? Math.max(m, v) : m;
                            }, 0);
                        _baseOrder = maxIdx + 1;
                    } catch(e) { _baseOrder = 1; }

                    newPeople.forEach((p, idx) => {
                        const newRef = collectionRef.doc();
                const warnings = [];
                        if(!p.staffNo) warnings.push('Thiu danh s');
                        if(p.idExpiryDate) {
                             const parts = p.idExpiryDate.split(/[\/\-\.]/);
                             if(parts.length === 3) {
                                 const exp = new Date(parseInt(parts[2].length===2?'20'+parts[2]:parts[2]), parseInt(parts[1])-1, parseInt(parts[0]));
                                 const diff = Math.ceil((exp - new Date()) / (86400000));
                                 if(diff < 0) warnings.push('CCCD Ht hn'); else if(diff < 30) warnings.push('CCCD sp ht hn');
                             }
                        }
                        
                        // CHANGE: Force defaultOrgName for non-dispatcher users even if Excel has value
                        const finalOrgName = defaultOrgName;
                        
                        batch.set(newRef, {
                            ...p, orgName: finalOrgName, dkDate: date || '', destination: destination || '', nvsxNo: utils.normalizeNvsxInput(nvsx || ''), taskDesc: utils.normalizeTaskText(task || ''),
                            orgId: defaultOrgId, orderIndex: _baseOrder + idx, warnings, createdAt: new Date(), importedBy: state.currentUser.email
                        });
                    });

                    try {
                        await batch.commit();
                        audit.log('IMPORT', { count: newPeople.length, destination: destination || '', nvsxNo: nvsx || '', reason: (importModal.mode==='form' ? 'import_form' : 'import_excel') });
                        masterDataManager.saveToMaster(newPeople); 
                        utils.showToast(` import xong`, 'success');
                        importModal.close();
                    } catch(e) { utils.showToast('Li lu: ' + e.message, 'error'); } finally { utils.toggleLoader(false); }
                } else {
                     importModal.close(); // Close import modal if nothing to save
                }
            }
        };

        const editModal = {
            currentPersonId: null,
            currentEditOrgId: null,
            // NEW: Function to render destination suggestions
            renderDestinationSuggestions: () => {
                const uniqueDestinations = [...new Set(state.currentPlanPeople.map(p => p.destination).filter(Boolean))];
                const container = document.getElementById('destSuggestions');
                if (uniqueDestinations.length === 0) {
                    container.innerHTML = '<span class="text-slate-400 italic">Cha c gin no hm nay</span>';
                    return;
                }
                container.innerHTML = uniqueDestinations.map(dest => 
                    `<span onclick="document.getElementById('edit_destination').value = '${dest}'" class="cursor-pointer bg-blue-100 hover:bg-blue-200 text-blue-800 px-2 py-1 rounded border border-blue-200 transition">${dest}</span>`
                ).join('');
            },
            mode: null,
            fixedJobMeta: null,
            openAddToGroup: async (dest) => {
                const meta = (state.groupMetaByDest && state.groupMetaByDest[dest]) ? state.groupMetaByDest[dest] : { destination: dest, nvsxNo: '', taskDesc: '' };
                editModal.mode = 'addToGroup';
                editModal.fixedJobMeta = meta;
                return editModal.open(null);
            },

            open: async (personId = null) => {
                utils.toggleLoader(true, "ang x l...");
                editModal.currentPersonId = personId;
                editModal.currentEditOrgId = null;
                const titleEl = document.getElementById('editModalTitle');
                
                ['edit_staffNo','edit_fullName','edit_title','edit_orgName','edit_dob','edit_pob','edit_phone','edit_idNo',
                 'edit_idIssueDate','edit_idExpiryDate','edit_weightKg','edit_luggageKg','edit_cargoKg','edit_rowNote',
                 'edit_destination','edit_nvsxNo','edit_taskDesc'].forEach(id => {
                     // Handle resetting input or select
                     const el = document.getElementById(id);
                     if(el) el.value = '';
                 });
                
                // Clear suggestions initially
                document.getElementById('destSuggestions').innerHTML = '';

                // DYNAMIC ORG FIELD CONSTRUCTION
                const orgContainer = document.getElementById('orgInputContainer');
                orgContainer.innerHTML = ''; // Clear previous

                if (state.userRole === 'dispatcher') {
                    // Admin: Input + Datalist
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'edit_orgName';
                    input.className = 'w-full border rounded p-2 text-sm';
                    input.setAttribute('list', 'allOrgsDatalist');
                    input.placeholder = 'Chn hoc nhp tn n v...';
                    orgContainer.appendChild(input);
                } else {
                    // User: Select Only
                    const select = document.createElement('select');
                    select.id = 'edit_orgName';
                    select.className = 'w-full border rounded p-2 text-sm bg-slate-50';
                    
                    // Add options
                    state.orgs.forEach(org => {
                        const opt = document.createElement('option');
                        opt.value = org.name;
                        opt.text = org.name;
                        select.appendChild(opt);
                    });
                    
                    // Pre-select user's org
                    const userOrgName = state.orgs.find(o => o.id === state.userOrgId)?.name || state.userOrgId;
                    select.value = userOrgName;
                    orgContainer.appendChild(select);
                }

                try {
                    // Reset Job UI (used by addToGroup mode)
                        try {
                            const __adv = document.getElementById('advEdit');
                            const __note = document.getElementById('addToGroupJobNote');
                            if (__note) __note.remove();
                            const __destIn = document.getElementById('edit_destination');
                            const __taskIn = document.getElementById('edit_taskDesc');
                            const __destWrap = __destIn ? __destIn.closest('div') : null;
                            const __taskWrap = __taskIn ? __taskIn.closest('div') : null;
                            const __sugg = document.getElementById('destSuggestions');
                            if (__destWrap) __destWrap.classList.remove('hidden');
                            if (__taskWrap) __taskWrap.classList.remove('hidden');
                            if (__sugg) __sugg.classList.remove('hidden');
                            if (__destIn) { __destIn.disabled = false; __destIn.readOnly = false; __destIn.classList.remove('opacity-60'); }
                            if (__taskIn) { __taskIn.disabled = false; __taskIn.readOnly = false; __taskIn.classList.remove('opacity-60'); }
                            // In case adv was hidden by previous mode, keep existing behavior elsewhere
                        } catch(e) {}
                        if (personId) {
                        titleEl.innerText = "Sa thng tin";
                        // UPDATED PATH: Use public/data/dailyPlans
                        const doc = await getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people').doc(personId).get();
                        if(!doc.exists) throw new Error("Khng tm thy nhn s");
                        const p = doc.data();

                        // Permission guard: user ch c sa/xa nhn s ca xng mnh (admin th lun c)
                        editModal.currentEditOrgId = p.orgId || '';
                        if (state.userRole !== 'dispatcher') {
                            if (state.isPlanLocked) { utils.showToast("Ngy  KHA, khng th sa nhn s.", "error"); editModal.currentPersonId = null; return; }
                            if ((p.orgId || '') !== state.userOrgId) { utils.showToast("Khng th sa nhn s ca xng khc.", "error"); editModal.currentPersonId = null; return; }
                        }
                        
                        document.getElementById('edit_staffNo').value = p.staffNo || '';
                        document.getElementById('edit_fullName').value = p.fullName || '';
                        document.getElementById('edit_title').value = p.title || '';
                        
                        // Set Org Name
                        const orgField = document.getElementById('edit_orgName');
                        if (orgField) orgField.value = p.orgName || '';
                        
                        document.getElementById('edit_dob').value = p.dob || '';
                        document.getElementById('edit_pob').value = p.pob || '';
                        document.getElementById('edit_phone').value = p.phone || '';
                        document.getElementById('edit_idNo').value = p.idNo || '';
                        document.getElementById('edit_idIssueDate').value = p.idIssueDate || '';
                        document.getElementById('edit_idExpiryDate').value = p.idExpiryDate || '';
                        document.getElementById('edit_weightKg').value = p.weightKg || '';
                        document.getElementById('edit_luggageKg').value = p.luggageKg || '';
                        document.getElementById('edit_cargoKg').value = p.cargoKg || '';
                        document.getElementById('edit_rowNote').value = p.rowNote || '';
                        document.getElementById('edit_destination').value = p.destination || '';
                        document.getElementById('edit_nvsxNo').value = p.nvsxNo || '';
                        document.getElementById('edit_taskDesc').value = p.taskDesc || '';
                        document.getElementById('advEdit').classList.add('hidden');
                    } else {
                        if (editModal.mode === 'addToGroup') {
                            const m = editModal.fixedJobMeta || {};
                            titleEl.innerText = `Thm nhn s (${m.destination || ''})`;
                            document.getElementById('edit_destination').value = m.destination || '';
                            document.getElementById('edit_nvsxNo').value = m.nvsxNo || '';
                            document.getElementById('edit_taskDesc').value = m.taskDesc || '';

                            // Show job section but lock "Ni n" + "Ni dung" (ch cho sa NVSX khi tht cn)
                            try {
                                const adv = document.getElementById('advEdit');
                                if (adv) adv.classList.remove('hidden');

                                const destIn = document.getElementById('edit_destination');
                                const taskIn = document.getElementById('edit_taskDesc');
                                const destWrap = destIn ? destIn.closest('div') : null;
                                const taskWrap = taskIn ? taskIn.closest('div') : null;
                                const sugg = document.getElementById('destSuggestions');

                                // Hide destination + taskDesc UI to avoid accidental edits
                                if (destWrap) destWrap.classList.add('hidden');
                                if (taskWrap) taskWrap.classList.remove('hidden');
                                if (sugg) sugg.classList.add('hidden');

                                // Still hard-lock fields (even if someone un-hides via devtools)
                                if (destIn) { destIn.disabled = true; destIn.readOnly = true; destIn.classList.add('opacity-60'); }
                                if (taskIn) { taskIn.disabled = false; taskIn.readOnly = false; taskIn.classList.remove('opacity-60'); }

                                // Note to users
                                let note = document.getElementById('addToGroupJobNote');
                                if (!note && adv) {
                                    note = document.createElement('div');
                                    note.id = 'addToGroupJobNote';
                                    note.className = 'p-3 rounded-xl border border-amber-200 bg-amber-50 text-amber-900 text-sm leading-relaxed';
                                    note.innerHTML = '<b>Lu :</b> a im n (Gin/Tu)  c c nh theo danh sch  import. Ch chnh <b>S NVSX</b> v/hoc <b>Ni dung cng vic</b> khi tht s cn (v d thay i NVSX). Khi nhp NVSX, h thng s t b trng  trnh lp/d.';
                                    adv.prepend(note);
                                }
                            } catch(e) {}
                        } else {
                            titleEl.innerText = "Thm nhn s mi";
                            // Default show advanced in add mode so suggestions are visible
                            document.getElementById('advEdit').classList.remove('hidden');
                            editModal.renderDestinationSuggestions(); // Load suggestions immediately
                        }
                    }
                    document.getElementById('editPersonModal').classList.remove('hidden'); document.getElementById('editPersonModal').classList.add('flex');
                } catch(e) { utils.showToast(e.message, "error"); } finally { utils.toggleLoader(false); }
            },
            close: () => { document.getElementById('editPersonModal').classList.add('hidden'); document.getElementById('editPersonModal').classList.remove('flex'); editModal.mode = null; editModal.fixedJobMeta = null; },
            save: async () => {
                utils.toggleLoader(true, "ang lu...");
                
                // Get Org Name (Input for Admin, Select for User)
                let finalOrgName = document.getElementById('edit_orgName').value;
                
                // Fallback for safety (though select should always have value)
                if (!finalOrgName && state.userRole !== 'dispatcher') {
                     const org = state.orgs.find(o => o.id === state.userOrgId);
                     finalOrgName = org ? org.name : state.userOrgId;
                }
                
                const updatedData = {
                    staffNo: document.getElementById('edit_staffNo').value, fullName: document.getElementById('edit_fullName').value,
                    title: document.getElementById('edit_title').value, dob: document.getElementById('edit_dob').value,
                    pob: document.getElementById('edit_pob').value, phone: document.getElementById('edit_phone').value,
                    idNo: document.getElementById('edit_idNo').value, idIssueDate: document.getElementById('edit_idIssueDate').value,
                    idExpiryDate: document.getElementById('edit_idExpiryDate').value,
                    weightKg: Number(document.getElementById('edit_weightKg').value), luggageKg: Number(document.getElementById('edit_luggageKg').value),
                    cargoKg: Number(document.getElementById('edit_cargoKg').value), rowNote: document.getElementById('edit_rowNote').value,
                    destination: document.getElementById('edit_destination').value, nvsxNo: document.getElementById('edit_nvsxNo').value,
                    taskDesc: document.getElementById('edit_taskDesc').value, 
                    orgName: finalOrgName,
                    updatedBy: state.currentUser.email, updatedAt: new Date()
                };

                // Normalize job fields (avoid duplicated NVSX / messy text)
                try {
                    updatedData.destination = utils.normalizeDestinationKey(updatedData.destination || '');
                    updatedData.nvsxNo = utils.normalizeNvsxInput(updatedData.nvsxNo || '');
                    updatedData.taskDesc = utils.normalizeTaskText(updatedData.taskDesc || '');
                } catch(e) {}

                // addToGroup: ignore edits of job info, only allow optional NVSX override
                if (!editModal.currentPersonId && editModal.mode === 'addToGroup') {
                    const m = editModal.fixedJobMeta || {};
                    // Destination is fixed by group (Gin/Tu)
                    updatedData.destination = m.destination || updatedData.destination;

                    // Allow editing NVSX + Ni dung cng vic when really needed; if left blank, fallback to group meta
                    const nInput = utils.normalizeNvsxInput((document.getElementById('edit_nvsxNo').value || '').trim());
                    const tInput = utils.normalizeTaskText((document.getElementById('edit_taskDesc').value || '').trim());
                    updatedData.nvsxNo = nInput || utils.normalizeNvsxInput(m.nvsxNo || '');
                    updatedData.taskDesc = tInput || utils.normalizeTaskText(m.taskDesc || '');
                }

                const warnings = [];
                if(!updatedData.staffNo) warnings.push('Thiu danh s');
                if(updatedData.idExpiryDate) {
                    const parts = updatedData.idExpiryDate.split('/');
                    if(parts.length === 3) {
                        const expDate = new Date(parseInt(parts[2]), parseInt(parts[1])-1, parseInt(parts[0]));
                        const diffDays = Math.ceil((expDate - new Date()) / (86400000));
                        if(diffDays <= 60) warnings.push('CCCD sp/ ht hn'); updatedData.isIdExpiring = true;
                    }
                }
                updatedData.warnings = warnings;

                // Conflict Check
                if (!editModal.currentPersonId) { // Only check on create or if Staff ID changed (simplified to create for now)
                    const conflicts = conflictChecker.check([updatedData], state.currentPlanPeople);
                    if(conflicts.length > 0) {
                        utils.showToast(conflicts[0].msg, 'error'); // Use .msg property
                        utils.toggleLoader(false);
                        return;
                    }
                }

                try {
                    // UPDATED PATH: Use public/data/dailyPlans
                    if (editModal.currentPersonId) {
                        // Permission guard (safety): user khng c sa nhn s xng khc / ngy kha
                        if (state.userRole !== 'dispatcher') {
                            if (state.isPlanLocked) { utils.showToast("Ngy  KHA, khng th cp nht.", "error"); utils.toggleLoader(false); return; }
                            const refOrg = editModal.currentEditOrgId || (state.currentPlanPeople.find(p => p.id === editModal.currentPersonId)?.orgId) || '';
                            if (refOrg && refOrg !== state.userOrgId) { utils.showToast("Khng th cp nht nhn s ca xng khc.", "error"); utils.toggleLoader(false); return; }
                        }
                        await getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people').doc(editModal.currentPersonId).update(updatedData);
                        audit.log('UPDATE_PERSON', { staffNo: updatedData.staffNo, fullName: updatedData.fullName, destination: updatedData.destination });
                        utils.showToast(" cp nht", "success");
                    } else {
                        updatedData.createdAt = new Date(); updatedData.importedBy = state.currentUser.email; updatedData.orgId = state.userRole === 'dispatcher' ? 'XNXL' : state.userOrgId;
                        // OrderIndex: thm mi th nm cui ca Gin hin ti
                        try {
                            const dk = utils.destinationDisplay(updatedData.destination || '');
                            const maxIdx = (state.currentPlanPeople || [])
                                .filter(pp => utils.destinationDisplay(pp.destination || '') === dk)
                                .reduce((m, pp) => {
                                    const v = parseInt(pp.orderIndex, 10);
                                    return Number.isFinite(v) ? Math.max(m, v) : m;
                                }, 0);
                            updatedData.orderIndex = maxIdx + 1;
                        } catch(e) { updatedData.orderIndex = 1; }
                        await getPublicColl('dailyPlans').doc(state.currentDateKey).set({ updatedAt: new Date(), status: state.isPlanLocked ? 'Locked' : 'Draft' }, { merge: true });
                        await getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people').add(updatedData);
                        audit.log('ADD_PERSON', { staffNo: updatedData.staffNo, fullName: updatedData.fullName, destination: updatedData.destination });
                        utils.showToast(" thm mi", "success");
                    }
                    masterDataManager.saveToMaster([updatedData]); // Save to Master
                    editModal.close();
                } catch(e) { console.error(e); utils.showToast("Li: " + e.message, "error"); } finally { utils.toggleLoader(false); }
            }
        };

        const exportManager = {
    selectedDates: [],
    pending: null,

    open: () => {
        if (exportManager.selectedDates.length === 0) {
            const current = document.getElementById('planDateInput').value;
            if (current) exportManager.addDateValue(current);
        }
        exportManager.renderDateList();
        document.getElementById('exportModal').classList.remove('hidden');
        document.getElementById('exportModal').classList.add('flex');
    },
    close: () => {
        document.getElementById('exportModal').classList.add('hidden');
        document.getElementById('exportModal').classList.remove('flex');
    },

    openPreview: () => {
        document.getElementById('exportPreviewModal').classList.remove('hidden');
        document.getElementById('exportPreviewModal').classList.add('flex');
    },
    closePreview: () => {
        document.getElementById('exportPreviewModal').classList.add('hidden');
        document.getElementById('exportPreviewModal').classList.remove('flex');
    },
    cancelPreview: () => {
        exportManager.closePreview();
        exportManager.open();
    },

    addDate: () => { exportManager.addDateValue(document.getElementById('exportDateInput').value); },
    addDateValue: (dateStr) => {
        if (dateStr && !exportManager.selectedDates.includes(dateStr)) {
            exportManager.selectedDates.push(dateStr);
            exportManager.selectedDates.sort();
            exportManager.renderDateList();
        }
    },
    removeDate: (dateStr) => {
        exportManager.selectedDates = exportManager.selectedDates.filter(d => d !== dateStr);
        exportManager.renderDateList();
    },
    renderDateList: () => {
        document.getElementById('exportDateList').innerHTML = exportManager.selectedDates.map(dateStr => {
            const [y, m, d] = dateStr.split('-');
            return `<li class="flex justify-between items-center bg-white p-2 rounded border border-slate-200 text-sm"><span class="font-bold text-slate-700">${d}/${m}/${y}</span><button onclick="exportManager.removeDate('${dateStr}')" class="text-red-500 hover:text-red-700 font-bold px-2">&times;</button></li>`;
        }).join('');
    },

    renderPreview: (peopleData, dateDisplayString) => {
        const esc = (s) => String(s ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const people = [...peopleData];
        people.sort((a, b) => (a.destination || '').localeCompare(b.destination || '') || (a.nvsxNo || '').localeCompare(b.nvsxNo || '') || (a.orgName || '').localeCompare(b.orgName || ''));

        const grouped = people.reduce((acc, p) => {
            const k = p.destination || 'KHC';
            if (!acc[k]) acc[k] = [];
            acc[k].push(p);
            return acc;
        }, {});

        let html = `
            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                <div class="text-slate-700 font-bold mb-1"><i class="fas fa-calendar-day text-slate-400 mr-2"></i>Ngy khi hnh: <span class="text-blue-700">${esc(dateDisplayString)}</span></div>
                <div class="text-xs text-slate-500">Danh sch di y ng theo ni dung s c trong file Word.</div>
            </div>
        `;

        const groupedByDestDate = peopleData.reduce((acc, p) => {
                    const dest0 = (p.destination || '').trim() || 'Cha xc nh';
                    const planId0 = p.__planId || '';
                    const k = dest0 + '||' + planId0;
                    (acc[k] = acc[k] || { dest: dest0, planId: planId0, people: [] }).people.push(p);
                    return acc;
                }, {});
                const groupKeys = Object.keys(groupedByDestDate).sort((a,b) => {
                    const ga = groupedByDestDate[a], gb = groupedByDestDate[b];
                    return String(ga.planId||'').localeCompare(String(gb.planId||'')) || String(ga.dest||'').localeCompare(String(gb.dest||''));
                });

                groupKeys.forEach(k => {
                    const dest = groupedByDestDate[k].dest;
                    const groupPeople = groupedByDestDate[k].people;
                    const groupSorted = (groupPeople || []).slice().sort((a,b) => {
                    const ai = Number.isFinite(+a.orderIndex) ? +a.orderIndex : 999999999;
                    const bi = Number.isFinite(+b.orderIndex) ? +b.orderIndex : 999999999;
                    if (ai !== bi) return ai - bi;

                    const at = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds * 1000 : (+a.createdAt || 0)) : 0;
                    const bt = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds * 1000 : (+b.createdAt || 0)) : 0;
                    if (at !== bt) return at - bt;

                    return String(a.staffNo||'').localeCompare(String(b.staffNo||''));
                });
                    const planId = groupedByDestDate[k].planId;
                    const dateForHeader = utils.formatPlanIdHeader(planId, dateDisplayString);
            const meta = utils.getGroupFinalMeta(groupPeople);
            const uniqueNVSX = meta.nvsxStr;
            const uniqueTasks = (meta.taskLines || []).join('\n');
            const isInconsistent = !!meta.inconsistent;

                    // Cache group meta for Add-to-group button
                    try { state.groupMetaByDest[dest] = { destination: dest, nvsxNo: uniqueNVSX || '', taskDesc: (meta.taskText || '') }; } catch(e) {}

                    html += `
                <div class="border border-slate-200 rounded-lg overflow-hidden">
                    <div class="bg-blue-50 px-4 py-3 flex justify-between items-center">
                        <div class="font-bold text-blue-800 text-base flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> ${esc(dest)}
                        </div>
                        <div class="text-xs bg-white text-blue-600 px-2 py-1 rounded font-bold border border-blue-100">${groupSorted.length} ngi</div>
                    </div>
                    <div class="p-4 space-y-3">
                        <div class="text-sm text-slate-700"><span class="font-bold">S NVSX:</span> ${esc(uniqueNVSX || '--')}</div>
                        <div class="text-sm text-slate-700">
                            <div class="font-bold mb-1">Ni dung cng vic:</div>
                            <pre class="whitespace-pre-wrap text-xs bg-white p-3 rounded border border-slate-200 text-slate-700 font-mono">${esc(uniqueTasks || '--')}</pre>
                        </div>

                        <div class="text-sm text-slate-700 font-bold">Danh sch ngi i:</div>
                        <div class="overflow-x-auto border border-slate-200 rounded">
                            <table class="min-w-full divide-y divide-slate-200 text-xs bg-white">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-3 py-2 text-center w-12">STT</th>
                                        <th class="px-3 py-2 text-left">H v tn</th>
                                        <th class="px-3 py-2 text-left">Chc danh</th>
                                        <th class="px-3 py-2 text-left">n v</th>
                                        <th class="px-3 py-2 text-center w-24">Danh s</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    ${groupSorted.map((p, i) => `
                                        <tr>
                                            <td class="px-3 py-2 text-center text-slate-500 font-mono">${i + 1}</td>
                                            <td class="px-3 py-2 font-semibold text-slate-700">${esc(p.fullName || '')}</td>
                                            <td class="px-3 py-2 text-slate-600">${esc(p.title || '')}</td>
                                            <td class="px-3 py-2 text-slate-600">${esc(importModal.getSelectedOrgName() || p.orgName || '')}</td>
                                            <td class="px-3 py-2 text-center text-slate-600 font-mono">${esc(p.staffNo || '')}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });

        document.getElementById('exportPreviewBody').innerHTML = html;
    },

    processExport: async () => {
        if (exportManager.selectedDates.length === 0) return utils.showToast("Vui lng chn t nht 1 ngy", "error");

        utils.toggleLoader(true, "ang tng hp...");
        try {
            const promises = exportManager.selectedDates.map(async dateStr => {
                // UPDATED PATH: Use public/data/dailyPlans
                const ds = dateStr.replace(/-/g, '');
                const snap = await getPublicColl('dailyPlans').doc(ds).collection('people').get();
                return snap.docs.map(d => ({ ...d.data(), __planId: ds }));
            });
            const results = await Promise.all(promises);
            const allPeople = results.flat();
            if (allPeople.length === 0) { utils.showToast("Khng c d liu", "error"); utils.toggleLoader(false); return; }

            // Warn if group data is inconsistent (still allow export)
            try {
                const g = allPeople.reduce((acc, p) => { const k = (p.destination || 'KHC'); (acc[k] = acc[k] || []).push(p); return acc; }, {});
                const hasInconsistent = Object.keys(g).some(k => utils.getGroupFinalMeta(g[k]).inconsistent);
                if (hasInconsistent) {
                    utils.showToast("Cnh bo: D liu khng ng nht trong cng 1 gin. Nn bm Sa gin/NVSX/CV  cht li trc khi Export (vn c th Export).", "warning");
                }
            } catch(e) {}

            const dateDisplayString = exportManager.selectedDates
                .map(ds => { const [y, m, d] = ds.split('-'); return `${d}.${m}.${y}`; })
                .join(' + ');

            exportManager.pending = { peopleData: allPeople, dateDisplayString };

            // Show preview modal
            exportManager.close();
            exportManager.renderPreview(allPeople, dateDisplayString);
            exportManager.openPreview();
        } catch (e) {
            console.error(e);
            utils.showToast("Li: " + e.message, "error");
        } finally {
            utils.toggleLoader(false);
        }
    },

    confirmExport: async () => {
    if (!exportManager.pending) return;

    utils.toggleLoader(true, "ang to file...");
    try {
        await app.generateDocx(exportManager.pending.peopleData, exportManager.pending.dateDisplayString);
        audit.log('EXPORT_DOCX', { count: exportManager.pending.peopleData.length, reason: exportManager.pending.dateDisplayString });
        utils.showToast(" xut file thnh cng", "success");
        exportManager.pending = null;
        exportManager.closePreview();
    } catch (e) {
        console.error(e);
        utils.showToast("Li: " + e.message, "error");
    } finally {
        utils.toggleLoader(false);
    }
},

confirmPdf: async () => {
    if (!exportManager.pending) return;

    utils.toggleLoader(true, "ang to PDF...");
    try {
        await app.generatePdf(exportManager.pending.peopleData, exportManager.pending.dateDisplayString);
        audit.log('EXPORT_PDF', { count: exportManager.pending.peopleData.length, reason: exportManager.pending.dateDisplayString });
        utils.showToast(" xut PDF thnh cng", "success");
        exportManager.pending = null;
        exportManager.closePreview();
    } catch (e) {
        console.error(e);
        utils.showToast("Li: " + e.message, "error");
    } finally {
        utils.toggleLoader(false);
    }
},

confirmBaydi: async () => {
    if (!exportManager.pending) return;

    utils.toggleLoader(true, "ang to file Excel (Template BayDi)...");
    try {
        await app.generateBaydiTemplateExcel(exportManager.pending.peopleData, exportManager.pending.dateDisplayString);
        audit.log('EXPORT_BAYDI', { count: exportManager.pending.peopleData.length, reason: exportManager.pending.dateDisplayString });
        utils.showToast(" xut Template BayDi thnh cng", "success");
        exportManager.pending = null;
        exportManager.closePreview();
    } catch (e) {
        console.error(e);
        utils.showToast("Li: " + e.message, "error");
    } finally {
        utils.toggleLoader(false);
    }
}
};

        const app = {
            init: () => {
                // Force auth persistence to SESSION (logout required after closing browser)
                try { auth.setPersistence(firebase.auth.Auth.Persistence.SESSION); } catch(e) {}
                try { const _b=document.getElementById('btnAdd'); if(_b) _b.classList.add('hidden'); } catch(e) {}
                const __hasLocalAuth = () => {
                    try {
                        for (let i = 0; i < localStorage.length; i++) {
                            const k = localStorage.key(i) || '';
                            if (k.startsWith('firebase:authUser:')) return true;
                        }
                    } catch(e) {}
                    return false;
                };
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // One-time cleanup: if previous login was stored in localStorage, force re-login.
                        try {
                            const fixed = localStorage.getItem('__auth_persist_fixed') === '1';
                            if (!fixed && __hasLocalAuth()) {
                                localStorage.setItem('__auth_persist_fixed', '1');
                                sessionStorage.setItem('__force_relogin_msg', 'H thng  tt ch  nh ng nhp. Vui lng ng nhp li.');
                                await auth.signOut();
                                return;
                            }
                        } catch(e) {}
                        utils.toggleLoader(true, 'ang ti...');
                        const userDoc = await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).get();
                        await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({ lastLogin: new Date() }, { merge: true });
                        
                        if (!userDoc.exists) {
                            const role = user.email.includes('admin') ? 'dispatcher' : 'workshop'; const orgId = role === 'dispatcher' ? 'XNXL' : 'XuongBo';
                            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).set({ email: user.email, role, orgId, displayName: user.displayName || user.email, createdAt: new Date() });
                            state.userRole = role; state.userOrgId = orgId;
                        } else {
                            const d = userDoc.data(); state.userRole = d.role; state.userOrgId = d.orgId;
                        }
                        state.currentUser = user; app.setupUI(); app.displayLastLoginInfo();
                        document.getElementById('authScreen').classList.add('hidden'); document.getElementById('appShell').classList.remove('hidden'); document.getElementById('appShell').classList.add('flex');
                        
                        await app.loadOrgs(); if(state.userRole === 'dispatcher') userManager.loadUsers();
                        
                        const today = new Date(); const mm = String(today.getMonth()+1).padStart(2,'0'); const dd = String(today.getDate()).padStart(2,'0'); const yyyy = today.getFullYear();
                        document.getElementById('planDateInput').value = `${yyyy}-${mm}-${dd}`;
                        try { if (typeof calendarPicker !== 'undefined') calendarPicker.init(); } catch(e) {} document.getElementById('exportDateInput').value = `${yyyy}-${mm}-${dd}`;
                        state.currentDateKey = `${yyyy}${mm}${dd}`;
                        
                        app.loadPlan(); // Start listener
                        utils.toggleLoader(false);
                    } else {
                        document.getElementById('authScreen').classList.remove('hidden');
                        try {
                            const m = sessionStorage.getItem('__force_relogin_msg');
                            if (m) { sessionStorage.removeItem('__force_relogin_msg'); utils.showToast(m, 'info'); }
                        } catch(e) {} document.getElementById('appShell').classList.add('hidden'); document.getElementById('appShell').classList.remove('flex');
                    }
                });
                
                // Theme toggle (light/dark)
                (function initTheme() {
                    const KEY = 'xnxl_theme';
                    const root = document.documentElement;
                    const btn = document.getElementById('themeToggle');
                    function apply(theme) {
                        const isDark = theme === 'dark';
                        root.classList.toggle('dark', isDark);
                        if (btn) {
                            btn.setAttribute('aria-pressed', isDark ? 'true' : 'false');
                            const icon = btn.querySelector('i');
                            if (icon) icon.className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
                            const label = btn.querySelector('span');
                            if (label) label.textContent = isDark ? 'Light' : 'Dark';
                        }
                    }
                    let theme = null;
                    try { theme = localStorage.getItem(KEY); } catch (e) {}
                    if (!theme) {
                        theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
                    }
                    apply(theme);
                    if (btn) {
                        btn.addEventListener('click', () => {
                            const cur = root.classList.contains('dark') ? 'dark' : 'light';
                            const next = cur === 'dark' ? 'light' : 'dark';
                            try { localStorage.setItem(KEY, next); } catch (e) {}
                            apply(next);
                        });
                    }
                })();

                // Login anti-spam (client-side lock on this browser)
                const LOGIN_LOCK_KEY = 'xnxl_login_lock';
                function _getLoginLock() {
                    try { return JSON.parse(localStorage.getItem(LOGIN_LOCK_KEY) || '{}'); } catch (e) { return {}; }
                }
                function _setLoginLock(obj) {
                    try { localStorage.setItem(LOGIN_LOCK_KEY, JSON.stringify(obj || {})); } catch (e) {}
                }
                function _clearLoginLock() {
                    try { localStorage.removeItem(LOGIN_LOCK_KEY); } catch (e) {}
                }
                function _formatRemain(ms) {
                    const s = Math.max(0, Math.ceil(ms / 1000));
                    const mm = String(Math.floor(s / 60)).padStart(2, '0');
                    const ss = String(s % 60).padStart(2, '0');
                    return `${mm}:${ss}`;
                }
                function _showLoginError(message) {
                    const box = document.getElementById('loginError');
                    if (!box) { utils.showToast(message, 'error'); return; }
                    box.textContent = message;
                    box.classList.remove('hidden');
                }
                function _hideLoginError() {
                    const box = document.getElementById('loginError');
                    if (!box) return;
                    box.textContent = '';
                    box.classList.add('hidden');
                }


                document.getElementById('loginForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    _hideLoginError();

                    const btn = document.querySelector('#loginForm button[type="submit"]');
                    const lock = _getLoginLock();
                    const now = Date.now();
                    const lockUntil = Number(lock.lockUntil || 0);

                    if (lockUntil && now < lockUntil) {
                        if (btn) btn.disabled = true;
                        if (window.__loginLockTimer) { try { clearInterval(window.__loginLockTimer); } catch(e) {} }
                        const tick = () => {
                            const remainMs = lockUntil - Date.now();
                            if (remainMs <= 0) {
                                if (window.__loginLockTimer) { try { clearInterval(window.__loginLockTimer); } catch(e) {} }
                                window.__loginLockTimer = null;
                                if (btn) btn.disabled = false;
                                _hideLoginError();
                                return;
                            }
                            _showLoginError(`Tm kha ng nhp (thit b ny) ${_formatRemain(remainMs)} do nhp sai qu 5 ln. Vui lng th li sau.`);
                        };
                        tick();
                        window.__loginLockTimer = setInterval(tick, 1000);
                        return;
                    }

                    if (btn) btn.disabled = true;

                    let id = (document.getElementById('email').value || '').trim();
                    let email = id;
                    if (!email.includes('@')) email += '@xnxl.com';

                    try {
                        await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                        await auth.signInWithEmailAndPassword(email, document.getElementById('password').value);

                        // Success: clear lock counters
                        _clearLoginLock();
                        _hideLoginError();
                    } catch (err) {
                        // Network-ish errors shouldn't count as attempts
                        const code = err && err.code ? String(err.code) : '';
                        const isCountable = [
                            'auth/wrong-password',
                            'auth/user-not-found',
                            'auth/invalid-email',
                            'auth/too-many-requests'
                        ].includes(code);

                        let msg = 'ng nhp khng thnh cng. Vui lng th li.';
                        if (code === 'auth/wrong-password') msg = 'Sai mt khu.';
                        else if (code === 'auth/user-not-found' || code === 'auth/invalid-email') msg = 'ID khng ng.';
                        else if (code === 'auth/too-many-requests') msg = 'Qu nhiu ln th ng nhp. Vui lng th li sau t pht.';

                        if (isCountable) {
                            let count = Number(lock.count || 0) + 1;
                            const MAX = 5;
                            if (count >= MAX) {
                                const until = now + 5 * 60 * 1000;
                                _setLoginLock({ count: 0, lockUntil: until });
                                _showLoginError(`${msg} Bn  nhp sai ${MAX}/${MAX}. Tm kha 5 pht (thit b ny).`);
                            } else {
                                _setLoginLock({ count, lockUntil: 0 });
                                _showLoginError(`${msg} Bn  nhp sai ${count}/${MAX}. Cn ${MAX - count} ln na s tm kha 5 pht.`);
                            }
                        } else {
                            _showLoginError(msg + (err && err.message ? ` (${err.message})` : ''));
                        }

                        try { utils.showToast(msg, 'error'); } catch (e) {}
                    } finally {
                        if (btn) btn.disabled = false;
                    }
                });
                document.getElementById('excelFile').addEventListener('change', importModal.handleFile);
                // Quick search filter (client-side)
                const qs = document.getElementById('quickSearch');
                const qsClear = document.getElementById('btnClearSearch');
                if (qs) {
                    qs.addEventListener('input', () => {
                        state.quickSearch = qs.value || '';
                        app.renderPlanTable(state.currentPlanPeople || []);
                    });
                }
                if (qsClear && qs) {
                    qsClear.addEventListener('click', () => {
                        qs.value = '';
                        state.quickSearch = '';
                        app.renderPlanTable(state.currentPlanPeople || []);
                    });
                }
                // Warning center click
                const warnBox = document.getElementById('warningStatBox');
                if (warnBox) {
                    warnBox.style.cursor = 'pointer';
                    warnBox.title = 'Bm  xem chi tit cnh bo';
                    warnBox.addEventListener('click', () => {
                        const n = parseInt(document.getElementById('statWarnings')?.innerText || '0', 10);
                        if (n > 0) warningCenter.open();
                        else utils.showToast('Khng c cnh bo', 'success');
                    });
                }

                // Responsive (mobile card / desktop table): re-render when screen size changes
                if (!window.__planResizeBound) {
                    window.__planResizeBound = true;
                    let __rt;
                    window.addEventListener('resize', () => {
                        clearTimeout(__rt);
                        __rt = setTimeout(() => {
                            try {
                                app.renderPlanTable(state.currentPlanPeople || []);
                            } catch (e) { /* ignore */ }
                        }, 200);
                    });
                }

            },
            logout: async () => { if(state.unsubscribePlan) state.unsubscribePlan(); await auth.signOut(); },
            displayLastLoginInfo: async () => {
                const loginValEl = document.getElementById('lastLoginVal');
                if (state.userRole === 'dispatcher') {
                    try {
                        const snap = await db.collection('artifacts').doc(appId).collection('users').get();
                        let latestTime = 0, latestUser = '';
                        snap.forEach(doc => { const d = doc.data(); if (d.lastLogin && d.lastLogin.seconds > latestTime/1000) { latestTime = d.lastLogin.seconds*1000; latestUser = d.displayName || d.email; } });
                        if (latestTime > 0) loginValEl.innerText = `${latestUser} (${utils.formatDateTime(new Date(latestTime))})`;
                    } catch (e) { loginValEl.innerText = "Li ti"; }
                } else { loginValEl.innerText = utils.formatDateTime(new Date()); }
            },
            setupUI: () => {
                document.getElementById('userBadge').innerText = state.userRole === 'dispatcher' ? 'IU  (ADMIN)' : `USER: ${state.userOrgId}`;
                const isDisp = state.userRole === 'dispatcher';
                document.getElementById('navSettings').classList.toggle('hidden', !isDisp);                 document.getElementById('navAudit').classList.toggle('hidden', !isDisp);
document.getElementById('btnLock').classList.toggle('hidden', !isDisp);
                document.getElementById('importOrgSelectWrapper').classList.toggle('hidden', !isDisp); document.getElementById('btnExport').classList.toggle('hidden', !isDisp);
                document.getElementById('btnReport').classList.toggle('hidden', !isDisp); // Toggle Report Button
            },
            loadOrgs: async () => {
                // UPDATED PATH: Use public/data/organizations
                const snap = await getPublicColl('organizations').get();
                if (snap.empty) { const seeds = ['Xng B','Xng Sa Cha','Ban Chnh Hn','Xng Bin','Ban Kho St','XNXL']; const batch = db.batch(); seeds.forEach(n => batch.set(getPublicColl('organizations').doc(n), {name:n})); await batch.commit(); state.orgs = seeds.map(n => ({id:n,name:n})); }
                else state.orgs = snap.docs.map(d => ({id:d.id,...d.data()}));
                const ops = state.orgs.map(o => `<option value="${o.name}">${o.name}</option>`).join(''); // Use Name as value for datalist consistency
                // Update Datalist for Admin
                document.getElementById('allOrgsDatalist').innerHTML = ops;
                // Update Import Select for Admin
                document.getElementById('importOrgSelect').innerHTML = state.orgs.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
                document.getElementById('u_orgId').innerHTML = state.orgs.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
            },
            changeDate: () => {
                const dateVal = document.getElementById('planDateInput').value;
                state.currentDateKey = dateVal.replace(/-/g, '');
                app.loadPlan();
            },
            loadPlan: () => {
                if (state.unsubscribePlan) state.unsubscribePlan(); // Unsubscribe prev listener
                utils.toggleLoader(true);
                
                // 1. Get Status (Single fetch to avoid 2 listeners)
                // UPDATED PATH: Use public/data/dailyPlans
                getPublicColl('dailyPlans').doc(state.currentDateKey).get().then(doc => {
                    state.isPlanLocked = false;
                    if(doc.exists) {
                        state.isPlanLocked = doc.data().status === 'Locked';
                        document.getElementById('planStatus').innerText = state.isPlanLocked ? ' KHA' : 'DRAFT';
                        document.getElementById('planStatus').className = `px-3 py-1.5 rounded text-xs font-bold uppercase tracking-wider ${state.isPlanLocked ? 'bg-red-50 text-red-600 border border-red-100' : 'bg-green-50 text-green-700 border border-green-100'}`;
                    } else {
                        document.getElementById('planStatus').innerText = 'MI';
                        document.getElementById('planStatus').className = 'px-3 py-1.5 rounded text-xs font-bold bg-slate-50 text-slate-500 border border-slate-200';
                    }
                    // Update Button States
                    const isDisp = state.userRole === 'dispatcher';
                    document.getElementById('btnImport').disabled = state.isPlanLocked && !isDisp;
                    document.getElementById('btnImport').classList.toggle('opacity-50', state.isPlanLocked && !isDisp);
                    const __btnAdd=document.getElementById('btnAdd'); if(__btnAdd){ __btnAdd.disabled = state.isPlanLocked && !isDisp; __btnAdd.classList.toggle('opacity-50', state.isPlanLocked && !isDisp); }
                    document.getElementById('btnLock').innerHTML = state.isPlanLocked ? '<i class="fas fa-unlock mr-1"></i> M' : '<i class="fas fa-lock mr-1"></i> Kha';
                    document.getElementById('btnDeleteAll').classList.toggle('hidden', state.isPlanLocked && !isDisp);
                });

                // 2. Real-time Listen People
                // UPDATED PATH: Use public/data/dailyPlans
                let q = getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people');
                
                state.unsubscribePlan = q.onSnapshot(snap => {
                    const people = snap.docs.map(d => ({...d.data(), id: d.id}));
                    state.currentPlanPeople = people;
                    app.renderPlanTable(people);
                    utils.toggleLoader(false);
                }, err => { console.error(err); utils.toggleLoader(false); });
            },
            renderPlanTable: (people) => {
                const container = document.getElementById('planContent');
                const allPeople = Array.isArray(people) ? people : [];
                const q = (state.quickSearch || '').toLowerCase().trim();
                const viewPeople = q ? allPeople.filter(p => {
                    const hay = [
                        p.staffNo, p.fullName, p.title, p.orgName, p.destination, p.nvsxNo, p.taskDesc
                    ].join(' ').toLowerCase();
                    return hay.includes(q);
                }) : allPeople;
                if (allPeople.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white"><div class="bg-slate-50 p-6 rounded-full mb-4"><i class="fas fa-clipboard-list text-4xl text-slate-300"></i></div><p class="text-sm font-medium">Cha c d liu.</p></div>`;
                    app.updateStats(0,0,0,0); return;
                }
                const offshore = people.filter(p => !p.isReturn).length;
                const warnings = allPeople.filter(p => p.warnings && p.warnings.length > 0).length;
                app.updateStats(allPeople.length, allPeople.length, 0, warnings); // Assuming all go offshore for now
                if (viewPeople.length === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-slate-400 bg-white"><div class="bg-slate-50 p-6 rounded-full mb-4"><i class="fas fa-search text-4xl text-slate-300"></i></div><p class="text-sm font-medium">Khng c kt qu tm kim</p><p class="text-xs mt-1">Hy th t kha khc (tn, danh s, gin, n v...)</p></div>`;
                    return;
                }

                const grouped = viewPeople.reduce((acc, p) => { const k = utils.destinationDisplay(p.destination); if(!acc[k]) acc[k]=[]; acc[k].push(p); return acc; }, {});
                let html = '';
                state.groupMetaByDest = {};
                                const isMobile = !!(window.matchMedia && window.matchMedia('(max-width: 767px)').matches);

                Object.keys(grouped).sort().forEach(dest => {
                    const group = grouped[dest];
                    const groupSorted = (group || []).slice().sort((a,b) => {
                        const ai = Number.isFinite(+a.orderIndex) ? +a.orderIndex : 999999999;
                        const bi = Number.isFinite(+b.orderIndex) ? +b.orderIndex : 999999999;
                        if (ai !== bi) return ai - bi;

                        const at = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds * 1000 : (+a.createdAt || 0)) : 0;
                        const bt = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds * 1000 : (+b.createdAt || 0)) : 0;
                        if (at !== bt) return at - bt;

                        return String(a.staffNo||'').localeCompare(String(b.staffNo||''));
                    });
                    const meta = utils.getGroupFinalMeta(group);
                    const allNvsx = meta.nvsxStr;
                    const taskLines = meta.taskLines;
                    const isInconsistent = !!meta.inconsistent;

                    const escHtml = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
                    const taskDisplayHtml = taskLines.length ? taskLines.map(l => escHtml(l)).join('<br/>') : '';

                    const gid = 'task_' + btoa(unescape(encodeURIComponent(dest))).replace(/=+/g,'').replace(/[^a-zA-Z0-9]/g,'');

                    const safeDest = dest.replace(/'/g, "\'");
                    const editBtn = state.userRole === 'dispatcher'
                        ? `<button onclick="app.editDestination('${safeDest}')" class="ml-2 text-slate-400 hover:text-blue-600 transition"><i class="fas fa-edit"></i></button>`
                        : '';

                    const canAddToGroup = !(state.isPlanLocked && state.userRole !== 'dispatcher');

                    html += `
                        <div class="bg-blue-50/50 px-4 py-3 border-b border-blue-100 sticky top-0 z-10 backdrop-blur-sm shadow-sm">
                            <div class="flex justify-between items-start">
                                <div class="w-4/5">
                                    <div class="font-bold text-blue-800 text-base flex items-center">
                                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> ${dest} ${editBtn}
                                    </div>
                                    <div class="mt-1 text-xs text-slate-600 space-y-1">
                                        ${isInconsistent ? `<div class="text-xs text-amber-800 bg-amber-50 border border-amber-200 rounded-md p-2">D liu khng ng nht, hy bm <b>Sa gin/NVSX/CV</b>  cht li (vn c th Export).</div>` : ``}
                                        <div><span class="font-bold">NVSX:</span> <span class="break-words">${allNvsx || '--'}</span></div>
                                        <div class="flex items-start">
                                            <span class="font-bold mr-1 whitespace-nowrap">Cng vic:</span>
                                            <div class="flex-1">
                                                <div id="${gid}" class="js-task-block text-slate-700 leading-relaxed" data-lines="${taskLines.length}">${taskDisplayHtml || '--'}</div>
                                                <button type="button" class="js-task-toggle hidden mt-1 text-[11px] text-blue-700 font-bold hover:underline" data-target="${gid}">M rng</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end gap-2">
                                <span class="text-xs bg-white text-blue-700 px-2 py-1 rounded font-bold border border-blue-100">${groupSorted.length} ngi</span>
                                <button type="button" class="js-add-to-group bg-blue-600 hover:bg-blue-700 text-white text-xs px-3 py-1.5 rounded-lg font-bold transition shadow-sm ${canAddToGroup ? '' : 'opacity-50 cursor-not-allowed'}" data-dest="${escHtml(dest)}" ${canAddToGroup ? '' : 'disabled'}><i class="fas fa-plus mr-1"></i> Thm</button>
                            </div>
                            </div>
                        </div>
                    `;

                    const sortedGroup = groupSorted;

                    if (isMobile) {
                        html += `<div class="bg-white divide-y divide-slate-100">`;
                        sortedGroup.forEach((p, idx) => {
                            const warn = (p.warnings && p.warnings.length > 0);
                            const warnIcon = warn ? `<i class="fas fa-exclamation-triangle text-red-500 ml-1" title="${(p.warnings||[]).join(', ')}"></i>` : '';
                            const canEdit = state.userRole === 'dispatcher' || (!state.isPlanLocked && p.orgId === state.userOrgId);

                            let updatedInfo = '';
                            if (p.updatedAt || p.createdAt) {
                                const t = p.updatedAt ? p.updatedAt.seconds*1000 : p.createdAt.seconds*1000;
                                const u = (p.updatedBy || p.importedBy || '').split('@')[0];
                                updatedInfo = `<div class="text-[10px] text-slate-400 font-mono mt-1">${u} ${utils.formatTimeShort(new Date(t))}</div>`;
                            }

                            const actionBtns = canEdit
                                ? `<div class="flex items-center gap-3"><button onclick="editModal.open('${p.id}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-pen"></i></button><button onclick="app.deletePerson('${p.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash-alt"></i></button></div>`
                                : `<div class="text-slate-300"><i class="fas fa-lock"></i></div>`;

                            html += `
                                <div data-person-id="${p.id}" data-dest="${escHtml(dest)}" ${state.userRole==='dispatcher' ? 'draggable="true"' : ''} class="js-dnd-row p-3 ${warn ? 'bg-red-50/40' : ''}">
                                    <div class="flex items-start justify-between gap-3">
                                        <div class="min-w-0">
                                            <div class="flex items-center gap-2">
                                                <div class="text-xs text-slate-400 font-mono">${idx+1}</div>
                                                <div class="font-bold text-slate-800 truncate">${escHtml(p.fullName || '')}</div>
                                            </div>

                                            <div class="mt-0.5 text-xs text-slate-600 flex flex-wrap gap-x-3 gap-y-1">
                                                <div><span class="font-semibold">Danh s:</span> <span class="font-mono">${escHtml(p.staffNo || '')}</span></div>
                                                <div><span class="font-semibold">Chc danh:</span> ${escHtml(p.title || '')}</div>
                                            </div>

                                            <div class="mt-0.5 text-xs text-slate-600 flex flex-wrap gap-x-3 gap-y-1">
                                                <div><span class="font-semibold">n v:</span> ${escHtml(p.orgName || '-')}</div>
                                                <div><span class="font-semibold">ST:</span> <span class="font-mono">${escHtml(p.phone || '-')}</span></div>
                                            </div>

                                            <div class="mt-0.5 text-[11px] text-slate-500 flex flex-wrap gap-x-3 gap-y-1">
                                                <div><span class="font-semibold">CCCD:</span> <span class="font-mono">${escHtml(p.idNo || '-')}</span>${warnIcon}</div>
                                                <div><span class="font-semibold">Ht hn:</span> <span class="${p.isIdExpiring?'text-red-600 font-bold':'text-slate-500'}">${escHtml(p.idExpiryDate || '')}</span></div>
                                            </div>

                                            ${p.rowNote ? `<div class="mt-1 text-[11px] italic text-slate-500 break-words"><span class="font-semibold not-italic">Ghi ch:</span> ${escHtml(p.rowNote)}</div>` : ``}
                                            ${updatedInfo}
                                        </div>

                                        <div class="flex flex-col items-end gap-2 flex-none">
                                            ${actionBtns}
                                            <div class="text-[11px] text-slate-500 text-right">
                                                <div><span class="font-semibold">KG:</span> ${escHtml(p.weightKg||0)}</div>
                                                <div><span class="font-semibold">HL:</span> ${escHtml(p.luggageKg||0)} | <span class="font-semibold">HH:</span> ${escHtml(p.cargoKg||0)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div>`;
                    } else {
                        html += `
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-slate-100 text-xs">
                                    <thead>
                                        <tr>
                                            <th class="px-3 py-3 text-center w-10">STT</th>
                                            <th class="px-3 py-3 text-left w-20">Danh s</th>
                                            <th class="px-3 py-3 text-left w-40">H tn</th>
                                            <th class="px-3 py-3 text-left w-40">Chc danh / n v</th>
                                            <th class="px-3 py-3 text-left w-32">Ngy sinh / Ni sinh</th>
                                            <th class="px-3 py-3 text-left w-24">ST</th>
                                            <th class="px-3 py-3 text-left w-32">CCCD / Ht hn</th>
                                            <th class="px-3 py-3 text-center w-16">Cn nng</th>
                                            <th class="px-3 py-3 text-center w-16">Hnh l</th>
                                            <th class="px-3 py-3 text-center w-16">Hng ha</th>
                                            <th class="px-3 py-3 text-left w-32">Ghi ch</th>
                                            <th class="px-3 py-3 text-center sticky right-0 bg-slate-50 w-20 shadow-l-sm">Sa</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-slate-50">
                        `;

                        sortedGroup.forEach((p, idx) => {
                            const warnClass = (p.warnings&&p.warnings.length>0) ? 'bg-red-50/50' : '';
                            const warnIcon = (p.warnings&&p.warnings.length>0) ? `<i class="fas fa-exclamation-triangle text-red-500 ml-1" title="${p.warnings.join(', ')}"></i>` : '';
                            const canEdit = state.userRole === 'dispatcher' || (!state.isPlanLocked && p.orgId === state.userOrgId);
                            let updatedInfo = '';
                            if(p.updatedAt || p.createdAt) {
                                const t = p.updatedAt ? p.updatedAt.seconds*1000 : p.createdAt.seconds*1000;
                                const u = (p.updatedBy || p.importedBy || '').split('@')[0];
                                updatedInfo = `<span class="text-[9px] text-slate-400 font-mono block mt-1 leading-tight">${u} ${utils.formatTimeShort(new Date(t))}</span>`;
                            }
                            const actionBtns = canEdit ? `<div class="flex flex-col items-center justify-center"><div class="flex space-x-2 mb-1"><button onclick="editModal.open('${p.id}')" class="text-blue-500 hover:text-blue-700 transition"><i class="fas fa-pen"></i></button><button onclick="app.deletePerson('${p.id}')" class="text-red-400 hover:text-red-600 transition"><i class="fas fa-trash-alt"></i></button></div>${updatedInfo}</div>` : `<div class="flex flex-col items-center"><span class="text-slate-300"><i class="fas fa-lock"></i></span>${updatedInfo}</div>`;
                            html += `<tr data-person-id="${p.id}" data-dest="${escHtml(dest)}" ${state.userRole==='dispatcher' ? 'draggable="true"' : ''} class="js-dnd-row ${warnClass} hover:bg-blue-50/30 transition duration-75 group"><td class="px-3 py-2 text-slate-400 text-center font-mono">${idx+1}</td><td class="px-3 py-2 text-slate-600 font-mono">${p.staffNo}</td><td class="px-3 py-2 font-semibold text-slate-700">${p.fullName}</td><td class="px-3 py-2 text-slate-600"><div class="font-medium">${p.title||''}</div><div class="text-[10px] text-slate-400 uppercase mt-0.5 font-bold tracking-wide">${p.orgName||'-'}</div></td><td class="px-3 py-2 text-slate-600"><div class="font-mono text-xs">${p.dob||'-'}</div><div class="text-[10px] text-slate-400 mt-0.5">${p.pob||''}</div></td><td class="px-3 py-2 text-slate-600 font-mono">${p.phone||'-'}</td><td class="px-3 py-2 text-slate-600"><div class="font-mono text-xs">${p.idNo||'-'}</div><div class="text-[10px] ${p.isIdExpiring?'text-red-600 font-bold':'text-slate-400'} mt-0.5">${p.idExpiryDate||''}${warnIcon}</div></td><td class="px-3 py-2 text-slate-600 text-center">${p.weightKg||0}</td><td class="px-3 py-2 text-slate-600 text-center">${p.luggageKg||0}</td><td class="px-3 py-2 text-slate-600 text-center">${p.cargoKg||0}</td><td class="px-3 py-2 text-slate-500 italic text-[11px] break-words max-w-[150px]">${p.rowNote||''}</td><td class="px-3 py-2 text-center sticky right-0 bg-white group-hover:bg-blue-50/30 shadow-l-sm border-l border-slate-50">${actionBtns}</td></tr>`;
                        });

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                });
                container.innerHTML = html;
                setTimeout(() => { try { app.initAddToGroupButtons(); } catch(e){} }, 0);
                setTimeout(() => { try { app.initTaskToggles(); } catch(e){} }, 0);
                setTimeout(() => { try { app.initOrderDnd(); } catch(e){} }, 0);
            },

            initAddToGroupButtons: () => {
                try {
                    const container = document.getElementById('planContent');
                    if (!container || container._boundAddToGroup) return;
                    container.addEventListener('click', (e) => {
                        const btn = e.target && e.target.closest ? e.target.closest('.js-add-to-group') : null;
                        if (!btn) return;
                        if (btn.hasAttribute('disabled') || btn.disabled) return;
                        const dest = btn.getAttribute('data-dest') || '';
                        try { editModal.openAddToGroup(dest); } catch(err) {}
                    });
                    container._boundAddToGroup = true;
                } catch(e) {}
            },

            initTaskToggles: () => {
                try {
                    const blocks = document.querySelectorAll('.js-task-block');
                    blocks.forEach(el => {
                        const lines = parseInt(el.getAttribute('data-lines') || '0', 10);
                        const targetId = el.id;
                        const btn = el.parentElement?.querySelector('.js-task-toggle');
                        if (!btn || !targetId) return;

                        // Only enable toggle when more than 10 lines
                        if (lines > 10) {
                            el.classList.add('task-collapsed');
                            btn.classList.remove('hidden');
                            btn.textContent = 'M rng';
                            btn.onclick = () => app.toggleTask(targetId);
                        } else {
                            el.classList.remove('task-collapsed');
                            btn.classList.add('hidden');
                        }
                    });
                } catch (e) {
                    console.warn('initTaskToggles failed', e);
                }
            },

            initOrderDnd: () => {
                try {
                    // Only ADMIN can reorder (workshop khng  quyn update th t ca ton b bng)
                    if (state.userRole !== 'dispatcher') return;

                    const container = document.getElementById('planContent');
                    if (!container || container._boundOrderDnd) return;

                    let dragId = null;
                    let dragDest = null;

                    const getRow = (el) => (el && el.closest) ? el.closest('.js-dnd-row') : null;

                    container.addEventListener('dragstart', (e) => {
                        const row = getRow(e.target);
                        if (!row) return;
                        dragId = row.getAttribute('data-person-id');
                        dragDest = row.getAttribute('data-dest') || '';
                        try {
                            e.dataTransfer.effectAllowed = 'move';
                            e.dataTransfer.setData('text/plain', dragId || '');
                        } catch(_) {}
                        row.classList.add('opacity-60');
                    }, true);

                    container.addEventListener('dragend', (e) => {
                        const row = getRow(e.target);
                        if (row) row.classList.remove('opacity-60');
                        dragId = null; dragDest = null;
                        try {
                            container.querySelectorAll('.js-dnd-row').forEach(r => r.classList.remove('ring-2', 'ring-blue-300'));
                        } catch(_) {}
                    }, true);

                    container.addEventListener('dragover', (e) => {
                        const row = getRow(e.target);
                        if (!row || !dragId) return;
                        const dest = row.getAttribute('data-dest') || '';
                        if (dest !== dragDest) return;
                        e.preventDefault();
                        row.classList.add('ring-2', 'ring-blue-300');
                    }, true);

                    container.addEventListener('dragleave', (e) => {
                        const row = getRow(e.target);
                        if (!row) return;
                        row.classList.remove('ring-2', 'ring-blue-300');
                    }, true);

                    container.addEventListener('drop', async (e) => {
                        const row = getRow(e.target);
                        if (!row || !dragId) return;

                        const dest = row.getAttribute('data-dest') || '';
                        if (dest !== dragDest) return;

                        e.preventDefault();

                        const dragRow = container.querySelector('.js-dnd-row[data-person-id="' + dragId + '"]');
                        if (!dragRow || dragRow === row) return;

                        const rect = row.getBoundingClientRect();
                        const before = e.clientY < rect.top + rect.height / 2;

                        const parent = row.parentElement;
                        if (!parent) return;

                        if (before) parent.insertBefore(dragRow, row);
                        else parent.insertBefore(dragRow, row.nextSibling);

                        // Re-index rows for this destination (within the same group/table)
                        const rows = Array.from(parent.querySelectorAll('.js-dnd-row'))
                            .filter(r => (r.getAttribute('data-dest') || '') === dest);

                        const orderedIds = rows.map(r => r.getAttribute('data-person-id')).filter(Boolean);

                        await app.saveOrderIndexesForDest(dest, orderedIds);
                    }, true);

                    container._boundOrderDnd = true;
                } catch(e) {
                    console.warn('initOrderDnd failed', e);
                }
            },

            saveOrderIndexesForDest: async (dest, orderedIds) => {
                try {
                    if (state.userRole !== 'dispatcher') return;
                    if (!Array.isArray(orderedIds) || orderedIds.length === 0) return;

                    const idToOld = {};
                    (state.currentPlanPeople || []).forEach(p => {
                        idToOld[p.id] = Number.isFinite(+p.orderIndex) ? +p.orderIndex : null;
                    });

                    // UPDATED PATH: Use public/data/dailyPlans
                    const col = getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people');
                    const batch = db.batch();

                    let changed = 0;
                    orderedIds.forEach((id, idx) => {
                        const newIdx = idx + 1;
                        const oldIdx = idToOld[id];
                        if (oldIdx !== newIdx) {
                            batch.update(col.doc(id), { orderIndex: newIdx, updatedAt: new Date(), updatedBy: state.currentUser.email });
                            changed++;
                        }
                    });

                    if (changed === 0) return;
                    await batch.commit();
                    try { audit.log('REORDER', { destination: dest || '', count: changed }); } catch(_) {}
                    utils.showToast(' cp nht th t (ko th)', 'success');
                } catch(e) {
                    console.error(e);
                    utils.showToast('Li sp xp: ' + e.message, 'error');
                }
            },
            toggleTask: (targetId) => {
                const el = document.getElementById(targetId);
                if (!el) return;
                const btn = el.parentElement?.querySelector('.js-task-toggle');
                const collapsed = el.classList.contains('task-collapsed');
                if (collapsed) {
                    el.classList.remove('task-collapsed');
                    if (btn) btn.textContent = 'Thu gn';
                } else {
                    el.classList.add('task-collapsed');
                    if (btn) btn.textContent = 'M rng';
                }
            },
            editDestination: (oldName) => { 
    // Kept name for backwards-compat with existing UI button
    app.openGroupEditModal(oldName);
},

openGroupEditModal: (oldName) => {
    if (state.userRole !== 'dispatcher') return;

    const oldKey = utils.normalizeDestinationKey(oldName);
    const oldDisplay = utils.destinationDisplay(oldName);

    const targets = state.currentPlanPeople.filter(p => utils.normalizeDestinationKey(p.destination) === oldKey);
    if (targets.length === 0) return utils.showToast("Khng tm thy nhn s no", "error");

    // Prefill with the first row (thng sau import s ging nhau)
    document.getElementById('groupEditOldName').value = oldDisplay;
    document.getElementById('groupEditOldKey').value = oldKey;
    document.getElementById('groupEditDest').value = oldKey;
    document.getElementById('groupEditNvsx').value = (targets[0].nvsxNo || '');
    document.getElementById('groupEditTask').value = (targets[0].taskDesc || '');

    document.getElementById('groupEditModal').classList.remove('hidden');
    document.getElementById('groupEditModal').classList.add('flex');
},

closeGroupEditModal: () => {
    document.getElementById('groupEditModal').classList.add('hidden');
    document.getElementById('groupEditModal').classList.remove('flex');
},

saveGroupEditModal: async () => {
    const oldDisplay = document.getElementById('groupEditOldName').value || '';
    const oldKey = (document.getElementById('groupEditOldKey')?.value ?? '').toString();
    if (oldKey === undefined) return;

    const newDestInput = (document.getElementById('groupEditDest').value || '').trim();
    const newDest = newDestInput || oldKey;
    const newNvsx = (document.getElementById('groupEditNvsx').value || '').trim();
    const newTask = (document.getElementById('groupEditTask').value || '').trim();

    const targets = state.currentPlanPeople.filter(p => utils.normalizeDestinationKey(p.destination) === oldKey);
    if (targets.length === 0) return utils.showToast("Khng tm thy nhn s no", "error");

    utils.toggleLoader(true, "ang cp nht...");
    try {
        const batch = db.batch();
        // UPDATED PATH: Use public/data/dailyPlans
        const col = getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people');
        targets.forEach(p => batch.update(col.doc(p.id), {
            destination: newDest,
            nvsxNo: utils.normalizeNvsxInput(newNvsx),
            taskDesc: utils.normalizeTaskText(newTask),
            updatedBy: state.currentUser.email,
            updatedAt: new Date()
        }));
        await batch.commit();
        audit.log('GROUP_EDIT', { count: targets.length, destination: newDest, nvsxNo: newNvsx, reason: `from:${oldDisplay}` });
        utils.showToast(` cp nht gin/NVSX/cng vic cho ${targets.length} nhn s`, 'success');
        app.closeGroupEditModal();
    } catch (e) {
        utils.showToast("Li: " + e.message, "error");
    } finally {
        utils.toggleLoader(false);
    }
},
            deletePerson: async (id) => { 
                // Permission guard (safety): user ch xa nhn s ca xng mnh v khi cha kha
                if (state.userRole !== 'dispatcher') {
                    if (state.isPlanLocked) return utils.showToast("Ngy  KHA, khng th xa.", "error");
                    const row = (state.currentPlanPeople || []).find(p => p.id === id);
                    const rowOrg = row ? (row.orgId || '') : '';
                    if (rowOrg && rowOrg !== state.userOrgId) return utils.showToast("Khng th xa nhn s ca xng khc.", "error");
                }
                if(!confirm("Xc nhn xa nhn s ny?")) return;
                utils.toggleLoader(true, "ang xa...");
                try {
                    await getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people').doc(id).delete();
                    audit.log('DELETE_PERSON', { reason: 'delete_single', id });
                    utils.showToast(" xa thnh cng", "success");
                } catch(e) {
                    utils.showToast("Li: "+e.message, "error");
                } finally {
                    utils.toggleLoader(false);
                }
            },

deleteAllPeople: async () => {
                if(state.currentPlanPeople.length === 0 || !confirm("CNH BO: Xa TON B danh sch?") || !confirm("Chc chn xa?")) return;
                utils.toggleLoader(true, 'ang xa...');
                try {
                    const batch = db.batch(); 
                    // UPDATED PATH: Use public/data/dailyPlans
                    const col = getPublicColl('dailyPlans').doc(state.currentDateKey).collection('people');
                    let targets = state.currentPlanPeople; if(state.userRole !== 'dispatcher') targets = targets.filter(p => p.orgId === state.userOrgId);
                    targets.forEach(p => batch.delete(col.doc(p.id))); await batch.commit();
                    audit.log('DELETE_ALL', { count: targets.length, reason: 'delete_all_people' });
                    utils.showToast(` xa ${targets.length} nhn s`, "success");
                } catch(e) { utils.showToast("Li: " + e.message, "error"); } finally { utils.toggleLoader(false); }
            },
            updateStats: (t, o, r, w) => {
                document.getElementById('statTotal').innerText = t; document.getElementById('statOffshore').innerText = o;
                document.getElementById('statReturn').innerText = r; document.getElementById('statWarnings').innerText = w;
                document.getElementById('warningStatBox').classList.toggle('opacity-30', w === 0);
            },
            toggleLockPlan: async () => {
                if(state.userRole !== 'dispatcher') return;
                const s = state.isPlanLocked ? 'Draft' : 'Locked';
                if (s === 'Locked') {
                    const w = (state.currentPlanPeople || []).filter(p => Array.isArray(p.warnings) && p.warnings.length > 0).length;
                    if (w > 0 && !confirm(`Cn ${w} cnh bo (thiu danh s/CCCD ht hn...). Vn KHA ngy?`)) return;
                }
                // UPDATED PATH: Use public/data/dailyPlans
                await getPublicColl('dailyPlans').doc(state.currentDateKey).set({ status: s, lockedAt: new Date(), lockedBy: state.currentUser.email }, { merge: true });
                audit.log('LOCK_TOGGLE', { status: s, count: (state.currentPlanPeople || []).length });
                utils.showToast(` ${s === 'Locked' ? 'KHA' : 'M'} ngy ng k`, 'success');
                app.loadPlan(); // Manually reload status
            },
            showSettings: () => { document.getElementById('dashboardView').classList.add('hidden'); document.getElementById('settingsView').classList.remove('hidden'); app.renderOrgList(); app.loadSignatureConfig(); },
            showDashboard: () => { document.getElementById('settingsView').classList.add('hidden'); document.getElementById('dashboardView').classList.remove('hidden'); },
            renderOrgList: () => { document.getElementById('orgList').innerHTML = state.orgs.map(o => `<li class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100 text-xs"><span>${o.name}</span><button onclick="app.deleteOrg('${o.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></li>`).join(''); },
            addOrg: async () => { const n = document.getElementById('newOrgName').value.trim(); if(n) { await getPublicColl('organizations').doc(n).set({name:n, createdAt: new Date()}); document.getElementById('newOrgName').value=''; app.loadOrgs(); app.renderOrgList(); } },
            deleteOrg: async (id) => { if(confirm('Xa n v ny?')) { await getPublicColl('organizations').doc(id).delete(); app.loadOrgs(); app.renderOrgList(); } },
            loadSignatureConfig: async () => { 
                // UPDATED PATH: Use public/data/settings
                const d = await getPublicColl('settings').doc('signature').get(); 
                if(d.exists) { const v = d.data(); document.getElementById('sigApprover').value = v.approver||''; document.getElementById('sigApproverName').value = v.approverName||''; } 
            },
            saveSettings: async () => { 
                // UPDATED PATH: Use public/data/settings
                await getPublicColl('settings').doc('signature').set({ approver: document.getElementById('sigApprover').value, approverName: document.getElementById('sigApproverName').value }); 
                utils.showToast(' lu cu hnh'); 
            },
            
            generateDocx: async (peopleData, dateDisplayString) => {
                if (typeof docx === 'undefined' || typeof saveAs === 'undefined') {
                    throw new Error('Khng ti c th vin to Word (docx hoc FileSaver). Hy kim tra kt ni internet/CDN.');
                }

                let sig = { approver: 'TRNG BAN TTSX', approverName: '' };
                const sigDoc = await getPublicColl('settings').doc('signature').get();
                if(sigDoc.exists) sig = sigDoc.data();

                peopleData.sort((a, b) => (a.destination||'').localeCompare(b.destination||'') || (a.nvsxNo||'').localeCompare(b.nvsxNo||'') || (a.orgName||'').localeCompare(b.orgName||''));
                const grouped = peopleData.reduce((acc, p) => { const k = p.destination || 'KHC'; if(!acc[k]) acc[k]=[]; acc[k].push(p); return acc; }, {});

                const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, AlignmentType, BorderStyle, HeightRule } = docx;
                const today = new Date(); const dd = String(today.getDate()).padStart(2,'0'); const mm = String(today.getMonth()+1).padStart(2,'0'); const yyyy = today.getFullYear();
                const FONT = "Times New Roman"; const SZ_N = 24; const SZ_S = 22;

                const children = [
                    new Table({
                        rows: [new TableRow({ children: [
                            new TableCell({ children: [
                                new Paragraph({ children: [new TextRun({ text: "LIN DOANH VIT  NGA", bold: true, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER }),
                                new Paragraph({ children: [new TextRun({ text: "VIETSOVPETRO", bold: true, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER }),
                                new Paragraph({ children: [new TextRun({ text: "XNXL", bold: true, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER }),
                                new Paragraph({ text: "" }),
                                new Paragraph({ children: [new TextRun({ text: "S: ...../.....-CV-XL", size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER })
                            ], borders: { top: {style: BorderStyle.NONE, size: 0, color: "auto"}, bottom: {style: BorderStyle.NONE, size: 0, color: "auto"}, left: {style: BorderStyle.NONE, size: 0, color: "auto"}, right: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideVertical: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideHorizontal: {style: BorderStyle.NONE, size: 0, color: "auto"} }, width: { size: 40, type: WidthType.PERCENTAGE } }),
                            new TableCell({ children: [
                                new Paragraph({ children: [new TextRun({ text: "CNG HO X HI CH NGHA VIT NAM", bold: true, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER }),
                                new Paragraph({ children: [new TextRun({ text: "c lp  T do  Hnh phc", bold: true, underline: { type: "single" }, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER }),
                                new Paragraph({ text: "" }),
                                new Paragraph({ children: [new TextRun({ text: `TPHCM, ngy ${dd} thng ${mm} nm ${yyyy}`, size: SZ_S, italics: true, font: FONT })], alignment: AlignmentType.CENTER })
                            ], borders: { top: {style: BorderStyle.NONE, size: 0, color: "auto"}, bottom: {style: BorderStyle.NONE, size: 0, color: "auto"}, left: {style: BorderStyle.NONE, size: 0, color: "auto"}, right: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideVertical: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideHorizontal: {style: BorderStyle.NONE, size: 0, color: "auto"} }, width: { size: 60, type: WidthType.PERCENTAGE } })
                        ] })], width: { size: 100, type: WidthType.PERCENTAGE },
                        borders: { top: {style: BorderStyle.NONE, size: 0, color: "auto"}, bottom: {style: BorderStyle.NONE, size: 0, color: "auto"}, left: {style: BorderStyle.NONE, size: 0, color: "auto"}, right: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideVertical: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideHorizontal: {style: BorderStyle.NONE, size: 0, color: "auto"} }
                    }),
                    new Paragraph({ text: "" }),
                    new Paragraph({ children: [ new TextRun({ text: "Knh gi:  ", size: SZ_N, font: FONT }), new TextRun({ text: "Trng ban ban TTSX", bold: true, size: SZ_N, font: FONT }) ], alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: "" }),
                    new Paragraph({ children: [ new TextRun({ text: "N NG K I RA CNG TRNH BIN", bold: true, size: 28, font: FONT }) ], alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: "" }),
                    new Paragraph({ children: [new TextRun({ text: `n v ng k:      XNXL`, size: SZ_N, font: FONT })] }),
                    new Paragraph({ children: [new TextRun({ text: "Ngy khi hnh:  ", size: SZ_N, font: FONT }),new TextRun({ text: dateDisplayString, bold: true, size: SZ_N, font: FONT })] }),
                    new Paragraph({ children: [new TextRun({ text: `Phng tin yu cu:     Trc thng x;     Tu x`, size: SZ_N, font: FONT })] }),
                    new Paragraph({ children: [new TextRun({ text: `n CT bin : ${Object.keys(grouped).map(d => String(d ?? '').replace(/^\s*(?:GIN|Gin|gin|GIAN|gian)\s+/, '').trim()).join(', ')}`, size: SZ_N, font: FONT })] }),
                    new Paragraph({ children: [new TextRun({ text: `Nhim v c giao: `, size: SZ_N, font: FONT })] })
                ];

                Object.keys(grouped).forEach(dest => {
                    const group = grouped[dest];
                    const meta = utils.getGroupFinalMeta(group);
                    const uniqueNVSX = meta.nvsxStr;
                    const uniqueTasks = (meta.taskLines || []);
                    children.push(new Paragraph({ children: [ new TextRun({ text: "-", size: SZ_N, font: FONT }), new TextRun({ text: ` ${dest}: `, bold: true, color: "C00000", size: SZ_N, font: FONT }) ], indent: { left: 720 }, spacing: { before: 100 } }));
                    if(uniqueNVSX) children.push(new Paragraph({ children: [ new TextRun({ text: `+ NVSX: ${uniqueNVSX}`, size: SZ_N, font: FONT }) ], indent: { left: 1440 } }));
                    if(uniqueTasks.length > 0) {
uniqueTasks.forEach(line => { let l = (line || '').trim(); if (!l) return; if (/^\d+[\)\.]/.test(l)) l = l.replace(/^\d+[\)\.]\s*/, '- '); else if (!l.startsWith('-')) l = '- ' + l; children.push(new Paragraph({ children: [ new TextRun({ text: l, size: SZ_N, font: FONT }) ], indent: { left: 2160 } })); });
                    }
                });

                children.push(new Paragraph({ children: [new TextRun({ text: `Danh sch ngi i: `, size: SZ_N, font: FONT })] }), new Paragraph({ text: "" }));

                const tableRows = [new TableRow({ children: ["S TT", "H v tn", "Chc danh", "n v", "Danh s"].map(t => new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: t, bold: true, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER })], verticalAlign: "center", shading: { fill: "FFFFFF" } })), tableHeader: true })];

                
                const groupedByDestDateTbl = peopleData.reduce((acc, p) => {
                    const dest0 = (p.destination || '').trim() || 'Cha xc nh';
                    const planId0 = p.__planId || '';
                    const k = dest0 + '||' + planId0;
                    (acc[k] = acc[k] || { dest: dest0, planId: planId0, people: [] }).people.push(p);
                    return acc;
                }, {});
                const groupKeysTbl = Object.keys(groupedByDestDateTbl).sort((a,b) => {
                    const ga = groupedByDestDateTbl[a], gb = groupedByDestDateTbl[b];
                    return String(ga.planId||'').localeCompare(String(gb.planId||'')) || String(ga.dest||'').localeCompare(String(gb.dest||''));
                });

                groupKeysTbl.forEach(k => {
                    const dest = groupedByDestDateTbl[k].dest;
                    const groupPeople = groupedByDestDateTbl[k].people;
                    const groupPeopleSorted = (groupPeople || []).slice().sort((a,b) => {
                    const ai = Number.isFinite(+a.orderIndex) ? +a.orderIndex : 999999999;
                    const bi = Number.isFinite(+b.orderIndex) ? +b.orderIndex : 999999999;
                    if (ai !== bi) return ai - bi;

                    const at = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds * 1000 : (+a.createdAt || 0)) : 0;
                    const bt = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds * 1000 : (+b.createdAt || 0)) : 0;
                    if (at !== bt) return at - bt;

                    return String(a.staffNo||'').localeCompare(String(b.staffNo||''));
                });
                    const planId = groupedByDestDateTbl[k].planId;
                    const dateForHeader = utils.formatPlanIdHeader(planId, dateDisplayString);

                    let dName = dest;
                    const dLower = String(dest || '').toLowerCase();
                    if (!dLower.startsWith('gin') && !dLower.startsWith('gian')) dName = `GIN ${dest}`;

                    tableRows.push(new TableRow({ 
                        height: { value: 400, rule: HeightRule.AT_LEAST }, 
                        children: [
                            new TableCell({ width: { size: 10, type: WidthType.PERCENTAGE }, shading: { fill: "D9D9D9" }, children: [] }), // Empty cell 1
                            new TableCell({ 
                                children: [
                                    new Paragraph({ 
                                        children: [new TextRun({ text: `${dName} (${dateForHeader})`, bold: true, color: "C00000", size: SZ_S, font: FONT })],
                                        alignment: AlignmentType.LEFT 
                                    })
                                ], 
                                columnSpan: 4, 
                                shading: { fill: "D9D9D9" },
                                verticalAlign: "center"
                            })
                        ] 
                    }));

                    groupPeopleSorted.forEach((p, i) => {
                        tableRows.push(new TableRow({
                            height: { value: 400, rule: HeightRule.AT_LEAST },
                            children: [
                                new TableCell({ children: [new Paragraph({ text: (i+1).toString(), alignment: AlignmentType.CENTER, size: SZ_S, font: FONT })], verticalAlign: "center" }),
                                new TableCell({ children: [new Paragraph({ text: p.fullName || '', size: SZ_S, font: FONT })], verticalAlign: "center" }),
                                new TableCell({ children: [new Paragraph({ text: p.title || '', size: SZ_S, font: FONT, alignment: AlignmentType.CENTER })], verticalAlign: "center" }),
                                new TableCell({ children: [new Paragraph({ text: p.orgName || '', size: SZ_S, font: FONT, alignment: AlignmentType.CENTER })], verticalAlign: "center" }),
                                new TableCell({ children: [new Paragraph({ text: p.staffNo || '', alignment: AlignmentType.CENTER, size: SZ_S, font: FONT })], verticalAlign: "center" }),
                            ]
                        }));
                    });
                });


children.push(new Table({ rows: tableRows, width: { size: 100, type: WidthType.PERCENTAGE }, borders: { top: { style: BorderStyle.SINGLE, size: 1 }, bottom: { style: BorderStyle.SINGLE, size: 1 }, left: { style: BorderStyle.SINGLE, size: 1 }, right: { style: BorderStyle.SINGLE, size: 1 }, insideVertical: { style: BorderStyle.SINGLE, size: 1 }, insideHorizontal: { style: BorderStyle.SINGLE, size: 1 } } }), new Paragraph({ text: "" }), new Paragraph({ text: "" }));

                children.push(new Table({
                    rows: [new TableRow({ children: [
                        new TableCell({ children: [
                            new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ children: [new TextRun({ text: "K tt:", bold: true, italics: true, size: SZ_S, font: FONT })] }),
                            new Paragraph({ text: "" }), new Paragraph({ children: [new TextRun({ text: "- Lnh o LDVN Vietsovpetro (nu cn)", size: SZ_S, font: FONT })], indent: { left: 100 } }),
                            new Paragraph({ text: "" }), new Paragraph({ children: [new TextRun({ text: "- iu   XNKT:", size: SZ_S, font: FONT })], indent: { left: 100 } }),
                            new Paragraph({ text: "" }), new Paragraph({ children: [new TextRun({ text: "- Phng k thut :", size: SZ_S, font: FONT })], indent: { left: 100 } }),
                            new Paragraph({ text: "" }), new Paragraph({ children: [new TextRun({ text: "- iu  XNXL:                            S t: 8626", size: SZ_S, font: FONT })], indent: { left: 100 } }),
                        ], borders: { top: {style: BorderStyle.NONE, size: 0, color: "auto"}, bottom: {style: BorderStyle.NONE, size: 0, color: "auto"}, left: {style: BorderStyle.NONE, size: 0, color: "auto"}, right: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideVertical: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideHorizontal: {style: BorderStyle.NONE, size: 0, color: "auto"} }, width: { size: 50, type: WidthType.PERCENTAGE }, verticalAlign: "bottom" }),
                        new TableCell({ children: [
                            new Paragraph({ children: [new TextRun({ text: sig.approver || 'TRNG BAN TTSX', bold: true, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER }),
                            new Paragraph({ children: [new TextRun({ text: "(K, ghi r h tn)", italics: true, size: 20, font: FONT })], alignment: AlignmentType.CENTER }),
                            new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), new Paragraph({ text: "" }), 
                            new Paragraph({ children: [new TextRun({ text: sig.approverName || '', bold: true, size: SZ_S, font: FONT })], alignment: AlignmentType.CENTER })
                        ], borders: { top: {style: BorderStyle.NONE, size: 0, color: "auto"}, bottom: {style: BorderStyle.NONE, size: 0, color: "auto"}, left: {style: BorderStyle.NONE, size: 0, color: "auto"}, right: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideVertical: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideHorizontal: {style: BorderStyle.NONE, size: 0, color: "auto"} }, width: { size: 50, type: WidthType.PERCENTAGE }, verticalAlign: "top" })
                    ] })], width: { size: 100, type: WidthType.PERCENTAGE },
                    borders: { top: {style: BorderStyle.NONE, size: 0, color: "auto"}, bottom: {style: BorderStyle.NONE, size: 0, color: "auto"}, left: {style: BorderStyle.NONE, size: 0, color: "auto"}, right: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideVertical: {style: BorderStyle.NONE, size: 0, color: "auto"}, insideHorizontal: {style: BorderStyle.NONE, size: 0, color: "auto"} }
                }));

                const blob = await Packer.toBlob(new Document({ sections: [{ properties: { page: { margin: { top: 720, right: 720, bottom: 720, left: 720 } } }, children }] }));
                saveAs(blob, `KeHoachDiBien_${dateDisplayString.split('+')[0].trim().replace(/\./g,'_')}_plus.docx`);
            },
                        
generateBaydiTemplateExcel: async (peopleData, dateDisplayString) => {
    if (typeof XLSX === 'undefined') throw new Error('Khng ti c th vin Excel (XLSX).');

    const u8 = __b64ToU8(TEMPLATE_BAYDI_BASE64);
    const ab = __u8ToArrayBuffer(u8);

    const wb = XLSX.read(ab, { type: 'array', cellStyles: true });
    const sheetName = wb.SheetNames[0];
    const ws = wb.Sheets[sheetName];
    if (!ws) throw new Error('Khng tm thy sheet trong file Template BayDi.');

    const HEADER_ROW = 4;  // row 4 is header (fixed)
    const START_ROW = 7;   // row 7 is first person row

    // Fixed column indices (0-based): D,F,G,H,I,K
    const COL_D = 3, COL_F = 5, COL_G = 6, COL_H = 7, COL_I = 8, COL_K = 10;
    // Defaults required by customer
    const G_DEFAULT = '';
    const H_DEFAULT = '';
    const K_DEFAULT = 'my bay-';


    const norm = (s) => (s || '').toString().toLowerCase().replace(/\s+/g,' ').trim();

    // Build column mapping by reading row 4 headers
    const colMap = {};
    for (let c = 0; c < 80; c++) {
        const addr = XLSX.utils.encode_cell({ r: HEADER_ROW - 1, c });
        const cell = ws[addr];
        if (!cell || cell.v == null) continue;
        const h = norm(cell.v);

        const set = (key) => { if (colMap[key] == null) colMap[key] = c; };

        if (h.includes('stt')) set('stt');
        else if (h.includes('h tn') || h.includes('ho ten')) set('fullName');
        else if (h.includes('danh s') || h.includes('msnv') || h.includes('danh so')) set('staffNo');
        else if (h.includes('quc tch') || h.includes('quoc tich')) set('nationality');
        else if (h.includes('chc danh') || h.includes('chuc danh') || h.includes('ngh nghip') || h.includes('nghe nghiep')) set('title');
        else if ((h.includes('n v') || h.includes('don vi')) && (h.includes('cng ty') || h.includes('cong ty'))) set('company');
        else if ((h.includes('n v') || h.includes('don vi')) && (h.includes('ng k') || h.includes('dang ky'))) set('registerUnit');
        else if (h.includes('t ct') || h.includes('tu ct')) set('fromCt');
        else if (h.includes('n ct') || h.includes('den ct')) set('toCt');
        else if (h.includes('ngy i') || h.includes('ngay di')) set('travelDate');
        else if (h.includes('phng tin') || h.includes('phuong tien')) set('vehicle');
        else if (h.includes('hnh l') || h.includes('hanh ly')) set('luggage');
        else if (h.includes('hng ha') || h.includes('hang hoa')) set('cargo');
        else if (h.includes('cn nng') || h.includes('can nang')) set('weight');
        else if (h.includes('u tin') || h.includes('uu tien')) set('priority');
        else if (h.includes('ghi ch') || h.includes('ghi chu')) set('note');
        else if (h.includes('mobile phone') || h.includes('in thoi') || h.includes('dien thoai')) set('phone');
        else if (h.includes('cmnd') || h.includes('cccd')) set('idNo');
        else if (h.includes('ngy cp') || h.includes('ngay cap')) set('idIssueDate');
        else if (h.includes('ngy sinh') || h.includes('ngay sinh')) set('dob');
        else if (h.includes('ni sinh') || h.includes('noi sinh')) set('pob');
    }

    const groupedByDestDateBaydi = (peopleData || []).reduce((acc, p) => {
    const dest0 = (p.destination || '').trim() || 'Cha xc nh';
    const planId0 = p.__planId || '';
    const k = dest0 + '||' + planId0;
    (acc[k] = acc[k] || { dest: dest0, planId: planId0, people: [] }).people.push(p);
    return acc;
}, {});
const groupKeysBaydi = Object.keys(groupedByDestDateBaydi).sort((a, b) => {
    const ga = groupedByDestDateBaydi[a], gb = groupedByDestDateBaydi[b];
    return String(ga.planId || '').localeCompare(String(gb.planId || '')) ||
           String(ga.dest || '').localeCompare(String(gb.dest || ''));
});
const list = [];
groupKeysBaydi.forEach(k => {
    const groupPeople = groupedByDestDateBaydi[k].people || [];
    const groupPeopleSorted = groupPeople.slice().sort((a, b) => {
        const ai = Number.isFinite(+a.orderIndex) ? +a.orderIndex : 999999999;
        const bi = Number.isFinite(+b.orderIndex) ? +b.orderIndex : 999999999;
        if (ai !== bi) return ai - bi;

        const at = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds * 1000 : (+a.createdAt || 0)) : 0;
        const bt = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds * 1000 : (+b.createdAt || 0)) : 0;
        if (at !== bt) return at - bt;

        return String(a.staffNo || '').localeCompare(String(b.staffNo || ''));
    });
    list.push(...groupPeopleSorted);
});
// Clear old data region WITHOUT destroying formatting/styles (keep fonts/borders/column widths)
    const refRange = ws['!ref'] || 'A1:A1';
    const used0 = XLSX.utils.decode_range(refRange);
    const maxCol = Math.max(used0.e.c, 15); // at least A..P

    // Preserve row height/metadata from template data row (row 7)
    const baseRowMeta = (ws['!rows'] && ws['!rows'][START_ROW - 1]) ? { ...ws['!rows'][START_ROW - 1] } : null;

    // Clear existing sample data by blanking values only (do NOT replace cell objects)
    const clearToRow = Math.max(used0.e.r, (START_ROW - 1) + 300);
    for (let rr = START_ROW - 1; rr <= clearToRow; rr++) {
        for (let cc = 0; cc <= maxCol; cc++) {
            const addr = XLSX.utils.encode_cell({ r: rr, c: cc });
            const cell = ws[addr];
            if (cell) {
                cell.v = '';
                cell.t = 's';
                delete cell.w;
                if (cell.c) delete cell.c; // remove comments/notes
            }
        }
    }
    // Also remove sheet-level comments if any
    if (ws['!comments']) ws['!comments'] = [];

    // Ensure new rows (when list grows) keep the same row height/metadata as template row
    if (baseRowMeta) {
        ws['!rows'] = ws['!rows'] || [];
        const needLast = (START_ROW - 1) + Math.max(1, list.length);
        for (let rr = START_ROW - 1; rr <= needLast; rr++) {
            if (!ws['!rows'][rr]) ws['!rows'][rr] = { ...baseRowMeta };
        }
    }

    // Extend sheet range
    const used = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
    used.e.r = Math.max(used.e.r, START_ROW - 1 + Math.max(1, list.length));
    ws['!ref'] = XLSX.utils.encode_range(used);

    
    // Remove ALL comments/notes (entire sheet)
    Object.keys(ws).forEach((k) => {
        if (k && k[0] !== '!' && ws[k] && ws[k].c) delete ws[k].c;
    });
    if (ws['!comments']) ws['!comments'] = [];

    // ===== Fill data rows (write values ONLY, keep all formatting from template) =====
    const getCol = (key, fallback) => (colMap[key] != null ? colMap[key] : fallback);

    const baseRowIdx0 = START_ROW - 1;
    const ensureCell = (r0, c0) => {
        const addr = XLSX.utils.encode_cell({ r: r0, c: c0 });
        if (ws[addr]) return ws[addr];

        const baseAddr = XLSX.utils.encode_cell({ r: baseRowIdx0, c: c0 });
        const baseCell = ws[baseAddr];

        const newCell = { t: 's', v: '' };
        if (baseCell) {
            if (baseCell.s) newCell.s = baseCell.s;
            if (baseCell.z) newCell.z = baseCell.z;
        }
        ws[addr] = newCell;
        return newCell;
    };

    const setCell = (r0, c0, val) => {
        const cell = ensureCell(r0, c0);
        if (val === null || val === undefined || val === '') {
            cell.t = 's';
            cell.v = '';
        } else if (typeof val === 'number') {
            cell.t = 'n';
            cell.v = val;
        } else {
            cell.t = 's';
            cell.v = String(val);
        }
        delete cell.w; // let Excel recalc display
        if (cell.c) delete cell.c; // no comments
    };

    // Travel date string
    let travelDateStr = '';
    if (dateDisplayString) travelDateStr = String(dateDisplayString).split('+')[0].trim();
    if (!travelDateStr && state.currentDateKey && String(state.currentDateKey).length === 8) {
        const k = String(state.currentDateKey);
        travelDateStr = `${k.slice(6,8)}/${k.slice(4,6)}/${k.slice(0,4)}`;
    }

    const cSTT = getCol('stt', 0);
    const cName = getCol('fullName', 1);
    const cStaff = getCol('staffNo', 2);
    const cNat = getCol('nationality', COL_D);     // Column D
    const cTitle = getCol('title', 4);
    const cCompany = getCol('company', COL_F);     // Column F
    const cReg = getCol('registerUnit', COL_G);    // Column G
    const cFrom = getCol('fromCt', COL_H);         // Column H
    const cTo = getCol('toCt', COL_I);             // Column I (forced empty)
    const cDate = getCol('travelDate', 9);
    const cVehicle = getCol('vehicle', COL_K);     // Column K
    const cLuggage = getCol('luggage', 11);
    const cCargo = getCol('cargo', 12);
    const cWeight = getCol('weight', 13);
    const cPriority = getCol('priority', 14);
    const cNote = getCol('note', 15);
    const cPhone = getCol('phone', 16);
    const cIdNo = getCol('idNo', 17);
    const cIdIssue = getCol('idIssueDate', 18);
    const cDob = getCol('dob', 19);
    const cPob = getCol('pob', 20);

    
    // Normalize date to dd/mm/yyyy (input may be dd.mm.yyyy, dd-mm-yyyy, d/m/yy, etc.)
    const formatDMY = (val) => {
        if (val === null || val === undefined) return '';
        const s0 = String(val).trim();
        if (!s0) return '';
        // If already looks like yyyy-mm-dd or yyyy/mm/dd, convert to dd/mm/yyyy
        let m = s0.match(/^(\d{4})[.\-\/](\d{1,2})[.\-\/](\d{1,2})$/);
        if (m) {
            const yyyy = m[1];
            const mm = String(m[2]).padStart(2,'0');
            const dd = String(m[3]).padStart(2,'0');
            return `${dd}/${mm}/${yyyy}`;
        }
        // dd.mm.yyyy / dd-mm-yyyy / dd/mm/yyyy
        m = s0.match(/^(\d{1,2})[.\-\/](\d{1,2})[.\-\/](\d{2,4})$/);
        if (m) {
            let dd = String(m[1]).padStart(2,'0');
            let mm = String(m[2]).padStart(2,'0');
            let yyyy = String(m[3]);
            if (yyyy.length === 2) yyyy = (Number(yyyy) >= 70 ? '19' : '20') + yyyy;
            return `${dd}/${mm}/${yyyy}`;
        }
        // Fallback: just replace dots with slashes if it resembles a date
        return s0.replace(/\./g, '/');
    };

// Write people
    list.forEach((p, i) => {
        const r0 = (START_ROW - 1) + i;

        // STT
        setCell(r0, cSTT, i + 1);

        // Main fields
        setCell(r0, cName, p.fullName || '');
        setCell(r0, cStaff, p.staffNo || '');

        // Defaults / fixed columns required
        setCell(r0, cNat, 'Vit Nam');
        setCell(r0, cCompany, 'VSP-XayLap');
        setCell(r0, cReg, G_DEFAULT);
        setCell(r0, cFrom, H_DEFAULT);
        setCell(r0, cTo, ''); // Column I always blank
        setCell(r0, cVehicle, K_DEFAULT);

        // Title + date
        setCell(r0, cTitle, p.title || '');
        setCell(r0, cDate, formatDMY(p.travelDate || travelDateStr || ''));

        // Luggage / cargo / weight / priority / note / phone
        const nOrBlank = (x) => {
            if (x === null || x === undefined || x === '') return '';
            const num = Number(String(x).replace(',', '.'));
            return Number.isFinite(num) ? num : String(x);
        };
        setCell(r0, cLuggage, nOrBlank(p.luggageKg ?? p.luggage ?? ''));
        setCell(r0, cCargo, nOrBlank(p.cargoKg ?? p.cargo ?? ''));
        setCell(r0, cWeight, nOrBlank(p.weightKg ?? p.weight ?? ''));
        // Center align L/M/N (Hnh l/Hng ha/Cn nng)
        [cLuggage, cCargo, cWeight].forEach((cc) => {
            if (cc === null || cc === undefined) return;
            const addr = XLSX.utils.encode_cell({ r: r0, c: cc });
            const cell = ws[addr];
            if (!cell) return;
            cell.s = cell.s || {};
            cell.s.alignment = cell.s.alignment || {};
            cell.s.alignment.horizontal = 'center';
            cell.s.alignment.vertical = 'center';
        });

setCell(r0, cPriority, (p.priority ?? ''));
        setCell(r0, cNote, (p.rowNote ?? p.note ?? ''));
        setCell(r0, cPhone, (p.phone ?? ''));
        // ID / birth info (R,S,T,U)
        setCell(r0, cIdNo, (p.idNo ?? ''));
        setCell(r0, cIdIssue, formatDMY(p.idIssueDate ?? ''));
        setCell(r0, cDob, formatDMY(p.dob ?? ''));
        setCell(r0, cPob, (p.pob ?? ''));
    });


    // ===== Apply font rules (Times New Roman) =====
    const FONT_NAME = 'Times New Roman';

    const setFontAt = (r0, c0, sz, bold, createIfMissing) => {
        const addr = XLSX.utils.encode_cell({ r: r0, c: c0 });
        let cell = ws[addr];
        if (!cell) {
            if (!createIfMissing) return;
            cell = ensureCell(r0, c0);
        }
        cell.s = cell.s || {};
        cell.s.font = cell.s.font || {};
        cell.s.font.name = FONT_NAME;
        if (sz !== undefined && sz !== null) cell.s.font.sz = sz;
        if (bold !== undefined && bold !== null) cell.s.font.bold = bold;
    };

    const setAlignAt = (r0, c0, horiz, vert, wrap, createIfMissing) => {
        const addr = XLSX.utils.encode_cell({ r: r0, c: c0 });
        let cell = ws[addr];
        if (!cell) {
            if (!createIfMissing) return;
            cell = ensureCell(r0, c0);
        }
        cell.s = cell.s || {};
        cell.s.alignment = cell.s.alignment || {};
        if (horiz) cell.s.alignment.horizontal = horiz;
        if (vert) cell.s.alignment.vertical = vert;
        if (wrap !== undefined && wrap !== null) cell.s.alignment.wrapText = wrap;
    };



    // Force font name Times New Roman for all existing cells (preserve other formatting)
    Object.keys(ws).forEach((addr) => {
        if (!addr || addr[0] === '!') return;
        const cell = ws[addr] || ensureCell(r0, c0);
        cell.s = cell.s || {};
        cell.s.font = cell.s.font || {};
        cell.s.font.name = FONT_NAME;
    });

    // Title at B2
    const TITLE_ADDR = 'B2';
    ws[TITLE_ADDR] = ws[TITLE_ADDR] || { t: 's', v: '' };
    ws[TITLE_ADDR].t = 's';
    ws[TITLE_ADDR].v = "Danh sch ng k i t b -      ";
    ws[TITLE_ADDR].s = ws[TITLE_ADDR].s || {};
    ws[TITLE_ADDR].s.font = ws[TITLE_ADDR].s.font || {};
    ws[TITLE_ADDR].s.font.name = FONT_NAME;
    ws[TITLE_ADDR].s.font.sz = 22;
    ws[TITLE_ADDR].s.font.bold = true;

    // Header rows 4 & 5: bold, size 11 + Wrap Text + Center + Middle Align
    const usedRange2 = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
    const applyHeaderStyle = (r0, c0) => {
        const addr = XLSX.utils.encode_cell({ r: r0, c: c0 });
        const cell = ws[addr] || ensureCell(r0, c0);
        cell.s = cell.s || {};
        cell.s.font = cell.s.font || {};
        cell.s.font.name = FONT_NAME;
        cell.s.font.sz = 11;
        cell.s.font.bold = true;
        cell.s.alignment = cell.s.alignment || {};
        cell.s.alignment.wrapText = true;
        cell.s.alignment.horizontal = 'center';
        cell.s.alignment.vertical = 'center';
    };
    for (let c = usedRange2.s.c; c <= usedRange2.e.c; c++) {
        applyHeaderStyle(HEADER_ROW - 1, c); // row 4 (0-based)
        applyHeaderStyle(HEADER_ROW, c);     // row 5 (0-based)
    }

// Detail rows (from row 7): size 10
    const lastRow0 = (START_ROW - 1) + Math.max(1, list.length) - 1;
    for (let r = START_ROW - 1; r <= lastRow0; r++) {
        for (let c = usedRange2.s.c; c <= usedRange2.e.c; c++) {
            setFontAt(r, c, 10, false, true);
        }
    }




    // Detail rows (from row 7): Center + Middle Align for all columns
    for (let r = START_ROW - 1; r <= lastRow0; r++) {
        for (let c = usedRange2.s.c; c <= usedRange2.e.c; c++) {
            setAlignAt(r, c, 'center', 'center', false, true);
        }
    }

// Export as Excel 97-2003 Workbook (.xls / BIFF8) for parent-company system compatibility
    const out = XLSX.write(wb, { bookType: 'xls', type: 'array', cellStyles: true });
    const blob = new Blob([out], { type: 'application/vnd.ms-excel' });
    const fileKey = state.currentDateKey || 'BayDi';
    const filename = `Template_BayDi_${fileKey}.xls`;

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
},

generatePdf: async (peopleData, dateDisplayString) => {
                const canAutoPdf = (typeof html2pdf !== 'undefined');
                // If html2pdf isn't available (offline/CDN blocked), we will fallback to print-to-PDF.

                let sig = { approver: 'TRNG BAN TTSX', approverName: '' };
                try {
                    const sigDoc = await getPublicColl('settings').doc('signature').get();
                    if (sigDoc.exists) sig = sigDoc.data();
                } catch(e) { /* ignore */ }

                const esc = (s) => String(s ?? '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
                const today = new Date();
                const dd = String(today.getDate()).padStart(2,'0');
                const mm = String(today.getMonth()+1).padStart(2,'0');
                const yyyy = today.getFullYear();

                const people = [...peopleData];
                people.sort((a, b) => (a.destination||'').localeCompare(b.destination||'') || (a.nvsxNo||'').localeCompare(b.nvsxNo||'') || (a.orgName||'').localeCompare(b.orgName||''));
                const grouped = people.reduce((acc, p) => { const k = p.destination || 'KHC'; (acc[k] = acc[k] || []).push(p); return acc; }, {});

                const destKeys = Object.keys(grouped);
                const _stripGian = (s) => String(s ?? '').replace(/^\s*(?:GIN|Gin|gin|GIAN|gian)\s+/,'').trim();
                const destList = destKeys.map(_stripGian).join(', ');
// Build nhim v section
                let tasksHtml = '';
                destKeys.forEach(dest => {
                    const group = grouped[dest];
                    const meta = utils.getGroupFinalMeta(group);
                    const nvsx = meta.nvsxStr;
                    const lines = meta.taskLines || [];
                    tasksHtml += `
                        <div style="margin-left: 10mm; margin-top: 2mm;">
                            <div><span>- </span><span style="font-weight:bold; color:#C00000;">${esc(dest)}</span><span>:</span></div>
                            ${nvsx ? `<div style="margin-left: 6mm;">+ NVSX: ${esc(nvsx)}</div>` : ``}
${lines.map(l => {
                                let x = (l||'').trim();
                                if (!x) return '';
                                if (/^\d+[\)\.]/.test(x)) x = x.replace(/^\d+[\)\.]\s*/, '- ');
                                else if (!x.startsWith('-')) x = '- ' + x;
                                return `<div style="margin-left: 12mm;">${esc(x)}</div>`;
                            }).join('')}
                        </div>
                    `;
                });

                // Build people table
                let tableRows = `
                    <thead>
                        <tr>
                            <th style="border:1px solid #000; padding:3mm; width:10mm; text-align:center;">S TT</th>
                            <th style="border:1px solid #000; padding:3mm; text-align:center;">H v tn</th>
                            <th style="border:1px solid #000; padding:3mm; text-align:center;">Chc danh</th>
                            <th style="border:1px solid #000; padding:3mm; text-align:center;">n v</th>
                            <th style="border:1px solid #000; padding:3mm; width:22mm; text-align:center;">Danh s</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                const groupedByDestDateTbl = people.reduce((acc, p) => {
                    const dest0 = (p.destination || '').trim() || 'Cha xc nh';
                    const planId0 = p.__planId || '';
                    const k = dest0 + '||' + planId0;
                    (acc[k] = acc[k] || { dest: dest0, planId: planId0, people: [] }).people.push(p);
                    return acc;
                }, {});
                const groupKeysTbl = Object.keys(groupedByDestDateTbl).sort((a,b) => {
                    const ga = groupedByDestDateTbl[a], gb = groupedByDestDateTbl[b];
                    return String(ga.planId||'').localeCompare(String(gb.planId||'')) || String(ga.dest||'').localeCompare(String(gb.dest||''));
                });

                groupKeysTbl.forEach(k => {
                    const dest = groupedByDestDateTbl[k].dest;
                    const groupPeople = groupedByDestDateTbl[k].people;
                    const groupPeopleSorted = (groupPeople || []).slice().sort((a,b) => {
                    const ai = Number.isFinite(+a.orderIndex) ? +a.orderIndex : 999999999;
                    const bi = Number.isFinite(+b.orderIndex) ? +b.orderIndex : 999999999;
                    if (ai !== bi) return ai - bi;

                    const at = a.createdAt ? (a.createdAt.seconds ? a.createdAt.seconds * 1000 : (+a.createdAt || 0)) : 0;
                    const bt = b.createdAt ? (b.createdAt.seconds ? b.createdAt.seconds * 1000 : (+b.createdAt || 0)) : 0;
                    if (at !== bt) return at - bt;

                    return String(a.staffNo||'').localeCompare(String(b.staffNo||''));
                });
                    const planId = groupedByDestDateTbl[k].planId;
                    const dateForHeader = utils.formatPlanIdHeader(planId, dateDisplayString);
                    let dName = dest;
                    const dLower = String(dest || '').toLowerCase();
                    if (!dLower.startsWith('gin') && !dLower.startsWith('gian')) dName = `GIN ${dest}`;
                    tableRows += `
                        <tr>
                            <td style="border:1px solid #000; padding:3mm; background:#D9D9D9;"></td>
                            <td style="border:1px solid #000; padding:3mm; background:#D9D9D9; font-weight:bold; color:#C00000;" colspan="4">${esc(dName)} (${esc(dateForHeader)})</td>
                        </tr>
                    `;
                    groupPeopleSorted.forEach((p, i) => {
                        tableRows += `
                            <tr>
                                <td style="border:1px solid #000; padding:2.5mm; text-align:center;">${i+1}</td>
                                <td style="border:1px solid #000; padding:2.5mm;">${esc(p.fullName||'')}</td>
                                <td style="border:1px solid #000; padding:2.5mm; text-align:center;">${esc(p.title||'')}</td>
                                <td style="border:1px solid #000; padding:2.5mm; text-align:center;">${esc(p.orgName||'')}</td>
                                <td style="border:1px solid #000; padding:2.5mm; text-align:center;">${esc(p.staffNo||'')}</td>
                            </tr>
                        `;
                    });
                });

                tableRows += `
                    </tbody>
                `;

                const root = document.getElementById('pdfExportRoot') || (() => {
                    const d = document.createElement('div'); d.id = 'pdfExportRoot'; d.className = 'hidden'; document.body.appendChild(d); return d;
                })();

                root.classList.remove('hidden');
                root.innerHTML = `
                    <div id="pdfDoc" style="font-family: 'Times New Roman', Times, serif; font-size: 12pt; color: #000; line-height: 1.25;">
                        <style>
                            @page { size: A4; margin: 12.7mm; }
                            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                            table { page-break-inside: auto; }
                            thead { display: table-header-group; }
                            tfoot { display: table-footer-group; }
                            tr, td, th { page-break-inside: avoid; break-inside: avoid; page-break-after: auto; }
                            .avoid-break { page-break-inside: avoid !important; break-inside: avoid !important; }
                        </style>

                        <table style="width:100%; border-collapse:collapse; margin-bottom:6mm;">
                            <tr>
                                <td style="width:40%; vertical-align:top; text-align:center;">
                                    <div style="font-weight:bold;">LIN DOANH VIT  NGA</div>
                                    <div style="font-weight:bold;">VIETSOVPETRO</div>
                                    <div style="font-weight:bold;">XNXL</div>
                                    <div style="height:6mm;"></div>
                                    <div>S: ...../.....-CV-XL</div>
                                </td>
                                <td style="width:60%; vertical-align:top; text-align:center;">
                                    <div style="font-weight:bold;">CNG HO X HI CH NGHA VIT NAM</div>
                                    <div style="font-weight:bold; text-decoration: underline;">c lp  T do  Hnh phc</div>
                                    <div style="height:6mm;"></div>
                                    <div style="font-style:italic;">TPHCM, ngy ${dd} thng ${mm} nm ${yyyy}</div>
                                </td>
                            </tr>
                        </table>

                        <div style="text-align:center; margin-bottom:4mm;">
                            <span>Knh gi: </span><span style="font-weight:bold;">Trng ban ban TTSX</span>
                        </div>

                        <div style="text-align:center; font-weight:bold; font-size:14pt; margin: 4mm 0 6mm 0;">N NG K I RA CNG TRNH BIN</div>

                        <div>n v ng k:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XNXL</div>
                        <div>Ngy khi hnh:&nbsp;&nbsp;<span style="font-weight:bold;">${esc(dateDisplayString)}</span></div>
                        <div>Phng tin yu cu:&nbsp;&nbsp;&nbsp;&nbsp;Trc thng x;&nbsp;&nbsp;&nbsp;&nbsp;Tu x</div>
                        <div>n CT bin : ${esc(destList)}</div>
                        <div style="margin-top:2mm;">Nhim v c giao:</div>

                        ${tasksHtml}

                        <div style="margin-top:4mm;">Danh sch ngi i:</div>
                        <div style="height:2mm;"></div>

                        <table style="width:100%; border-collapse:collapse;">
                            ${tableRows}
                        </table>

                        <div style="height:8mm;"></div>

                        <div class="avoid-break">
                        <table style="width:100%; border-collapse:collapse;">
                            <tr>
                                <td style="width:50%; vertical-align:top;">
                                    <div style="height:46mm;"></div>
                                    <div style="font-style:italic; font-weight:bold;">K tt:</div>
                                    <div style="height:2mm;"></div>
                                    <div style="margin-left:3mm;">- Lnh o LDVN Vietsovpetro (nu cn)</div>
                                    <div style="height:2mm;"></div>
                                    <div style="margin-left:3mm;">- iu   XNKT:</div>
                                    <div style="height:2mm;"></div>
                                    <div style="margin-left:3mm;">- Phng k thut :</div>
                                    <div style="height:2mm;"></div>
                                    <div style="margin-left:3mm;">- iu  XNXL:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S t: 8626</div>
                                </td>
                                <td style="width:50%; vertical-align:top; text-align:center;">
                                    <div style="font-weight:bold;">${esc(sig.approver || 'TRNG BAN TTSX')}</div>
                                    <div style="font-style:italic; font-size:10pt;">(K, ghi r h tn)</div>
                                    <div style="height:28mm;"></div>
                                    <div style="font-weight:bold;">${esc(sig.approverName || '')}</div>
                                </td>
                            </tr>
                        </table>
                        </div>
                    </div>
                `;

                const filename = `KeHoachDiBien_${dateDisplayString.split('+')[0].trim().replace(/\./g,'_')}_plus.pdf`;

                try {
                    if (canAutoPdf) {
                        const opt = {
                            margin: 12.7,
                            filename,
                            image: { type: 'jpeg', quality: 1.0 },
                            html2canvas: { scale: 4, useCORS: true, letterRendering: true, backgroundColor: '#ffffff' },
                            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: false },
                            pagebreak: { mode: ['css','legacy'], avoid: ['tr', '.avoid-break'] }
                        };
                        await html2pdf().set(opt).from(root.querySelector('#pdfDoc')).save();
                    } else {
                        // Fallback: open a print window so user can Save as PDF.
                        const w = window.open('', '_blank');
                        if (!w) throw new Error('Khng m c ca s in PDF (popup b chn).');
                        const html = `<!doctype html><html><head><meta charset='utf-8'><title>${filename}</title></head><body>${root.querySelector('#pdfDoc').outerHTML}</body></html>`;
                        w.document.open();
                        w.document.write(html);
                        w.document.close();
                        setTimeout(() => { try { w.focus(); w.print(); } catch(e) {} }, 300);
                        utils.showToast('Khng c th vin PDF t ng.  m ca s in  chn "Save as PDF"  lu.', 'info');
                    }
                } finally {
                    root.innerHTML = '';
                    root.classList.add('hidden');
                }
            }
        };

        app.init()
// === Custom calendar picker with status coloring (no data / draft / locked) ===
        const calendarPicker = (() => {
            let pop = null;
            let outsideHandler = null;
            const cache = {}; // yyyymm -> { fetchedAt:number, map: { [dateKey]: 'draft'|'locked' } }

            function pad2(n) { return String(n).padStart(2,'0'); }
            function yyyymm(year, monthIdx) { return `${year}${pad2(monthIdx+1)}`; }
            function formatISO(year, monthIdx, day) { return `${year}-${pad2(monthIdx+1)}-${pad2(day)}`; }

            async function fetchMonthStatus(year, monthIdx) {
                // Definition:
                // - "C d liu" = ngy  c T NHT 1 nhn s trong subcollection /dailyPlans/{YYYYMMDD}/people
                // - Nu c d liu: t theo trng thi dailyPlans.status (Locked = locked, cn li = draft)
                // - Nu cha c d liu: khng t (none)
                const key = yyyymm(year, monthIdx);
                const now = Date.now();
                if (cache[key] && (now - cache[key].fetchedAt) < 30000) return cache[key].map;

                const startKey = `${key}01`;
                const endKey = `${key}31`;

                const map = {};
                const planStatus = {}; // dateKey -> 'locked'|'draft'
                try {
                    // 1) Fetch status ca dailyPlans trong thng (nhanh, 1 query)
                    const fp = firebase.firestore.FieldPath.documentId();
                    const snap = await getPublicColl('dailyPlans')
                        .orderBy(fp)
                        .startAt(startKey)
                        .endAt(endKey)
                        .get();
                    snap.forEach(d => {
                        const st = (d.data() || {}).status;
                        planStatus[d.id] = (st === 'Locked') ? 'locked' : 'draft';
                    });

                    // 2) Kim tra c t nht 1 nhn s /people hay khng (limit(1))
                    const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();
                    const dateKeys = [];
                    for (let d=1; d<=daysInMonth; d++) {
                        dateKeys.push(`${key}${pad2(d)}`);
                    }

                    // Chunk  trnh bn qu nhiu request ng thi
                    const chunkSize = 10;
                    for (let i=0; i<dateKeys.length; i+=chunkSize) {
                        const chunk = dateKeys.slice(i, i + chunkSize);
                        const results = await Promise.all(chunk.map(async (dateKey) => {
                            try {
                                const ps = await getPublicColl('dailyPlans')
                                    .doc(dateKey)
                                    .collection('people')
                                    .limit(1)
                                    .get();
                                return { dateKey, hasPeople: !ps.empty };
                            } catch (e) {
                                // nu ngy no  b li th coi nh khng c d liu
                                return { dateKey, hasPeople: false };
                            }
                        }));

                        results.forEach(r => {
                            if (r.hasPeople) {
                                map[r.dateKey] = planStatus[r.dateKey] || 'draft';
                            }
                        });
                    }

                } catch(e) {
                    // If query fails (rules/index), just fallback to no coloring
                    console.warn('calendarPicker.fetchMonthStatus failed', e);
                }
                cache[key] = { fetchedAt: now, map };
                return map;
            }

            function ensurePop() {
                if (pop) return pop;
                pop = document.createElement('div');
                pop.id = 'planCalendarPopover';
                pop.className = 'fixed z-[9999] hidden';
                pop.innerHTML = `
                  <div class="w-[320px] rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 overflow-hidden">
                    <div class="p-3 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                      <div class="flex items-center gap-2">
                        <button type="button" id="calPrevBtn" class="h-9 w-9 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center justify-center">
                          <i class="fa-solid fa-chevron-left text-slate-600 dark:text-slate-200"></i>
                        </button>
                        <div class="text-sm font-extrabold text-slate-800 dark:text-slate-100" id="calTitle">--</div>
                        <button type="button" id="calNextBtn" class="h-9 w-9 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center justify-center">
                          <i class="fa-solid fa-chevron-right text-slate-600 dark:text-slate-200"></i>
                        </button>
                      </div>
                      <button type="button" id="calCloseBtn" class="h-9 w-9 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 flex items-center justify-center" title="ng">
                        <i class="fa-solid fa-xmark text-slate-600 dark:text-slate-200"></i>
                      </button>
                    </div>

                    <div class="px-3 py-2 flex flex-wrap gap-2 text-[11px] font-bold">
                      <div class="flex items-center gap-1">
                        <span class="inline-block h-3 w-3 rounded bg-slate-200 dark:bg-slate-700"></span>
                        <span class="text-slate-600 dark:text-slate-300">Cha c d liu</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <span class="inline-block h-3 w-3 rounded bg-amber-200 dark:bg-amber-900/40"></span>
                        <span class="text-slate-600 dark:text-slate-300">C d liu - Cha cht</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <span class="inline-block h-3 w-3 rounded bg-emerald-200 dark:bg-emerald-900/40"></span>
                        <span class="text-slate-600 dark:text-slate-300">C d liu -  cht</span>
                      </div>
                    </div>

                    <div class="px-3 pb-3">
                      <div class="grid grid-cols-7 gap-1 text-[11px] font-black text-slate-500 dark:text-slate-400 mb-1">
                        <div class="text-center">CN</div><div class="text-center">T2</div><div class="text-center">T3</div><div class="text-center">T4</div><div class="text-center">T5</div><div class="text-center">T6</div><div class="text-center">T7</div>
                      </div>
                      <div class="grid grid-cols-7 gap-1" id="calGrid"></div>
                    </div>
                  </div>
                `;
                document.body.appendChild(pop);

                // prevent click-through close
                pop.addEventListener('click', (e) => e.stopPropagation());

                return pop;
            }

            function positionPop(anchor) {
                const r = anchor.getBoundingClientRect();
                const width = 320;
                const margin = 8;
                let left = Math.round(r.left);
                let top = Math.round(r.bottom + margin);

                // keep inside viewport
                if (left + width > window.innerWidth - margin) left = window.innerWidth - width - margin;
                if (left < margin) left = margin;

                // if overflow bottom, open above
                const estHeight = 420;
                if (top + estHeight > window.innerHeight - margin) {
                    top = Math.max(margin, Math.round(r.top - estHeight - margin));
                }

                pop.style.left = `${left}px`;
                pop.style.top = `${top}px`;
            }

            function monthTitle(year, monthIdx) {
                const names = ['Thng 1','Thng 2','Thng 3','Thng 4','Thng 5','Thng 6','Thng 7','Thng 8','Thng 9','Thng 10','Thng 11','Thng 12'];
                return `${names[monthIdx]} / ${year}`;
            }

            function statusClasses(st) {
                if (st === 'locked') return 'bg-emerald-200 dark:bg-emerald-900/40 text-emerald-900 dark:text-emerald-100 hover:opacity-90';
                if (st === 'draft') return 'bg-amber-200 dark:bg-amber-900/40 text-amber-900 dark:text-amber-100 hover:opacity-90';
                return 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700';
            }

            function render(year, monthIdx, statusMap) {
                const titleEl = pop.querySelector('#calTitle');
                const grid = pop.querySelector('#calGrid');
                if (titleEl) titleEl.textContent = monthTitle(year, monthIdx);
                if (!grid) return;

                grid.innerHTML = '';

                const first = new Date(year, monthIdx, 1);
                const firstDow = first.getDay(); // 0=Sun
                const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();

                const curKey = state.currentDateKey;

                // leading blanks
                for (let i=0; i<firstDow; i++) {
                    const blank = document.createElement('div');
                    blank.className = 'h-9';
                    grid.appendChild(blank);
                }

                for (let d=1; d<=daysInMonth; d++) {
                    const dateKey = `${yyyymm(year, monthIdx)}${pad2(d)}`;
                    const st = statusMap[dateKey] || 'none';

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = `h-9 rounded-lg text-sm font-extrabold border border-transparent ${statusClasses(st)} focus:outline-none focus:ring-2 focus:ring-blue-500`;
                    btn.textContent = String(d);

                    if (curKey === dateKey) {
                        btn.classList.add('ring-2','ring-blue-500');
                    }

                    btn.addEventListener('click', () => {
                        const input = document.getElementById('planDateInput');
                        if (!input) return;
                        input.value = formatISO(year, monthIdx, d);
                        app.changeDate();
                        close();
                    });

                    grid.appendChild(btn);
                }
            }

            async function open() {
                const input = document.getElementById('planDateInput');
                if (!input) return;
                ensurePop();
                positionPop(input);

                // determine month/year from current input value
                let y, m;
                const v = (input.value || '').trim();
                const mm = /^(\d{4})-(\d{2})-(\d{2})$/.exec(v);
                if (mm) {
                    y = parseInt(mm[1], 10);
                    m = parseInt(mm[2], 10) - 1;
                } else {
                    const now = new Date();
                    y = now.getFullYear();
                    m = now.getMonth();
                }

                pop.dataset.year = String(y);
                pop.dataset.month = String(m);

                const statusMap = await fetchMonthStatus(y, m);
                render(y, m, statusMap);

                // bind nav
                const prev = pop.querySelector('#calPrevBtn');
                const next = pop.querySelector('#calNextBtn');
                const closeBtn = pop.querySelector('#calCloseBtn');

                if (prev) prev.onclick = async () => {
                    let year = parseInt(pop.dataset.year, 10);
                    let month = parseInt(pop.dataset.month, 10);
                    month -= 1;
                    if (month < 0) { month = 11; year -= 1; }
                    pop.dataset.year = String(year);
                    pop.dataset.month = String(month);
                    const sm = await fetchMonthStatus(year, month);
                    render(year, month, sm);
                };
                if (next) next.onclick = async () => {
                    let year = parseInt(pop.dataset.year, 10);
                    let month = parseInt(pop.dataset.month, 10);
                    month += 1;
                    if (month > 11) { month = 0; year += 1; }
                    pop.dataset.year = String(year);
                    pop.dataset.month = String(month);
                    const sm = await fetchMonthStatus(year, month);
                    render(year, month, sm);
                };
                if (closeBtn) closeBtn.onclick = () => close();

                // show
                pop.classList.remove('hidden');

                // outside click close
                if (outsideHandler) document.removeEventListener('click', outsideHandler, true);
                outsideHandler = (e) => {
                    if (!pop) return;
                    const t = e.target;

                    // click inside the calendar popover -> keep open
                    if (pop.contains(t)) return;

                    // click back on the input -> keep open (avoid flicker)
                    const input = document.getElementById('planDateInput');
                    if (input && input.contains(t)) return;

                    close();
                };
                setTimeout(() => document.addEventListener('click', outsideHandler, true), 0);

                // ESC close
                window.addEventListener('keydown', escClose, { once: true });
            }

            function escClose(e) {
                if (e.key === 'Escape') close();
                else window.addEventListener('keydown', escClose, { once: true });
            }

            function close() {
                if (!pop) return;
                pop.classList.add('hidden');
                if (outsideHandler) {
                    document.removeEventListener('click', outsideHandler, true);
                    outsideHandler = null;
                }
            }

            function init() {
                const input = document.getElementById('planDateInput');
                if (!input) return;

                // Avoid native date picker so we can color days
                try {
                    input.type = 'text';
                    input.readOnly = true;
                    input.classList.add('cursor-pointer');
                    input.setAttribute('title', 'Bm  chn ngy');
                    input.addEventListener('click', (e) => { e.preventDefault(); open(); });
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); open(); }
                    });
                } catch(e) {}
            }

            return { init, open, close, fetchMonthStatus };
        })();

;

// --- Expose handlers for inline onclick (safety) ---
try { window.app = app; } catch(e) { /* ignore */ }
try { window.auditModal = auditModal; } catch(e) { /* ignore */ }
try { window.editModal = editModal; } catch(e) { /* ignore */ }
try { window.importModal = importModal; } catch(e) { /* ignore */ }
try { window.exportManager = exportManager; } catch(e) { /* ignore */ }
try { window.reportManager = reportManager; } catch(e) { /* ignore */ }
try { window.calendarPicker = calendarPicker; } catch(e) { /* ignore */ }
try { window.userModal = userModal; } catch(e) { /* ignore */ }
try { window.warningCenter = warningCenter; } catch(e) { /* ignore */ }
try { window.masterDataManager = masterDataManager; } catch(e) { /* ignore */ }
try { window.userManager = userManager; } catch(e) { /* ignore */ }
